<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçë Mission Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: { 50: '#FEFDFB', 100: '#FBF8F3', 200: '#F5F0E8', 300: '#EDE5D8' },
            peach: { 100: '#FEF3E7', 400: '#F5A962', 500: '#F09440', 600: '#E67E22' },
            olive: { 100: '#F0F4E8', 400: '#8B9A6D', 500: '#6B8E4E' }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          fontSize: {
            'display': ['24px', { lineHeight: '32px', fontWeight: '600' }],
            'heading': ['18px', { lineHeight: '24px', fontWeight: '600' }],
            'body': ['14px', { lineHeight: '20px', fontWeight: '400' }],
            'caption': ['12px', { lineHeight: '16px', fontWeight: '400' }],
            'micro': ['10px', { lineHeight: '14px', fontWeight: '500' }]
          },
          spacing: {
            'xs': '8px',
            'sm': '16px',
            'md': '24px',
            'lg': '32px',
            'xl': '48px'
          }
        }
      }
    }
  </script>
  <style>
    /* Base */
    body { font-family: 'Inter', sans-serif; }
    * { transition-timing-function: ease-out; }
    
    /* Design Tokens */
    :root {
      --transition-default: 250ms ease-out;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --color-status-active: #22C55E;
      --color-status-processing: #F59E0B;
      --color-status-offline: #9CA3AF;
    }
    
    /* Status Indicators */
    .status-dot { 
      width: 8px; 
      height: 8px; 
      border-radius: 50%; 
      display: inline-block;
      flex-shrink: 0;
    }
    .status-active { background: var(--color-status-active); }
    .status-idle { background: var(--color-status-processing); }
    .status-offline { background: var(--color-status-offline); }
    
    /* Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }
    
    /* Cards */
    .agent-card { 
      transition: var(--transition-default); 
      cursor: pointer;
      border-radius: var(--radius-md);
    }
    .agent-card:hover { 
      border-color: #D1C7B7; 
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    
    .task-card { 
      transition: var(--transition-default); 
      cursor: grab;
      border-radius: var(--radius-sm);
    }
    .task-card:hover { 
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-color: #D1C7B7;
    }
    
    /* Badges - unified style */
    .badge { 
      font-size: 10px; 
      padding: 2px 8px; 
      border-radius: 4px; 
      font-weight: 500;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .badge-LEAD { background: #FEF3C7; color: #92400E; }
    .badge-INT { background: #DBEAFE; color: #1E40AF; }
    .badge-SPC { background: #FCE7F3; color: #9D174D; }
    .badge-DEPT { background: #F3F4F6; color: #4B5563; }
    .badge-CEO { background: #FEF3C7; color: #92400E; }
    
    /* Interactive Elements */
    .agent-item { 
      transition: var(--transition-default);
      border-radius: var(--radius-sm);
    }
    .agent-item:hover { background: #F5F0E8; }
    .agent-item.selected { background: #EDE5D8; border-left: 3px solid #F09440; }
    
    .feed-item { 
      border-left: 2px solid transparent;
      transition: var(--transition-default);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    }
    .feed-item:hover { 
      border-left-color: #F09440; 
      background: #FEFDFB;
    }
    
    /* Pills */
    .pill { 
      font-size: 11px; 
      padding: 4px 10px; 
      border-radius: 9999px; 
      cursor: pointer;
      transition: var(--transition-default);
      font-weight: 500;
    }
    .pill:hover { opacity: 0.8; }
    .pill.active { background: #F09440; color: white; }
    
    /* Utility */
    .view-hidden { display: none !important; visibility: hidden !important; }
    .column-drop.drag-over { background: #F5F0E8; }
    
    /* Section Headers */
    .section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #6B7280;
    }
    
    /* Focus States - Phase 3 */
    input:focus, button:focus, select:focus, textarea:focus { 
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 2px #FBF8F3, 0 0 0 4px #F5A962;
    }
    button:focus-visible {
      box-shadow: 0 0 0 2px #FBF8F3, 0 0 0 4px #F5A962;
    }
    
    /* Skeleton Loading - Phase 3 */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, #F5F0E8 25%, #FEFDFB 50%, #F5F0E8 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite ease-in-out;
      border-radius: var(--radius-sm);
    }
    .skeleton-card {
      height: 140px;
      border-radius: var(--radius-md);
    }
    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
      width: 80%;
    }
    .skeleton-text-sm {
      height: 10px;
      width: 60%;
    }
    
    /* Empty State - Phase 3 */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
      color: #9CA3AF;
      text-align: center;
    }
    .empty-state-icon {
      font-size: 24px;
      opacity: 0.4;
      margin-bottom: 8px;
    }
    .empty-state-text {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Button States - Phase 3 */
    button {
      transition: var(--transition-default);
    }
    button:active:not(:disabled) {
      transform: scale(0.98);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Card Hover Enhancement - Phase 3 */
    .agent-card {
      position: relative;
      overflow: hidden;
    }
    .agent-card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      opacity: 0;
      transition: var(--transition-default);
      pointer-events: none;
      box-shadow: inset 0 0 0 1px rgba(240, 148, 64, 0.3);
    }
    .agent-card:hover::after {
      opacity: 1;
    }
    
    /* Task Card Drag State */
    .task-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    /* Scrollbar - Firefox Support (Phase 3) */
    * {
      scrollbar-width: thin;
      scrollbar-color: #D1D5DB transparent;
    }
    
    /* Status Dot Pulse Animation */
    .status-active {
      animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0); }
    }
    
    /* Smooth Page Transitions */
    .view-transition {
      animation: fadeIn 200ms ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Loading Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #EDE5D8;
      border-top-color: #F09440;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      background: #1F2937;
      color: white;
      border-radius: var(--radius-sm);
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideUp 300ms ease-out;
      z-index: 100;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #CBD5E1;
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    input:checked + .toggle-slider {
      background-color: #22C55E;
    }
    input:checked + .toggle-slider-amber {
      background-color: #F59E0B;
    }
    input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .toggle-slider:hover {
      background-color: #94A3B8;
    }
    input:checked + .toggle-slider:hover {
      background-color: #16A34A;
    }
    input:checked + .toggle-slider-amber:hover {
      background-color: #D97706;
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
    }
    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 8px;
      background: #1F2937;
      color: white;
      font-size: 11px;
      border-radius: 4px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: var(--transition-default);
      margin-bottom: 4px;
    }
    [data-tooltip]:hover::before {
      opacity: 1;
    }
    
    /* Task Card Tooltip - Fixed positioning */
    .task-card {
      position: static;
    }
    .task-card:hover .task-tooltip {
      visibility: visible;
      opacity: 1;
    }
    .task-tooltip {
      visibility: hidden;
      opacity: 0;
      position: fixed;
      width: 220px;
      padding: 12px;
      background: #1F2937;
      color: white;
      font-size: 12px;
      border-radius: 8px;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      white-space: normal;
      line-height: 1.5;
      transition: opacity 0.2s, visibility 0.2s;
      pointer-events: none;
    }
  </style>
</head>
<body class="bg-cream-100 text-gray-800 min-h-screen">
  <!-- Header -->
  <header class="bg-white border-b border-cream-300 h-14 sticky top-0 z-50">
    <div class="h-full px-6 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="#" onclick="showMainView()" class="flex items-center gap-2 hover:opacity-80">
          <span class="text-xl">‚óá</span>
          <span class="font-semibold tracking-wide">MISSION CONTROL</span>
        </a>
        <div id="breadcrumb" class="flex items-center gap-2 text-sm"></div>
      </div>
      
      <div class="flex items-center gap-6">
        <div class="flex items-center gap-4 text-sm text-gray-600">
          <span><span id="header-active" class="font-semibold text-gray-900">0</span> active</span>
          <span class="text-gray-300">¬∑</span>
          <span><span id="header-tasks" class="font-semibold text-gray-900">0</span> tasks</span>
        </div>
        <div class="text-right">
          <div id="clock" class="text-lg font-mono font-medium text-gray-700">00:00:00</div>
          <div id="date" class="text-[10px] text-gray-400 uppercase"></div>
        </div>
        <div id="connection" class="flex items-center gap-1.5 text-xs font-medium">
          <span class="status-dot status-active"></span>
        </div>
      </div>
    </div>
  </header>
  <!-- Hidden filter state (preserved for functionality) -->
  <div id="header-filter" class="hidden"><span id="filter-name"></span></div>

  <!-- Main View (Agent Grid) -->
  <main id="main-view" class="p-md min-h-[calc(100vh-56px)]">
    <!-- CEO Command Center -->
    <div class="bg-cream-200 rounded-lg p-md mb-md border border-cream-300">
      <div class="flex items-start gap-md">
        <div class="w-12 h-12 bg-cream-100 border border-cream-300 rounded-lg flex items-center justify-center text-xl flex-shrink-0">üëî</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-xs mb-1">
            <h2 class="text-heading text-gray-800">BOSS</h2>
            <span class="badge badge-CEO">CEO</span>
          </div>
          <p class="text-caption text-gray-500 mb-sm">Give orders ‚Üí MOMO will assign to departments</p>
          <div class="flex gap-xs">
            <input id="ceo-command" type="text" class="flex-1 bg-white border border-cream-300 rounded-lg px-sm py-xs text-body text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-peach-400 focus:ring-offset-1" placeholder="Type command...">
            <button onclick="sendCeoCommand()" class="px-sm py-xs bg-peach-500 hover:bg-peach-600 text-white rounded-lg text-body font-medium transition-colors">Send ‚Üí</button>
          </div>
        </div>
      </div>
      <div id="ceo-recent" class="mt-sm pt-sm border-t border-cream-300 hidden">
        <div class="text-caption text-gray-500 mb-xs">Recent commands:</div>
        <div id="ceo-commands-list" class="space-y-1 text-body text-gray-600"></div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-4 gap-sm mb-md">
      <div class="bg-white rounded-lg p-sm border border-cream-300">
        <div class="text-display text-gray-800" id="stat-agents">0</div>
        <div class="text-caption text-gray-500">Departments</div>
      </div>
      <div class="bg-white rounded-lg p-sm border border-cream-300">
        <div class="text-display text-gray-800" id="stat-bots">0/0</div>
        <div class="text-caption text-gray-500">PM2 Bots</div>
      </div>
      <div class="bg-white rounded-lg p-sm border border-cream-300">
        <div class="text-display text-gray-800" id="stat-disk">-</div>
        <div class="text-caption text-gray-500">Disk Usage</div>
      </div>
      <div class="bg-white rounded-lg p-sm border border-cream-300 border-l-4 border-l-peach-400">
        <div class="text-display text-peach-600" id="stat-eth">-</div>
        <div class="text-caption text-gray-500">ETH Balance</div>
      </div>
    </div>

    <div class="flex items-center justify-between mb-sm">
      <h2 class="section-title">All Departments</h2>
      <button onclick="openSpawnModal()" class="px-4 py-2 bg-peach-500 text-white rounded-lg text-caption font-medium hover:bg-peach-600 transition-colors">+ New Agent</button>
    </div>
    <div id="agents-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-sm"></div>
  </main>

  <!-- Agent Detail View (Mission Control Style) -->
  <main id="agent-view" class="view-hidden h-[calc(100vh-56px)] flex">
    <!-- Center - Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <div class="px-sm py-xs border-b border-cream-300 bg-white flex items-center justify-between">
        <div class="flex items-center gap-xs">
          <span class="w-1.5 h-1.5 bg-peach-500 rounded-full"></span>
          <span id="queue-title" class="section-title">TASKS</span>
        </div>
        <!-- bot-controls removed - now in Bot Management panel -->
      </div>
      
      <!-- PM2 Bots Section (only visible in BOT department) -->
      <div id="bot-department-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">ü§ñ Bot Management</h3>
          <div class="flex gap-1">
            <button onclick="startAllBots()" class="px-2 py-1.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors" title="Start All Bots">‚ñ∂</button>
            <button onclick="stopAllBots()" class="px-2 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors" title="Stop All Bots">‚èπ</button>
          </div>
        </div>
        
        <!-- Bot Stats Summary -->
        <div class="grid grid-cols-5 gap-3 mb-4">
          <div class="bg-white rounded-lg p-3 border border-green-200 text-center">
            <div id="bots-online" class="text-2xl font-bold text-green-600">0</div>
            <div class="text-[10px] text-gray-500">Online</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-red-200 text-center">
            <div id="bots-offline" class="text-2xl font-bold text-red-500">0</div>
            <div class="text-[10px] text-gray-500">Offline</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-blue-200 text-center">
            <div id="bots-cpu" class="text-2xl font-bold text-blue-600">0%</div>
            <div class="text-[10px] text-gray-500">Total CPU</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-purple-200 text-center">
            <div id="bots-mem" class="text-2xl font-bold text-purple-600">0</div>
            <div class="text-[10px] text-gray-500">Total RAM (MB)</div>
          </div>
        </div>
        
        <!-- Grouped Bots -->
        <div id="bot-dept-bots" class="space-y-4"></div>
      </div>

      <!-- TREASURY Portfolio Panel -->
      <div id="treasury-panel" class="view-hidden border-b border-cream-200 bg-cream-50 border-l-4 border-l-amber-400 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium text-gray-800">üí∞ Portfolio Overview</h3>
          <button onclick="refreshPortfolio()" class="px-3 py-1.5 bg-amber-500 text-white rounded text-xs hover:bg-amber-600 transition-colors">üîÑ Refresh</button>
        </div>
        <div class="grid grid-cols-5 gap-3 mb-4">
          <div class="bg-white rounded-lg p-3 border border-yellow-200">
            <div class="text-xl font-bold text-yellow-600" id="portfolio-total">$0.00</div>
            <div class="text-[10px] text-gray-500">Total Value</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-blue-200">
            <div class="text-lg font-bold" id="portfolio-base">0 ETH</div>
            <div class="text-[10px] text-gray-500">üîµ Base</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-purple-200">
            <div class="text-lg font-bold" id="portfolio-polygon">0 USDC</div>
            <div class="text-[10px] text-gray-500">üü£ Polygon</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-green-200">
            <div class="text-lg font-bold" id="portfolio-jib">0 JBC</div>
            <div class="text-[10px] text-gray-500">üü¢ JIBCHAIN</div>
          </div>
        </div>
        <div class="text-xs text-gray-500">Wallet: <code class="bg-yellow-100 px-2 py-0.5 rounded">0x40dbB47c09e8B1c14b6e36722daF12eEd9E3f942</code></div>
      </div>

      <!-- PREDICT Department Panel -->
      <div id="predict-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50 border-l-4 border-l-indigo-400">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üé≤ Polymarket Predictor</h3>
          <div class="flex gap-2">
            <span id="predict-bot-status" class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">Loading...</span>
            <button onclick="refreshPredict()" class="px-3 py-1.5 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 transition-colors">üîÑ Refresh</button>
          </div>
        </div>
        
        <!-- Summary Stats Row 1 -->
        <div class="grid grid-cols-5 gap-3 mb-3">
          <div class="bg-white rounded-lg p-3 border border-indigo-200 text-center">
            <div id="predict-balance" class="text-xl font-bold text-indigo-600">$0</div>
            <div class="text-[10px] text-gray-500">USDC Balance</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-blue-200 text-center">
            <div id="predict-invested" class="text-xl font-bold text-blue-600">$0</div>
            <div class="text-[10px] text-gray-500">Invested</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-orange-200 text-center">
            <div id="predict-realized-pnl" class="text-xl font-bold text-orange-600">$0</div>
            <div class="text-[10px] text-gray-500">Realized PnL <span id="predict-realized-pct" class="font-semibold"></span></div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-emerald-200 text-center">
            <div id="predict-pnl" class="text-xl font-bold text-emerald-600">$0</div>
            <div class="text-[10px] text-gray-500">Net PnL <span id="predict-pnl-pct" class="font-semibold"></span></div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-amber-200 text-center">
            <div id="predict-winrate" class="text-xl font-bold text-amber-600">0%</div>
            <div class="text-[10px] text-gray-500">Win Rate</div>
          </div>
        </div>
        
        <!-- Summary Stats Row 2 -->
        <div class="grid grid-cols-5 gap-3 mb-4">
          <div class="bg-white rounded-lg p-2 border border-gray-200 text-center">
            <div id="predict-positions" class="text-lg font-bold text-gray-700">0</div>
            <div class="text-[9px] text-gray-500">Open</div>
          </div>
          <div class="bg-white rounded-lg p-2 border border-yellow-200 text-center">
            <div id="predict-pending" class="text-lg font-bold text-yellow-600">0</div>
            <div class="text-[9px] text-gray-500">Pending</div>
          </div>
          <div class="bg-white rounded-lg p-2 border border-gray-200 text-center">
            <div id="predict-trades" class="text-lg font-bold text-gray-700">0</div>
            <div class="text-[9px] text-gray-500">Total Trades</div>
          </div>
          <div class="bg-white rounded-lg p-2 border border-green-200 text-center">
            <div id="predict-wins" class="text-lg font-bold text-green-600">0</div>
            <div class="text-[9px] text-gray-500">Wins</div>
          </div>
          <div class="bg-white rounded-lg p-2 border border-red-200 text-center">
            <div id="predict-losses" class="text-lg font-bold text-red-500">0</div>
            <div class="text-[9px] text-gray-500">Losses</div>
          </div>
        </div>
        
        <!-- Active Positions - Grid Cards -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">üìä Active Positions</h4>
          <div id="predict-positions-list">
            <div class="text-xs text-gray-400 text-center py-4">Loading positions...</div>
          </div>
        </div>
        
        <!-- Pending Limit Orders - Grid Cards -->
        <div class="mb-4" id="predict-pending-section">
          <h4 class="text-sm font-medium text-gray-700 mb-2">‚è≥ Limit Orders (Pending)</h4>
          <div id="predict-pending-list">
            <div class="text-xs text-gray-400 text-center py-4">Loading...</div>
          </div>
        </div>
        
        <!-- Recent Trades - Grid Cards (Filled/Closed only) -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2">üìà Recent Trades</h4>
          <div id="predict-trades-list">
            <div class="text-xs text-gray-400 text-center py-4">Loading trades...</div>
          </div>
        </div>
        
        <!-- Opportunity List - Live signals from 6 strategies -->
        <div class="mb-4">
          <h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            üéØ Opportunity List
            <span id="opp-count" class="px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-[10px]">0</span>
            <span class="flex gap-1 text-[9px] text-gray-400 ml-2">
              <span class="px-1 py-0.5 bg-red-50 rounded cursor-help" title="A: TA Signal (Technical Analysis)">A</span>
              <span class="px-1 py-0.5 bg-orange-50 rounded cursor-help" title="B: Sniper (Order Flow / Volume)">B</span>
              <span class="px-1 py-0.5 bg-yellow-50 rounded cursor-help" title="C: Liquid (High Liquidity Markets)">C</span>
              <span class="px-1 py-0.5 bg-green-50 rounded cursor-help" title="D: Sports (NBA/NFL/NHL)">D</span>
              <span class="px-1 py-0.5 bg-blue-50 rounded cursor-help" title="E: Weather Markets">E</span>
              <span class="px-1 py-0.5 bg-purple-50 rounded cursor-help" title="F: Value (Arbitrage/Mean Reversion)">F</span>
            </span>
            <button onclick="loadOpportunities()" class="ml-auto text-[10px] text-gray-400 hover:text-gray-600">‚Üª Refresh</button>
          </h4>
          <div id="opportunity-list" class="grid grid-cols-5 gap-2">
            <div class="col-span-5 text-xs text-gray-400 text-center py-4">Loading opportunities...</div>
          </div>
        </div>
        
        <!-- Hot Markets - Hidden per Pol's request -->
        <div id="predict-markets-section" style="display: none;">
          <h4 class="text-sm font-medium text-gray-700 mb-2">üî• Hot Markets</h4>
          <div id="predict-markets-list" class="space-y-1 max-h-32 overflow-y-auto">
          </div>
        </div>
      </div>

      <!-- MOMO Autonomy Rules Panel -->
      <div id="momo-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50 border-l-4 border-l-peach-400">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üçë MOMO Autonomy Rules</h3>
          <div class="flex items-center gap-2">
            <span class="text-xs text-gray-500">Updated: <span id="momo-rules-updated">--</span></span>
            <button onclick="saveMomoRules()" class="px-3 py-1.5 bg-peach-500 text-white rounded text-xs hover:bg-peach-600 transition-colors">üíæ Save</button>
          </div>
        </div>
        
        <!-- Autonomous Actions - Card Grid -->
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-green-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
            ‚úÖ Autonomous
          </h4>
          <div class="grid grid-cols-5 gap-3">
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üîß</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-code" checked onchange="updateRule('code', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Code & Technical</div>
              <div class="text-[10px] text-gray-500 leading-tight">Bug fixes, refactor, config, restart bots, git commit</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">ü§ñ</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-bot" checked onchange="updateRule('bot', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Bot Operations</div>
              <div class="text-[10px] text-gray-500 leading-tight">Trade ‚â§$20, analyze losses, blacklist</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üê¶</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-twitter" checked onchange="updateRule('twitter', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Twitter/Social</div>
              <div class="text-[10px] text-gray-500 leading-tight">Promote $MOMO and projects only</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üß™</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-testnet" checked onchange="updateRule('testnet', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Testnet & Research</div>
              <div class="text-[10px] text-gray-500 leading-tight">Deploy testnet, web search, study</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üìà</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-scaling" checked onchange="updateRule('scaling', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Trade Scaling</div>
              <div class="text-[10px] text-gray-500 leading-tight">Win >60% ‚Üí scale 2x</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">‚è∞</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-cron" checked onchange="updateRule('cron', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Cron & Scheduling</div>
              <div class="text-[10px] text-gray-500 leading-tight">Reminders, status reports</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üîî</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-alerts" checked onchange="updateRule('alerts', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Proactive Alerts</div>
              <div class="text-[10px] text-gray-500 leading-tight">Telegram: wallet, crash, wins</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üö®</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-emergency" checked onchange="updateRule('emergency', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Emergency Actions</div>
              <div class="text-[10px] text-gray-500 leading-tight">Liquidation protection</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-green-200 hover:border-green-400 hover:shadow-lg transition-all cursor-pointer group">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üñ•Ô∏è</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-maintenance" checked onchange="updateRule('maintenance', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Server Maintenance</div>
              <div class="text-[10px] text-gray-500 leading-tight">Logs, cleanup, updates</div>
            </div>
          </div>
        </div>
        
        <!-- Needs Approval - Card Grid -->
        <div class="mb-6">
          <h4 class="text-sm font-semibold text-amber-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-amber-500 rounded-full"></span>
            ‚è∏Ô∏è Need Approval
          </h4>
          <div class="grid grid-cols-5 gap-3">
            <div class="bg-white rounded-xl p-4 border-2 border-amber-200 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üí∞</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-money" onchange="updateRule('money', this.checked)">
                  <span class="toggle-slider toggle-slider-amber"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Money Operations</div>
              <div class="text-[10px] text-gray-500 leading-tight">Add/withdraw funds, trade >$20</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-amber-200 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üìß</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-external" onchange="updateRule('external', this.checked)">
                  <span class="toggle-slider toggle-slider-amber"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">External Comms</div>
              <div class="text-[10px] text-gray-500 leading-tight">Email, non-project posts</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-amber-200 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üöÄ</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-deploy" onchange="updateRule('deploy', this.checked)">
                  <span class="toggle-slider toggle-slider-amber"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">New Deployments</div>
              <div class="text-[10px] text-gray-500 leading-tight">New tokens, untested bots</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-amber-200 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üîê</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-security" onchange="updateRule('security', this.checked)">
                  <span class="toggle-slider toggle-slider-amber"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Security Changes</div>
              <div class="text-[10px] text-gray-500 leading-tight">Keys, credentials, ports</div>
            </div>
          </div>
        </div>
        
        <!-- Learning & Discovery - Card Grid -->
        <div class="mb-4">
          <h4 class="text-sm font-semibold text-cyan-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-cyan-500 rounded-full"></span>
            üß† Learning & Discovery
          </h4>
          <div class="grid grid-cols-5 gap-3">
            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200 hover:border-cyan-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üìö</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-learning" checked onchange="updateRule('learning', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Self-Learning</div>
              <div class="text-[10px] text-gray-500 leading-tight">Docs, tutorials, code study</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200 hover:border-cyan-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üí°</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-profit" checked onchange="updateRule('profit', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Profit Discovery</div>
              <div class="text-[10px] text-gray-500 leading-tight">Discover new profit opportunities</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200 hover:border-cyan-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">ü§ñ</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-models" checked onchange="updateRule('models', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Model Exploration</div>
              <div class="text-[10px] text-gray-500 leading-tight">Test new AI models</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200 hover:border-cyan-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üîå</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-skills" checked onchange="updateRule('skills', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Skill Hunting</div>
              <div class="text-[10px] text-gray-500 leading-tight">Find skills from ClawHub</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-cyan-200 hover:border-cyan-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üîç</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="rule-botresearch" checked onchange="updateRule('botresearch', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Bot Research</div>
              <div class="text-[10px] text-gray-500 leading-tight">Study other bots strategies</div>
            </div>
          </div>
        </div>
        
        <!-- Trade Config -->
        <div class="mt-4 pt-4 border-t border-cream-300">
          <h4 class="text-sm font-semibold text-blue-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
            üíµ Trade Config
          </h4>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <label class="text-xs text-gray-500 block mb-1">Max Trade Size ($)</label>
              <input type="number" id="config-max-trade" value="20" min="1" max="1000" 
                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                onchange="updateConfig('maxTradeSize', this.value)">
            </div>
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <label class="text-xs text-gray-500 block mb-1">Min Edge (%)</label>
              <input type="number" id="config-min-edge" value="15" min="1" max="50" 
                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                onchange="updateConfig('minEdge', this.value)">
            </div>
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <label class="text-xs text-gray-500 block mb-1">Max Spread (%)</label>
              <input type="number" id="config-max-spread" value="5" min="1" max="50" 
                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                onchange="updateConfig('maxSpread', this.value)">
            </div>
            <div class="bg-white rounded-lg p-3 border border-blue-200">
              <label class="text-xs text-gray-500 block mb-1">Max Bets/Day</label>
              <input type="number" id="config-max-bets" value="3" min="1" max="20" 
                class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-400"
                onchange="updateConfig('maxBetsPerDay', this.value)">
            </div>
          </div>
        </div>
        
        <!-- Alert Settings - Card Grid -->
        <div class="mt-4 pt-4 border-t border-cream-300">
          <h4 class="text-sm font-semibold text-purple-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
            üîî Alert Settings
          </h4>
          <div class="grid grid-cols-5 gap-3">
            <div class="bg-white rounded-xl p-4 border-2 border-purple-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üí∞</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="alert-wallet" checked onchange="updateAlert('walletLow', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Wallet Low</div>
              <div class="text-[10px] text-gray-500 leading-tight">Alert when balance low</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-purple-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">ü§ñ</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="alert-crash" checked onchange="updateAlert('botCrash', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Bot Crash</div>
              <div class="text-[10px] text-gray-500 leading-tight">Alert when bot crashes</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-purple-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üìà</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="alert-trade" checked onchange="updateAlert('tradeResult', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Trade Win/Loss</div>
              <div class="text-[10px] text-gray-500 leading-tight">Alert trade results</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-purple-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üìä</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="alert-daily" checked onchange="updateAlert('dailySummary', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Daily Summary</div>
              <div class="text-[10px] text-gray-500 leading-tight">Daily summary</div>
            </div>
            <div class="bg-white rounded-xl p-4 border-2 border-purple-200 hover:border-purple-400 hover:shadow-lg transition-all cursor-pointer">
              <div class="flex items-center justify-between mb-2">
                <span class="text-2xl">üö®</span>
                <label class="toggle-switch scale-75">
                  <input type="checkbox" id="alert-emergency" checked onchange="updateAlert('emergency', this.checked)">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="text-sm font-semibold text-gray-800 mb-1">Emergency</div>
              <div class="text-[10px] text-gray-500 leading-tight">Emergency</div>
            </div>
          </div>
        </div>
        
        <!-- Quiet Hours -->
        <div class="mt-4 pt-4 border-t border-cream-300">
          <h4 class="text-sm font-semibold text-indigo-700 mb-3 flex items-center gap-2">
            <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
            üåô Quiet Hours
          </h4>
          <div class="bg-white rounded-lg p-3 border border-indigo-200">
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm">Enable Quiet Hours</span>
              <label class="toggle-switch">
                <input type="checkbox" id="quiet-enabled" checked onchange="updateQuiet('enabled', this.checked)">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="flex items-center gap-3">
              <div class="flex-1">
                <label class="text-xs text-gray-500 block mb-1">Start</label>
                <input type="time" id="quiet-start" value="23:00" 
                  class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
                  onchange="updateQuiet('start', this.value)">
              </div>
              <div class="text-gray-400 pt-5">‚Üí</div>
              <div class="flex-1">
                <label class="text-xs text-gray-500 block mb-1">End</label>
                <input type="time" id="quiet-end" value="08:00" 
                  class="w-full px-2 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"
                  onchange="updateQuiet('end', this.value)">
              </div>
            </div>
            <p class="text-xs text-gray-400 mt-2">No notifications during this time (except urgent)</p>
          </div>
        </div>
      </div>

      <!-- AGENTS Multi-Agent Coordination Panel -->
      <div id="agents-coord-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50 border-l-4 border-l-violet-400">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">ü§ñ Multi-Agent Coordination</h3>
          <div class="flex items-center gap-2">
            <button onclick="toggleAgentLoop()" id="agent-loop-btn" class="px-3 py-1.5 bg-violet-500 text-white rounded text-xs hover:bg-violet-600 transition-colors">‚ñ∂Ô∏è Start Loop</button>
            <button onclick="refreshAgentStatus()" class="px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors">üîÑ</button>
          </div>
        </div>
        
        <!-- Agent Status Cards -->
        <div class="grid grid-cols-6 gap-3 mb-4" id="agent-cards">
          <!-- Populated by JS -->
        </div>
        
        <!-- Task Assignment -->
        <div class="bg-white rounded-lg p-4 border border-violet-200 mb-4">
          <h4 class="text-sm font-semibold text-violet-700 mb-3">üìã Assign Task</h4>
          <div class="flex gap-2">
            <select id="task-agent" class="flex-shrink-0 px-3 py-2 border border-gray-300 rounded text-sm">
              <option value="scout">üîç Scout</option>
              <option value="analyst">üìä Analyst</option>
              <option value="executor">‚ö° Executor</option>
              <option value="auditor">üõ°Ô∏è Auditor</option>
              <option value="content">‚úçÔ∏è Content</option>
              <option value="infra">üîß Infra</option>
            </select>
            <input type="text" id="task-input" placeholder="Enter task description..." 
              class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-violet-400">
            <button onclick="assignAgentTask()" class="px-4 py-2 bg-violet-500 text-white rounded text-sm hover:bg-violet-600">Send</button>
          </div>
        </div>
        
        <!-- Recent Activity Feed -->
        <div class="bg-white rounded-lg p-4 border border-gray-200">
          <h4 class="text-sm font-semibold text-gray-700 mb-3">üìú Activity Feed</h4>
          <div id="agent-activity-feed" class="space-y-2 max-h-48 overflow-y-auto text-sm">
            <div class="text-gray-400 text-center py-4">No activity yet</div>
          </div>
        </div>
      </div>

      <!-- INTEL Research Panel -->
      <div id="intel-panel" class="view-hidden border-b border-cream-200 bg-cream-50 border-l-4 border-l-indigo-400 p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium text-gray-800">üîç Market Intelligence</h3>
          <button onclick="refreshIntel()" class="px-3 py-1.5 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 transition-colors">üîÑ Refresh</button>
        </div>
        <div class="grid grid-cols-5 gap-3 mb-3">
          <div class="bg-white rounded-lg p-3 border border-indigo-200">
            <div class="text-lg font-bold text-green-600" id="intel-btc">$0</div>
            <div class="text-[10px] text-gray-500">BTC</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-indigo-200">
            <div class="text-lg font-bold text-blue-600" id="intel-eth">$0</div>
            <div class="text-[10px] text-gray-500">ETH</div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-indigo-200 col-span-2">
            <div class="text-sm font-medium" id="intel-trending">Loading...</div>
            <div class="text-[10px] text-gray-500">üî• Trending</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-white rounded-lg p-3 border border-indigo-200">
            <div class="text-[10px] font-semibold text-gray-500 mb-2">ü™Ç Airdrops</div>
            <div id="intel-airdrops" class="space-y-1 text-xs"></div>
          </div>
          <div class="bg-white rounded-lg p-3 border border-indigo-200">
            <div class="text-[10px] font-semibold text-gray-500 mb-2">üìä Polymarket Hot</div>
            <div id="intel-polymarket" class="space-y-1 text-xs"></div>
          </div>
        </div>
      </div>

      <!-- CREDITS Token Management Panel -->
      <div id="credits-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-100">
        <!-- Header Note -->
        <div class="bg-cream-200 rounded-lg p-3 mb-4 text-sm text-gray-600">
          Showing API usage only. Select 'All workspaces' to include workbench usage.
        </div>
        
        <!-- Top 3 Cards -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <!-- Total Token Cost -->
          <div class="bg-cream-200 rounded-xl p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-gray-600 mb-1">Total token cost</div>
                <div class="text-3xl font-bold text-gray-800" id="credits-total">$0.00</div>
              </div>
              <!-- Donut Chart -->
              <div class="relative w-20 h-20">
                <svg viewBox="0 0 36 36" class="w-20 h-20">
                  <circle cx="18" cy="18" r="15.915" fill="none" stroke="#E5DDD3" stroke-width="3"/>
                  <circle id="donut-opus" cx="18" cy="18" r="15.915" fill="none" stroke="#C084A0" stroke-width="3" 
                    stroke-dasharray="0 100" stroke-dashoffset="25" stroke-linecap="round" class="transition-all duration-500"/>
                  <circle id="donut-sonnet" cx="18" cy="18" r="15.915" fill="none" stroke="#E8956A" stroke-width="3"
                    stroke-dasharray="0 100" stroke-dashoffset="25" stroke-linecap="round" class="transition-all duration-500"/>
                </svg>
              </div>
            </div>
          </div>
          
          <!-- Sub-agent Cost (Sonnet) -->
          <div class="bg-cream-200 rounded-xl p-5">
            <div class="text-sm text-gray-600 mb-1">Sub-agent cost</div>
            <div class="text-xs text-gray-500 mb-2">Claude Sonnet 4.5 for research & background tasks</div>
            <div class="text-3xl font-bold text-blue-600" id="credits-subagent">$0.00</div>
          </div>
          
          <!-- Cache Savings -->
          <div class="bg-cream-200 rounded-xl p-5">
            <div class="text-sm text-gray-600 mb-1">Cache savings</div>
            <div class="text-xs text-gray-500 mb-2">Saved from prompt caching (90% discount)</div>
            <div class="text-3xl font-bold text-green-600" id="credits-cache">$0.00</div>
          </div>
        </div>
        
        <!-- Daily Token Cost Chart -->
        <div class="bg-cream-200 rounded-xl p-5">
          <!-- Header with Month Navigation -->
          <div class="flex items-center justify-between mb-4">
            <div class="text-sm font-medium text-gray-700">Daily token cost</div>
            <div class="flex items-center gap-2">
              <button onclick="changeCreditsMonth(-1)" class="px-2 py-1 bg-cream-300 hover:bg-cream-200 rounded text-gray-600 text-sm">‚óÄ</button>
              <span id="credits-month-label" class="text-sm font-medium text-gray-700 min-w-[100px] text-center">Feb 2026</span>
              <button onclick="changeCreditsMonth(1)" class="px-2 py-1 bg-cream-300 hover:bg-cream-200 rounded text-gray-600 text-sm">‚ñ∂</button>
            </div>
          </div>
          
          <!-- Y-Axis Labels + Chart Container -->
          <div class="flex">
            <!-- Y-Axis Labels -->
            <div class="flex flex-col justify-between text-xs text-gray-500 pr-2 h-56" id="credits-y-axis">
              <span>$200</span>
              <span>$150</span>
              <span>$100</span>
              <span>$50</span>
              <span>$0</span>
            </div>
            
            <!-- Bar Chart - Full width, equal distribution -->
            <div class="flex-1">
              <div class="flex items-end justify-between h-56 border-l border-b border-gray-300 pb-1 pl-1 pr-1" id="credits-bars">
                <!-- Bars will be injected by JS -->
              </div>
              <!-- X-Axis Labels -->
              <div class="flex justify-between text-[10px] text-gray-500 mt-1 pl-1 pr-1" id="credits-x-axis">
                <!-- Dates will be injected by JS -->
              </div>
            </div>
          </div>
          
          <!-- Legend -->
          <div class="flex items-center gap-6 mt-4">
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded bg-orange-400"></div>
              <span class="text-xs text-gray-600">Claude Sonnet 4.5</span>
            </div>
            <div class="flex items-center gap-2">
              <div class="w-4 h-4 rounded bg-pink-400"></div>
              <span class="text-xs text-gray-600">Claude Opus 4.5</span>
            </div>
            <div class="ml-auto text-xs text-gray-500" id="credits-month-total">Month total: $0.00</div>
          </div>
        </div>
        
        <!-- Refresh Button -->
        <div class="mt-4 flex justify-end">
          <button onclick="refreshCredits()" class="px-4 py-2 bg-orange-500 text-white rounded-lg text-sm hover:bg-orange-600 transition-colors">
            üîÑ Refresh Data
          </button>
        </div>
      </div>

      <!-- INFRA Infrastructure Panel -->
      <div id="infra-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üñ•Ô∏è Infrastructure Monitor</h3>
          <div class="flex items-center gap-2">
            <button onclick="refreshInfra()" class="px-3 py-1.5 bg-teal-500 text-white rounded text-xs hover:bg-teal-600 transition-colors">üîÑ Refresh</button>
            <button onclick="toggleInfraAutoRefresh()" id="infra-auto-btn" class="px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors">‚è∞ Auto: OFF</button>
          </div>
        </div>
        
        <!-- Alert Banner -->
        <div id="infra-alerts" class="hidden mb-4 bg-red-100 border border-red-300 rounded-lg p-3">
          <div class="flex items-center gap-2 text-red-700 font-medium text-sm">
            <span>üö®</span>
            <span id="infra-alert-text">No alerts</span>
          </div>
        </div>
        
        <div class="grid grid-cols-4 gap-4">
          <!-- CPU Donut -->
          <div class="bg-white rounded-lg p-4 border border-teal-200 text-center">
            <div class="relative w-32 h-32 mx-auto mb-3">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E5E7EB" stroke-width="3"></circle>
                <circle id="cpu-donut" cx="18" cy="18" r="15.9" fill="none" stroke="#14B8A6" stroke-width="3" 
                        stroke-dasharray="0, 100" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="cpu-percent" class="text-2xl font-bold text-teal-600">0%</span>
              </div>
            </div>
            <div class="text-sm font-medium text-gray-700">CPU Usage</div>
            <div id="cpu-cores" class="text-[10px] text-gray-400">-- cores</div>
          </div>

          <!-- Memory Donut -->
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div class="relative w-32 h-32 mx-auto mb-3">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E5E7EB" stroke-width="3"></circle>
                <circle id="mem-donut" cx="18" cy="18" r="15.9" fill="none" stroke="#3B82F6" stroke-width="3" 
                        stroke-dasharray="0, 100" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="mem-percent" class="text-2xl font-bold text-blue-600">0%</span>
              </div>
            </div>
            <div class="text-sm font-medium text-gray-700">Memory</div>
            <div id="mem-info" class="text-[10px] text-gray-400">-- / -- GB</div>
          </div>

          <!-- Disk Donut -->
          <div class="bg-white rounded-lg p-4 border border-purple-200 text-center">
            <div class="relative w-32 h-32 mx-auto mb-3">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E5E7EB" stroke-width="3"></circle>
                <circle id="disk-donut" cx="18" cy="18" r="15.9" fill="none" stroke="#8B5CF6" stroke-width="3" 
                        stroke-dasharray="0, 100" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="disk-percent" class="text-2xl font-bold text-purple-600">0%</span>
              </div>
            </div>
            <div class="text-sm font-medium text-gray-700">Disk</div>
            <div id="disk-info" class="text-[10px] text-gray-400">-- / -- GB</div>
          </div>

          <!-- GPU/VGA Donut -->
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div class="relative w-32 h-32 mx-auto mb-3">
              <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                <circle cx="18" cy="18" r="15.9" fill="none" stroke="#E5E7EB" stroke-width="3"></circle>
                <circle id="gpu-donut" cx="18" cy="18" r="15.9" fill="none" stroke="#22C55E" stroke-width="3" 
                        stroke-dasharray="0, 100" stroke-linecap="round"></circle>
              </svg>
              <div class="absolute inset-0 flex items-center justify-center">
                <span id="gpu-percent" class="text-2xl font-bold text-green-600">N/A</span>
              </div>
            </div>
            <div class="text-sm font-medium text-gray-700">GPU</div>
            <div id="gpu-info" class="text-[10px] text-gray-400">--</div>
          </div>
        </div>

        <!-- Row 2: System Info + Load Average + Temperature -->
        <div class="grid grid-cols-3 gap-4 mt-4">
          <!-- System Info -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üìã System Info</div>
            <div class="space-y-2 text-sm">
              <div><span class="text-gray-500">Hostname:</span> <span id="sys-hostname" class="font-medium">--</span></div>
              <div><span class="text-gray-500">OS:</span> <span id="sys-os" class="font-medium text-[11px]">--</span></div>
              <div><span class="text-gray-500">Uptime:</span> <span id="sys-uptime" class="font-medium">--</span></div>
              <div><span class="text-gray-500">Node:</span> <span id="sys-node" class="font-medium">--</span></div>
            </div>
          </div>

          <!-- Load Average -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üìä Load Average</div>
            <div class="flex justify-between items-end h-20">
              <div class="text-center flex-1">
                <div id="load-1" class="text-2xl font-bold text-blue-600">--</div>
                <div class="text-[10px] text-gray-400">1 min</div>
              </div>
              <div class="text-center flex-1">
                <div id="load-5" class="text-2xl font-bold text-blue-500">--</div>
                <div class="text-[10px] text-gray-400">5 min</div>
              </div>
              <div class="text-center flex-1">
                <div id="load-15" class="text-2xl font-bold text-blue-400">--</div>
                <div class="text-[10px] text-gray-400">15 min</div>
              </div>
            </div>
          </div>

          <!-- Temperature -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üå°Ô∏è Temperature</div>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">CPU</span>
                <span id="temp-cpu" class="text-lg font-bold text-orange-500">--¬∞C</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">GPU</span>
                <span id="temp-gpu" class="text-lg font-bold text-orange-500">--¬∞C</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Network + Top Processes -->
        <div class="grid grid-cols-2 gap-4 mt-4">
          <!-- Network -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üåê Network</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-500">IP Address:</span>
                <span id="net-ip" class="font-mono text-xs">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">‚Üì Download:</span>
                <span id="net-rx" class="font-medium text-green-600">-- MB/s</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">‚Üë Upload:</span>
                <span id="net-tx" class="font-medium text-blue-600">-- MB/s</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Connections:</span>
                <span id="net-conn" class="font-medium">--</span>
              </div>
            </div>
          </div>

          <!-- Top Processes -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üî• Top Processes (CPU)</div>
            <div id="top-processes" class="space-y-1 text-xs font-mono">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 4: Open Ports + Services -->
        <div class="grid grid-cols-2 gap-4 mt-4">
          <!-- Open Ports -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üîå Open Ports</div>
            <div id="open-ports" class="flex flex-wrap gap-2">
              <span class="text-gray-400 text-xs">Loading...</span>
            </div>
          </div>

          <!-- Services -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">‚öôÔ∏è Services</div>
            <div id="services-list" class="space-y-1 text-xs">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 5: Security + Docker + Cron -->
        <div class="grid grid-cols-3 gap-4 mt-4">
          <!-- Security -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üîí Security</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-500">Failed Logins:</span>
                <span id="sec-failed" class="font-medium text-red-500">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Firewall:</span>
                <span id="sec-firewall" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Updates:</span>
                <span id="sec-updates" class="font-medium">--</span>
              </div>
            </div>
          </div>

          <!-- Docker -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üê≥ Docker</div>
            <div id="docker-status" class="space-y-1 text-sm">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Cron Jobs -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üìÖ Cron Jobs</div>
            <div id="cron-jobs" class="space-y-1 text-xs font-mono">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 6: Disk I/O + CPU History Chart -->
        <div class="grid grid-cols-2 gap-4 mt-4">
          <!-- Disk I/O -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üíæ Disk I/O (since boot)</div>
            <div class="space-y-3">
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-500">üì• Read</span>
                  <span id="disk-read" class="font-medium text-green-600">-- MB</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div id="disk-read-bar" class="h-full bg-green-500 transition-all" style="width: 0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span class="text-gray-500">üì§ Write</span>
                  <span id="disk-write" class="font-medium text-blue-600">-- MB</span>
                </div>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div id="disk-write-bar" class="h-full bg-blue-500 transition-all" style="width: 0%"></div>
                </div>
              </div>
              <div class="text-[10px] text-gray-400 text-center">
                Total: <span id="disk-total-read">--</span> GB read / <span id="disk-total-write">--</span> GB write
              </div>
            </div>
          </div>

          <!-- CPU History Mini Chart -->
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üìà CPU History (last 1 hour)</div>
            <div class="h-20 flex items-end gap-px" id="cpu-history-chart">
              <!-- Bars will be added dynamically -->
            </div>
            <div class="flex justify-between text-[9px] text-gray-400 mt-1">
              <span>1h ago</span>
              <span>now</span>
            </div>
          </div>
        </div>

        <!-- Alert Thresholds Config -->
        <div class="mt-4 bg-white rounded-lg p-4 border border-yellow-200">
          <div class="text-[10px] font-semibold text-yellow-600 uppercase mb-3">‚ö†Ô∏è Alert Thresholds</div>
          <div class="grid grid-cols-4 gap-4 text-sm">
            <div>
              <label class="text-gray-500 text-xs">CPU Warning</label>
              <div class="flex items-center gap-1">
                <input type="number" id="alert-cpu" value="80" class="w-16 px-2 py-1 border border-gray-200 rounded text-sm">
                <span class="text-gray-400">%</span>
              </div>
            </div>
            <div>
              <label class="text-gray-500 text-xs">Memory Warning</label>
              <div class="flex items-center gap-1">
                <input type="number" id="alert-mem" value="80" class="w-16 px-2 py-1 border border-gray-200 rounded text-sm">
                <span class="text-gray-400">%</span>
              </div>
            </div>
            <div>
              <label class="text-gray-500 text-xs">Disk Warning</label>
              <div class="flex items-center gap-1">
                <input type="number" id="alert-disk" value="90" class="w-16 px-2 py-1 border border-gray-200 rounded text-sm">
                <span class="text-gray-400">%</span>
              </div>
            </div>
            <div>
              <label class="text-gray-500 text-xs">Temp Warning</label>
              <div class="flex items-center gap-1">
                <input type="number" id="alert-temp" value="70" class="w-16 px-2 py-1 border border-gray-200 rounded text-sm">
                <span class="text-gray-400">¬∞C</span>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- SECURITY Department Panel -->
      <div id="security-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <h3 class="font-medium text-gray-800">üõ°Ô∏è Security Center</h3>
            <!-- Security Score -->
            <div id="security-score-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-700">
              Score: A
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="runSecurityScan()" class="px-3 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors">üîç Scan Now</button>
            <button onclick="toggleAutoScan()" id="auto-scan-btn" class="px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors">‚è∞ Auto: OFF</button>
          </div>
        </div>
        
        <!-- Row 1: Summary + Security Score -->
        <div class="grid grid-cols-5 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-red-200 text-center">
            <div id="sec-critical" class="text-3xl font-bold text-red-600">0</div>
            <div class="text-[10px] text-gray-500">üî¥ Critical</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-orange-200 text-center">
            <div id="sec-high" class="text-3xl font-bold text-orange-500">0</div>
            <div class="text-[10px] text-gray-500">üü† High</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-yellow-200 text-center">
            <div id="sec-medium" class="text-3xl font-bold text-yellow-500">0</div>
            <div class="text-[10px] text-gray-500">üü° Medium</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div id="sec-safe" class="text-3xl font-bold text-green-500">0</div>
            <div class="text-[10px] text-gray-500">üü¢ Safe</div>
          </div>
          <!-- Security Score Card -->
          <div id="security-score-card" class="bg-gradient-to-br from-green-400 to-green-600 rounded-lg p-4 text-center text-white">
            <div id="sec-score-letter" class="text-4xl font-bold">A</div>
            <div class="text-[10px] opacity-80">Security Score</div>
            <div id="sec-score-percent" class="text-sm font-medium">95%</div>
          </div>
        </div>

        <!-- Critical Alerts -->
        <div class="bg-white rounded-lg p-4 border border-red-300 mb-4">
          <div class="text-[10px] font-semibold text-red-600 uppercase mb-3">üö® Critical Malware Alerts</div>
          <div id="critical-alerts" class="space-y-2">
            <div class="text-gray-400 text-sm">Click "Scan Now" to check...</div>
          </div>
        </div>

        <!-- Row 2: SSH Sessions + User Permissions -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- SSH Sessions -->
          <div class="bg-white rounded-lg p-4 border border-cyan-200">
            <div class="text-[10px] font-semibold text-cyan-600 uppercase mb-3">üîê SSH Sessions</div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Active Sessions:</span>
                <span id="ssh-active" class="font-medium text-cyan-600">0</span>
              </div>
              <div id="ssh-sessions-list" class="space-y-1 text-xs">
                <div class="text-gray-400">No active sessions</div>
              </div>
              <div class="border-t border-gray-100 pt-2 mt-2">
                <div class="text-[10px] text-gray-500 mb-1">Recent Logins:</div>
                <div id="ssh-history" class="space-y-1 text-xs font-mono">
                  <div class="text-gray-400">--</div>
                </div>
              </div>
            </div>
          </div>

          <!-- User Permissions -->
          <div class="bg-white rounded-lg p-4 border border-indigo-200">
            <div class="text-[10px] font-semibold text-indigo-600 uppercase mb-3">üë§ User Permissions</div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Sudo Users:</span>
                <span id="sudo-count" class="font-medium">0</span>
              </div>
              <div id="sudo-users-list" class="space-y-1 text-xs">
                <div class="text-gray-400">--</div>
              </div>
              <div class="border-t border-gray-100 pt-2 mt-2">
                <div class="text-[10px] text-gray-500 mb-1">Root Login:</div>
                <span id="root-login-status" class="text-xs px-2 py-0.5 rounded bg-green-100 text-green-700">Disabled</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Secrets Scanner + Recently Modified -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Secrets Scanner -->
          <div class="bg-white rounded-lg p-4 border border-red-200">
            <div class="text-[10px] font-semibold text-red-600 uppercase mb-3">üîë Exposed Secrets</div>
            <div id="exposed-secrets" class="space-y-1 text-xs">
              <div class="text-gray-400">Click "Scan Now" to check...</div>
            </div>
          </div>

          <!-- Recently Modified Files -->
          <div class="bg-white rounded-lg p-4 border border-amber-200">
            <div class="text-[10px] font-semibold text-amber-600 uppercase mb-3">üìÅ Recently Modified (24h)</div>
            <div id="recent-files" class="space-y-1 text-xs font-mono">
              <div class="text-gray-400">--</div>
            </div>
          </div>
        </div>

        <!-- Row 4: Suspicious Files + Risky Patterns -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-orange-200">
            <div class="text-[10px] font-semibold text-orange-600 uppercase mb-3">üìÅ Suspicious Files</div>
            <div id="suspicious-files" class="space-y-1 text-xs">
              <div class="text-gray-400">--</div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-yellow-200">
            <div class="text-[10px] font-semibold text-yellow-600 uppercase mb-3">‚ö†Ô∏è Risky Code Patterns</div>
            <div id="risky-patterns" class="space-y-1 text-xs">
              <div class="text-gray-400">--</div>
            </div>
          </div>
        </div>

        <!-- Row 5: Skills Scan + SSL Certificates -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-gray-200">
            <div class="text-[10px] font-semibold text-gray-500 uppercase mb-3">üì¶ Skills & Packages Scan</div>
            <div id="skills-scan" class="space-y-2 text-sm">
              <div class="text-gray-400">Click "Scan Now" to analyze...</div>
            </div>
          </div>
          <!-- SSL Certificates -->
          <div class="bg-white rounded-lg p-4 border border-teal-200">
            <div class="text-[10px] font-semibold text-teal-600 uppercase mb-3">üìú SSL Certificates</div>
            <div id="ssl-certs" class="space-y-1 text-xs">
              <div class="text-gray-400">--</div>
            </div>
          </div>
        </div>

        <!-- Row 6: Outbound + Security Events -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-blue-200">
            <div class="text-[10px] font-semibold text-blue-600 uppercase mb-3">üåê Outbound Connections</div>
            <div id="outbound-conn" class="space-y-1 text-xs font-mono">
              <div class="text-gray-400">--</div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="text-[10px] font-semibold text-purple-600 uppercase mb-3">üìú Recent Security Events</div>
            <div id="security-events" class="space-y-1 text-xs">
              <div class="text-gray-400">--</div>
            </div>
          </div>
        </div>

        <!-- Row 7: Threat Timeline (30 Days) -->
        <div class="bg-white rounded-lg p-4 border border-gray-200 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div class="text-[10px] font-semibold text-gray-500 uppercase">üìä Threat Timeline (Last 30 Days)</div>
            <div class="flex gap-3 text-[9px]">
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-green-400"></span> Safe</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-yellow-400"></span> 1-2</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-orange-400"></span> 3-5</span>
              <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-red-500"></span> 6+</span>
            </div>
          </div>
          <div class="h-20 flex items-end gap-[2px]" id="threat-timeline">
            <!-- Bars will be added dynamically -->
          </div>
          <div class="flex justify-between text-[9px] text-gray-400 mt-2">
            <span>30 days ago</span>
            <span>15 days</span>
            <span>today</span>
          </div>
        </div>

        <!-- Last Scan Info -->
        <div class="flex justify-between items-center text-xs text-gray-400 mt-4 pt-4 border-t border-gray-200">
          <span>Last scan: <span id="last-scan-time">Never</span></span>
          <span id="auto-scan-status" class="text-gray-500">Auto-scan: Disabled</span>
        </div>
      </div>

      <!-- ENGINEER Department Panel -->
      <div id="engineer-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üõ†Ô∏è Engineering Hub</h3>
          <div class="flex items-center gap-2">
            <button onclick="refreshEngineer()" class="px-3 py-1.5 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 transition-colors">üîÑ Refresh</button>
            <button onclick="gitPull()" class="px-3 py-1.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors">‚¨áÔ∏è Git Pull</button>
            <button onclick="gitStatus()" class="px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors">üìã Status</button>
          </div>
        </div>

        <!-- Row 1: Git Stats + Environment -->
        <div class="grid grid-cols-4 gap-4 mb-4">
          <!-- Commits Today -->
          <div class="bg-white rounded-lg p-4 border border-indigo-200 text-center">
            <div id="eng-commits-today" class="text-3xl font-bold text-indigo-600">0</div>
            <div class="text-[10px] text-gray-500">Commits Today</div>
          </div>
          <!-- Commits Week -->
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div id="eng-commits-week" class="text-3xl font-bold text-blue-600">0</div>
            <div class="text-[10px] text-gray-500">Commits This Week</div>
          </div>
          <!-- Total Files -->
          <div class="bg-white rounded-lg p-4 border border-purple-200 text-center">
            <div id="eng-total-files" class="text-3xl font-bold text-purple-600">0</div>
            <div class="text-[10px] text-gray-500">JS Files</div>
          </div>
          <!-- Lines of Code -->
          <div class="bg-white rounded-lg p-4 border border-pink-200 text-center">
            <div id="eng-total-lines" class="text-3xl font-bold text-pink-600">0</div>
            <div class="text-[10px] text-gray-500">Lines of Code</div>
          </div>
        </div>

        <!-- Row 2: Branch + Recent Commits -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Current Branch & Branches -->
          <div class="bg-white rounded-lg p-4 border border-green-200">
            <div class="text-[10px] font-semibold text-green-600 uppercase mb-3">üåø Git Branches</div>
            <div class="flex items-center gap-2 mb-3">
              <span class="text-gray-500 text-sm">Current:</span>
              <span id="eng-current-branch" class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-mono">--</span>
            </div>
            <div id="eng-branches" class="space-y-1 text-xs max-h-32 overflow-y-auto">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Recent Commits -->
          <div class="bg-white rounded-lg p-4 border border-indigo-200">
            <div class="text-[10px] font-semibold text-indigo-600 uppercase mb-3">üìù Recent Commits</div>
            <div id="eng-commits" class="space-y-2 text-xs max-h-40 overflow-y-auto">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 3: File Types + TODO Scanner -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- File Types -->
          <div class="bg-white rounded-lg p-4 border border-cyan-200">
            <div class="text-[10px] font-semibold text-cyan-600 uppercase mb-3">üìÅ File Types</div>
            <div id="eng-file-types" class="space-y-1 text-xs">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- TODO/FIXME Scanner -->
          <div class="bg-white rounded-lg p-4 border border-yellow-200">
            <div class="text-[10px] font-semibold text-yellow-600 uppercase mb-3">‚ö†Ô∏è TODO/FIXME Items</div>
            <div id="eng-todos" class="space-y-1 text-xs max-h-40 overflow-y-auto">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 4: Dependencies + Vulnerabilities -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Dependencies -->
          <div class="bg-white rounded-lg p-4 border border-orange-200">
            <div class="flex items-center justify-between mb-3">
              <div class="text-[10px] font-semibold text-orange-600 uppercase">üì¶ Dependencies</div>
              <span id="eng-deps-count" class="text-xs text-gray-500">0 packages</span>
            </div>
            <div class="text-[10px] text-gray-500 mb-2">Outdated Packages:</div>
            <div id="eng-outdated" class="space-y-1 text-xs max-h-32 overflow-y-auto">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Vulnerabilities -->
          <div class="bg-white rounded-lg p-4 border border-red-200">
            <div class="text-[10px] font-semibold text-red-600 uppercase mb-3">üõ°Ô∏è npm Audit</div>
            <div id="eng-vulns" class="space-y-2">
              <div class="text-gray-400 text-xs">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 5: Largest Files + Environment -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Largest Files -->
          <div class="bg-white rounded-lg p-4 border border-purple-200">
            <div class="text-[10px] font-semibold text-purple-600 uppercase mb-3">üìè Largest Files</div>
            <div id="eng-largest" class="space-y-1 text-xs">
              <div class="text-gray-400">Loading...</div>
            </div>
          </div>

          <!-- Environment -->
          <div class="bg-white rounded-lg p-4 border border-teal-200">
            <div class="text-[10px] font-semibold text-teal-600 uppercase mb-3">‚öôÔ∏è Environment</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-500">Node.js:</span>
                <span id="eng-node" class="font-mono text-teal-600">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">npm:</span>
                <span id="eng-npm" class="font-mono text-teal-600">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">PM2:</span>
                <span id="eng-pm2" class="font-mono text-teal-600">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">OS:</span>
                <span id="eng-os" class="font-mono text-teal-600 text-xs">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-500">Uptime:</span>
                <span id="eng-uptime" class="font-mono text-teal-600">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Git Output Modal -->
        <div id="git-output" class="hidden bg-gray-900 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-green-400 text-xs font-mono">$ git output</span>
            <button onclick="document.getElementById('git-output').classList.add('hidden')" class="text-gray-500 hover:text-white">‚úï</button>
          </div>
          <pre id="git-output-text" class="text-green-300 text-xs font-mono whitespace-pre-wrap max-h-40 overflow-y-auto"></pre>
        </div>
      </div>

      <!-- SALES Department Panel -->
      <div id="sales-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üíº Sales Dashboard</h3>
          <div class="flex items-center gap-2">
            <button onclick="refreshSales()" class="px-3 py-1.5 bg-emerald-500 text-white rounded text-xs hover:bg-emerald-600 transition-colors">üîÑ Refresh</button>
            <button onclick="showAddLeadModal()" class="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 transition-colors">+ Lead</button>
            <button onclick="showAddOrderModal()" class="px-3 py-1.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors">+ Order</button>
          </div>
        </div>

        <!-- Row 1: Revenue Cards -->
        <div class="grid grid-cols-4 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div id="sales-today" class="text-2xl font-bold text-green-600">$0</div>
            <div class="text-[10px] text-gray-500">Today</div>
            <div class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
              <div id="sales-today-bar" class="h-full bg-green-500" style="width: 0%"></div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div id="sales-week" class="text-2xl font-bold text-blue-600">$0</div>
            <div class="text-[10px] text-gray-500">This Week</div>
            <div class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
              <div id="sales-week-bar" class="h-full bg-blue-500" style="width: 0%"></div>
            </div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-purple-200 text-center">
            <div id="sales-month" class="text-2xl font-bold text-purple-600">$0</div>
            <div class="text-[10px] text-gray-500">This Month</div>
            <div class="mt-1 h-1 bg-gray-200 rounded-full overflow-hidden">
              <div id="sales-month-bar" class="h-full bg-purple-500" style="width: 0%"></div>
            </div>
          </div>
          <div class="bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg p-4 text-center text-white">
            <div id="sales-total" class="text-2xl font-bold">$0</div>
            <div class="text-[10px] opacity-80">Total Revenue</div>
            <div id="sales-conversion" class="text-sm mt-1">0% conversion</div>
          </div>
        </div>

        <!-- Row 2: Pipeline + Products -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Sales Pipeline -->
          <div class="bg-white rounded-lg p-4 border border-blue-200">
            <div class="text-[10px] font-semibold text-blue-600 uppercase mb-3">üìä Sales Pipeline</div>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="w-20 text-xs text-gray-500">New Leads</div>
                <div class="flex-1 h-6 bg-gray-100 rounded overflow-hidden">
                  <div id="pipe-leads-bar" class="h-full bg-gray-400 flex items-center justify-end pr-2 text-white text-[10px] font-bold" style="width: 0%">0</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-20 text-xs text-gray-500">Contacted</div>
                <div class="flex-1 h-6 bg-gray-100 rounded overflow-hidden">
                  <div id="pipe-contacted-bar" class="h-full bg-yellow-400 flex items-center justify-end pr-2 text-white text-[10px] font-bold" style="width: 0%">0</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-20 text-xs text-gray-500">Negotiating</div>
                <div class="flex-1 h-6 bg-gray-100 rounded overflow-hidden">
                  <div id="pipe-negotiating-bar" class="h-full bg-orange-400 flex items-center justify-end pr-2 text-white text-[10px] font-bold" style="width: 0%">0</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-20 text-xs text-gray-500">Closed</div>
                <div class="flex-1 h-6 bg-gray-100 rounded overflow-hidden">
                  <div id="pipe-closed-bar" class="h-full bg-green-500 flex items-center justify-end pr-2 text-white text-[10px] font-bold" style="width: 0%">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Products -->
          <div class="bg-white rounded-lg p-4 border border-emerald-200">
            <div class="flex items-center justify-between mb-3">
              <div class="text-[10px] font-semibold text-emerald-600 uppercase">üõí Products</div>
              <button onclick="showAddProductModal()" class="text-emerald-500 hover:text-emerald-700 text-xs">+ Add</button>
            </div>
            <div id="sales-products" class="space-y-2 max-h-40 overflow-y-auto">
              <div class="text-gray-400 text-xs">Loading...</div>
            </div>
          </div>
        </div>

        <!-- Row 3: Leads List -->
        <div class="bg-white rounded-lg p-4 border border-yellow-200 mb-4">
          <div class="text-[10px] font-semibold text-yellow-600 uppercase mb-3">üë• Active Leads</div>
          <div id="sales-leads" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-gray-400 text-xs">No leads yet. Click "+ Lead" to add one.</div>
          </div>
        </div>

        <!-- Row 4: Recent Orders -->
        <div class="bg-white rounded-lg p-4 border border-green-200">
          <div class="text-[10px] font-semibold text-green-600 uppercase mb-3">üìã Recent Orders</div>
          <div id="sales-orders" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-gray-400 text-xs">No orders yet. Click "+ Order" to record a sale.</div>
          </div>
        </div>

        <!-- Targets Config -->
        <div class="mt-4 p-3 bg-cream-100 rounded-lg border border-cream-300">
          <div class="text-[10px] font-semibold text-gray-500 uppercase mb-2">üéØ Sales Targets (USD)</div>
          <div class="grid grid-cols-5 gap-3">
            <div>
              <label class="text-[10px] text-gray-500">Daily</label>
              <input type="number" id="target-daily" value="100" class="w-full px-2 py-1 text-xs border rounded" onchange="updateTargets()">
            </div>
            <div>
              <label class="text-[10px] text-gray-500">Weekly</label>
              <input type="number" id="target-weekly" value="500" class="w-full px-2 py-1 text-xs border rounded" onchange="updateTargets()">
            </div>
            <div>
              <label class="text-[10px] text-gray-500">Monthly</label>
              <input type="number" id="target-monthly" value="2000" class="w-full px-2 py-1 text-xs border rounded" onchange="updateTargets()">
            </div>
          </div>
        </div>
      </div>

      <!-- Add Lead Modal -->
      <div id="lead-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
          <h3 class="font-bold text-lg mb-4">Add New Lead</h3>
          <div class="space-y-3">
            <input type="text" id="lead-name" placeholder="Name / Company" class="w-full px-3 py-2 border rounded">
            <input type="text" id="lead-contact" placeholder="Email / Telegram / Phone" class="w-full px-3 py-2 border rounded">
            <select id="lead-product" class="w-full px-3 py-2 border rounded">
              <option value="">Interested in...</option>
            </select>
            <textarea id="lead-notes" placeholder="Notes..." class="w-full px-3 py-2 border rounded h-20"></textarea>
          </div>
          <div class="flex gap-2 mt-4">
            <button onclick="saveLead()" class="flex-1 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Lead</button>
            <button onclick="closeLeadModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Add Order Modal -->
      <div id="order-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
          <h3 class="font-bold text-lg mb-4">Record New Sale</h3>
          <div class="space-y-3">
            <input type="text" id="order-customer" placeholder="Customer Name" class="w-full px-3 py-2 border rounded">
            <select id="order-product" class="w-full px-3 py-2 border rounded">
              <option value="">Select Product...</option>
            </select>
            <input type="number" id="order-amount" placeholder="Amount (USD)" class="w-full px-3 py-2 border rounded">
            <textarea id="order-notes" placeholder="Notes..." class="w-full px-3 py-2 border rounded h-20"></textarea>
          </div>
          <div class="flex gap-2 mt-4">
            <button onclick="saveOrder()" class="flex-1 py-2 bg-green-500 text-white rounded hover:bg-green-600">Record Sale</button>
            <button onclick="closeOrderModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
          </div>
        </div>
      </div>

      <!-- ANALYTICS Department Panel -->
      <div id="analytics-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üìä Analytics Dashboard</h3>
          <button onclick="refreshAnalytics()" class="px-3 py-1.5 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 transition-colors">üîÑ Refresh</button>
        </div>

        <!-- PnL Summary -->
        <div class="grid grid-cols-4 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div id="analytics-total-pnl" class="text-2xl font-bold text-green-600">$0</div>
            <div class="text-[10px] text-gray-500">Total PnL</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div id="analytics-today-pnl" class="text-2xl font-bold text-blue-600">$0</div>
            <div class="text-[10px] text-gray-500">Today</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-purple-200 text-center">
            <div id="analytics-trades" class="text-2xl font-bold text-purple-600">0</div>
            <div class="text-[10px] text-gray-500">Total Trades</div>
          </div>
          <div class="bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-lg p-4 text-center text-white">
            <div id="analytics-winrate" class="text-2xl font-bold">0%</div>
            <div class="text-[10px] opacity-80">Win Rate</div>
          </div>
        </div>

        <!-- Win/Loss -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-green-200">
            <div class="text-[10px] font-semibold text-green-600 uppercase mb-2">‚úÖ Wins</div>
            <div id="analytics-wins" class="text-3xl font-bold text-green-600">0</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-red-200">
            <div class="text-[10px] font-semibold text-red-600 uppercase mb-2">‚ùå Losses</div>
            <div id="analytics-losses" class="text-3xl font-bold text-red-600">0</div>
          </div>
        </div>

        <!-- Bot Performance -->
        <div class="bg-white rounded-lg p-4 border border-indigo-200 mb-4">
          <div class="text-[10px] font-semibold text-indigo-600 uppercase mb-3">ü§ñ Bot Performance</div>
          <div id="analytics-bots" class="space-y-2">
            <div class="text-gray-400 text-xs">Loading...</div>
          </div>
        </div>

        <!-- Recent Trades -->
        <div class="bg-white rounded-lg p-4 border border-gray-200">
          <div class="text-[10px] font-semibold text-gray-600 uppercase mb-3">üìã Recent Trades</div>
          <div id="analytics-trades-list" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-gray-400 text-xs">No trades recorded</div>
          </div>
        </div>
      </div>

      <!-- SCHEDULER Department Panel -->
      <div id="scheduler-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">‚è∞ Scheduler & Cron Jobs</h3>
          <button onclick="refreshScheduler()" class="px-3 py-1.5 bg-teal-500 text-white rounded text-xs hover:bg-teal-600 transition-colors">üîÑ Refresh</button>
        </div>

        <!-- Jobs Summary -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div id="scheduler-active" class="text-2xl font-bold text-green-600">0</div>
            <div class="text-[10px] text-gray-500">Active Jobs</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-gray-200 text-center">
            <div id="scheduler-disabled" class="text-2xl font-bold text-gray-500">0</div>
            <div class="text-[10px] text-gray-500">Disabled</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div id="scheduler-total" class="text-2xl font-bold text-blue-600">0</div>
            <div class="text-[10px] text-gray-500">Total Jobs</div>
          </div>
        </div>

        <!-- Cron Jobs List -->
        <div class="bg-white rounded-lg p-4 border border-teal-200">
          <div class="text-[10px] font-semibold text-teal-600 uppercase mb-3">üìã Cron Jobs</div>
          <div id="scheduler-jobs" class="space-y-2">
            <div class="text-gray-400 text-xs">Loading...</div>
          </div>
        </div>
      </div>

      <!-- CONTENT Department Panel -->
      <div id="content-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">‚úçÔ∏è Content Hub</h3>
          <div class="flex gap-2">
            <button onclick="refreshContent()" class="px-3 py-1.5 bg-pink-500 text-white rounded text-xs hover:bg-pink-600 transition-colors">üîÑ Refresh</button>
            <button onclick="addContentIdea()" class="px-3 py-1.5 bg-purple-500 text-white rounded text-xs hover:bg-purple-600 transition-colors">+ Idea</button>
          </div>
        </div>

        <!-- Content Stats -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-blue-200 text-center">
            <div id="content-total" class="text-2xl font-bold text-blue-600">0</div>
            <div class="text-[10px] text-gray-500">Total Posts</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-yellow-200 text-center">
            <div id="content-scheduled" class="text-2xl font-bold text-yellow-600">0</div>
            <div class="text-[10px] text-gray-500">Scheduled</div>
          </div>
          <div class="bg-white rounded-lg p-4 border border-green-200 text-center">
            <div id="content-published" class="text-2xl font-bold text-green-600">0</div>
            <div class="text-[10px] text-gray-500">Published</div>
          </div>
        </div>

        <!-- Content Ideas -->
        <div class="bg-white rounded-lg p-4 border border-purple-200 mb-4">
          <div class="text-[10px] font-semibold text-purple-600 uppercase mb-3">üí° Content Ideas</div>
          <div id="content-ideas" class="space-y-2 max-h-32 overflow-y-auto">
            <div class="text-gray-400 text-xs">No ideas yet. Click "+ Idea" to add one.</div>
          </div>
        </div>

        <!-- Recent Posts -->
        <div class="bg-white rounded-lg p-4 border border-pink-200">
          <div class="text-[10px] font-semibold text-pink-600 uppercase mb-3">üìù Recent Posts</div>
          <div id="content-posts" class="space-y-2 max-h-48 overflow-y-auto">
            <div class="text-gray-400 text-xs">No posts yet</div>
          </div>
        </div>
      </div>

      <!-- COMMUNITY Department Panel -->
      <div id="community-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üì± Community Hub</h3>
          <button onclick="refreshCommunity()" class="px-3 py-1.5 bg-cyan-500 text-white rounded text-xs hover:bg-cyan-600 transition-colors">üîÑ Refresh</button>
        </div>

        <!-- Platform Stats -->
        <div class="grid grid-cols-2 gap-4 mb-4">
          <!-- Twitter -->
          <div class="bg-white rounded-lg p-4 border border-blue-300">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-xl">üê¶</span>
              <span class="font-medium text-blue-600">Twitter/X</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-center">
              <div>
                <div id="twitter-followers" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Followers</div>
              </div>
              <div>
                <div id="twitter-tweets" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Tweets</div>
              </div>
            </div>
          </div>

          <!-- Telegram -->
          <div class="bg-white rounded-lg p-4 border border-blue-400">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-xl">üì±</span>
              <span class="font-medium text-blue-500">Telegram</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-center">
              <div>
                <div id="telegram-members" class="text-xl font-bold text-gray-700">1</div>
                <div class="text-[10px] text-gray-500">Members</div>
              </div>
              <div>
                <div id="telegram-messages" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Messages</div>
              </div>
            </div>
          </div>

          <!-- Farcaster -->
          <div class="bg-white rounded-lg p-4 border border-purple-300">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-xl">üü£</span>
              <span class="font-medium text-purple-600">Farcaster</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-center">
              <div>
                <div id="farcaster-followers" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Followers</div>
              </div>
              <div>
                <div id="farcaster-casts" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Casts</div>
              </div>
            </div>
          </div>

          <!-- Discord -->
          <div class="bg-white rounded-lg p-4 border border-indigo-300">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-xl">üí¨</span>
              <span class="font-medium text-indigo-600">Discord</span>
            </div>
            <div class="grid grid-cols-2 gap-2 text-center">
              <div>
                <div id="discord-members" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Members</div>
              </div>
              <div>
                <div id="discord-online" class="text-xl font-bold text-gray-700">0</div>
                <div class="text-[10px] text-gray-500">Online</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Engagement -->
        <div class="bg-white rounded-lg p-4 border border-orange-200">
          <div class="text-[10px] font-semibold text-orange-600 uppercase mb-3">üìà Engagement (All Platforms)</div>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div>
              <div id="engagement-likes" class="text-2xl font-bold text-red-500">0</div>
              <div class="text-[10px] text-gray-500">‚ù§Ô∏è Likes</div>
            </div>
            <div>
              <div id="engagement-retweets" class="text-2xl font-bold text-green-500">0</div>
              <div class="text-[10px] text-gray-500">üîÑ Retweets</div>
            </div>
            <div>
              <div id="engagement-replies" class="text-2xl font-bold text-blue-500">0</div>
              <div class="text-[10px] text-gray-500">üí¨ Replies</div>
            </div>
          </div>
        </div>
      </div>

      <!-- DESIGN Department Panel -->
      <div id="design-panel" class="view-hidden flex-1 overflow-auto p-4 bg-cream-50">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-medium text-gray-800">üé® Design Studio</h3>
          <button onclick="refreshDesign()" class="px-3 py-1.5 bg-pink-500 text-white rounded text-xs hover:bg-pink-600 transition-colors">üîÑ Refresh</button>
        </div>

        <!-- Templates -->
        <div class="bg-white rounded-lg p-4 border border-pink-200 mb-4">
          <div class="text-[10px] font-semibold text-pink-600 uppercase mb-3">üìê Templates</div>
          <div id="design-templates" class="grid grid-cols-5 gap-3">
            <div class="text-gray-400 text-xs">Loading...</div>
          </div>
        </div>

        <!-- Assets -->
        <div class="bg-white rounded-lg p-4 border border-purple-200">
          <div class="text-[10px] font-semibold text-purple-600 uppercase mb-3">üñºÔ∏è Assets</div>
          <div id="design-assets" class="grid grid-cols-5 gap-3">
            <div class="text-gray-400 text-xs">No assets yet</div>
          </div>
        </div>
      </div>
      
    </main>
    
    <!-- Right Sidebar - TASKS (Vertical Kanban) -->
    <aside class="w-52 bg-white border-l border-cream-300 flex flex-col overflow-hidden">
      <div class="px-3 py-2 border-b border-cream-200 flex items-center justify-end flex-shrink-0">
        <span class="section-title">TASKS</span>
      </div>
      
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- INBOX -->
        <div class="flex-1 flex flex-col border-b border-cream-200 min-h-0">
          <div class="px-3 py-1.5 bg-cream-50 flex items-center gap-2 flex-shrink-0">
            <span class="status-dot status-idle"></span>
            <span class="text-[10px] font-semibold text-gray-500 uppercase">Inbox</span>
            <span id="col-inbox-count" class="text-[10px] text-gray-400 ml-auto">0</span>
          </div>
          <div id="col-inbox" class="column-drop flex-1 overflow-y-auto scrollbar-thin p-1.5 space-y-1 bg-white" data-status="inbox"></div>
        </div>

        <!-- ASSIGNED -->
        <div class="flex-1 flex flex-col border-b border-cream-200 min-h-0">
          <div class="px-3 py-1.5 bg-cream-50 flex items-center gap-2 flex-shrink-0">
            <span class="status-dot" style="background:#8B5CF6"></span>
            <span class="text-[10px] font-semibold text-gray-500 uppercase">Assigned</span>
            <span id="col-assigned-count" class="text-[10px] text-gray-400 ml-auto">0</span>
          </div>
          <div id="col-assigned" class="column-drop flex-1 overflow-y-auto scrollbar-thin p-1.5 space-y-1 bg-white" data-status="assigned"></div>
        </div>

        <!-- IN PROGRESS -->
        <div class="flex-1 flex flex-col border-b border-cream-200 min-h-0">
          <div class="px-3 py-1.5 bg-cream-50 flex items-center gap-2 flex-shrink-0">
            <span class="status-dot status-active"></span>
            <span class="text-[10px] font-semibold text-gray-500 uppercase">In Progress</span>
            <span id="col-progress-count" class="text-[10px] text-gray-400 ml-auto">0</span>
          </div>
          <div id="col-progress" class="column-drop flex-1 overflow-y-auto scrollbar-thin p-1.5 space-y-1 bg-white" data-status="progress"></div>
        </div>

        <!-- REVIEW -->
        <div class="flex-1 flex flex-col border-b border-cream-200 min-h-0">
          <div class="px-3 py-1.5 bg-cream-50 flex items-center gap-2 flex-shrink-0">
            <span class="status-dot" style="background:#F59E0B"></span>
            <span class="text-[10px] font-semibold text-gray-500 uppercase">Review</span>
            <span id="col-review-count" class="text-[10px] text-gray-400 ml-auto">0</span>
          </div>
          <div id="col-review" class="column-drop flex-1 overflow-y-auto scrollbar-thin p-1.5 space-y-1 bg-white" data-status="review"></div>
        </div>

        <!-- DONE -->
        <div class="flex-1 flex flex-col min-h-0">
          <div class="px-3 py-1.5 bg-cream-50 flex items-center gap-2 flex-shrink-0">
            <span class="status-dot" style="background:#10B981"></span>
            <span class="text-[10px] font-semibold text-gray-500 uppercase">Done</span>
            <span id="col-done-count" class="text-[10px] text-gray-400 ml-auto">0</span>
          </div>
          <div id="col-done" class="column-drop flex-1 overflow-y-auto scrollbar-thin p-1.5 space-y-1 bg-white" data-status="done"></div>
        </div>
      </div>
    </aside>
  </main>
    
  <!-- Hidden elements for JS compatibility -->
  <div id="agent-pills" class="hidden"></div>
  <div id="live-feed" class="hidden"></div>
  <span id="msg-agent-name" class="hidden"></span>
  <span id="sidebar-task-count" class="hidden"></span>
  <span id="mini-inbox-count" class="hidden"></span>
  <span id="mini-assigned-count" class="hidden"></span>
  <span id="mini-progress-count" class="hidden"></span>
  <span id="mini-done-count" class="hidden"></span>
  <div id="mini-inbox" class="hidden"></div>
  <div id="mini-assigned" class="hidden"></div>
  <div id="mini-progress" class="hidden"></div>
  <div id="mini-done" class="hidden"></div>

  <!-- Modals -->
  <div id="spawn-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-96">
      <h3 class="text-lg font-bold mb-4">üöÄ Spawn Agent Task</h3>
      <div class="space-y-3">
        <input id="spawn-label" class="w-full border border-cream-300 rounded px-3 py-2 text-sm" placeholder="Label (optional)">
        <textarea id="spawn-task" rows="4" class="w-full border border-cream-300 rounded px-3 py-2 text-sm" placeholder="Task description..."></textarea>
        <select id="spawn-model" class="w-full border border-cream-300 rounded px-3 py-2 text-sm">
          <option value="sonnet">Sonnet</option>
          <option value="opus">Opus</option>
        </select>
      </div>
      <div class="flex gap-2 mt-4">
        <button onclick="closeModal('spawn-modal')" class="flex-1 py-2 bg-cream-200 rounded">Cancel</button>
        <button onclick="doSpawn()" class="flex-1 py-2 bg-olive-500 text-white rounded">Spawn</button>
      </div>
    </div>
  </div>

  <div id="task-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-96">
      <h3 class="text-lg font-bold mb-4">üìã New Task</h3>
      <div class="space-y-3">
        <input id="task-title" class="w-full border border-cream-300 rounded px-3 py-2 text-sm" placeholder="Task title">
        <textarea id="task-desc" rows="3" class="w-full border border-cream-300 rounded px-3 py-2 text-sm" placeholder="Description..."></textarea>
        <div>
          <label class="text-xs text-gray-500 mb-1 block">Assign to Agent</label>
          <select id="task-agent" class="w-full border border-cream-300 rounded px-3 py-2 text-sm">
            <option value="">Current agent</option>
          </select>
        </div>
        <input id="task-tags" class="w-full border border-cream-300 rounded px-3 py-2 text-sm" placeholder="Tags (comma separated)">
      </div>
      <div class="flex gap-2 mt-4">
        <button onclick="closeModal('task-modal')" class="flex-1 py-2 bg-cream-200 rounded">Cancel</button>
        <button onclick="createTask()" class="flex-1 py-2 bg-peach-500 text-white rounded">Create</button>
      </div>
    </div>
  </div>

  <div id="logs-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[700px] max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">üìú Logs</h3>
        <button onclick="closeModal('logs-modal')" class="text-gray-400 hover:text-gray-600">‚úï</button>
      </div>
      <div class="flex gap-4 flex-1 overflow-hidden">
        <div class="w-40 space-y-1 overflow-y-auto" id="logs-files"></div>
        <div class="flex-1 bg-gray-900 rounded-lg p-3 font-mono text-xs text-green-400 overflow-auto" id="logs-content">Select a log file...</div>
      </div>
    </div>
  </div>

  <div id="memory-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[700px] max-h-[80vh] flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">üß† Memory</h3>
        <button onclick="closeModal('memory-modal')" class="text-gray-400 hover:text-gray-600">‚úï</button>
      </div>
      <div class="flex gap-4 flex-1 overflow-hidden">
        <div class="w-40 space-y-1 overflow-y-auto">
          <div id="memory-files"></div>
          <button onclick="createMemoryFile()" class="text-xs text-peach-600 hover:underline mt-2">+ New file</button>
        </div>
        <div class="flex-1 flex flex-col">
          <textarea id="memory-content" class="flex-1 bg-cream-50 border border-cream-300 rounded-lg p-3 font-mono text-sm resize-none" placeholder="Select a file..."></textarea>
          <button onclick="saveMemoryFile()" class="mt-2 px-4 py-2 bg-peach-500 text-white rounded text-sm self-end">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="bots-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-[600px]">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold">ü§ñ Assigned Bots</h3>
        <button onclick="closeModal('bots-modal')" class="text-gray-400 hover:text-gray-600">‚úï</button>
      </div>
      <div id="bots-list" class="grid grid-cols-2 gap-3"></div>
    </div>
  </div>

  <script>
    const socket = io();
    let agents = [];
    let bots = [];
    let currentAgent = null;
    let currentMemoryFile = null;

    // Clock
    setInterval(() => {
      const now = new Date();
      document.getElementById('clock').textContent = now.toTimeString().slice(0, 8);
      document.getElementById('date').textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }, 1000);

    socket.on('connect', () => updateConnection(true));
    socket.on('disconnect', () => updateConnection(false));

    function updateConnection(online) {
      const el = document.getElementById('connection');
      el.innerHTML = online ? '<span class="status-dot status-active"></span> ONLINE' : '<span class="status-dot status-offline"></span> OFFLINE';
      el.className = `flex items-center gap-1.5 ${online ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} px-2.5 py-1 rounded-full text-xs font-medium`;
    }

    async function fetchAgents() {
      // Show skeleton while loading
      const grid = document.getElementById('agents-grid');
      grid.innerHTML = Array(8).fill().map(() => `
        <div class="bg-white p-md border border-cream-300 rounded-lg">
          <div class="flex items-start gap-sm mb-sm">
            <div class="skeleton w-10 h-10 rounded-lg"></div>
            <div class="flex-1">
              <div class="skeleton skeleton-text"></div>
              <div class="skeleton skeleton-text-sm"></div>
            </div>
          </div>
          <div class="skeleton skeleton-text mb-sm"></div>
          <div class="flex gap-xs">
            <div class="skeleton w-16 h-5 rounded"></div>
            <div class="skeleton w-12 h-5 rounded"></div>
          </div>
        </div>
      `).join('');
      
      const res = await fetch('/api/agents/config');
      const data = await res.json();
      agents = data.agents || [];
      renderAgentsGrid();
    }

    async function fetchBots() {
      const res = await fetch('/api/bots');
      bots = await res.json();
      renderBotsGrid();
    }

    async function fetchSystem() {
      const [sys, wallet] = await Promise.all([
        fetch('/api/system').then(r => r.json()),
        fetch('/api/wallet').then(r => r.json())
      ]);
      document.getElementById('stat-disk').textContent = sys.disk;
      document.getElementById('stat-eth').textContent = wallet.eth + ' ETH';
    }

    function renderAgentsGrid() {
      // Filter out BOSS from grid (has CEO section), hidden agents, but keep MOMO
      const deptAgents = agents.filter(a => a.id !== 'boss' && !a.hidden);
      document.getElementById('stat-agents').textContent = agents.length;
      document.getElementById('header-active').textContent = agents.filter(a => a.status === 'active').length;
      
      document.getElementById('agents-grid').innerHTML = deptAgents.map(agent => `
        <div onclick="openAgent('${agent.id}')" class="agent-card bg-white p-md border border-cream-300 relative">
          <div class="flex items-start gap-sm mb-sm">
            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg flex-shrink-0" style="background:${agent.color}12; border: 1px solid ${agent.color}25">${agent.icon}</div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-xs">
                <span class="text-body font-semibold text-gray-800">${agent.name}</span>
                <span class="badge badge-DEPT">${agent.badge}</span>
                ${agent.subAgents?.length ? `<span class="text-micro text-gray-400">(${agent.subAgents.length} sub-agents)</span>` : ''}
              </div>
              <div class="text-caption text-gray-500">${agent.role}</div>
            </div>
            <span class="status-dot ${agent.status === 'active' ? 'status-active' : 'status-idle'}"></span>
          </div>
          <p class="text-caption text-gray-500 line-clamp-1 mb-sm">${agent.description}</p>
          <div class="flex flex-wrap gap-xs mb-2">
            ${(agent.capabilities || []).slice(0, 3).map(c => `<span class="text-micro px-2 py-0.5 bg-cream-100 text-gray-600 rounded">${c}</span>`).join('')}
          </div>
          ${agent.subAgents?.length ? `
            <div class="border-t border-cream-200 pt-2 mt-2">
              <div class="text-micro font-medium text-gray-600 mb-1.5">Sub-Agents:</div>
              <div class="space-y-1">
                ${agent.subAgents.map(sub => `
                  <div class="flex items-center gap-1.5 text-[10px] text-gray-600 bg-cream-50 rounded px-2 py-1">
                    <span>${sub.icon}</span>
                    <span class="flex-1 truncate">${sub.name}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderBotsGrid() {
      const filtered = bots.filter(b => b.name !== 'momo-dashboard');
      const online = filtered.filter(b => b.status === 'online').length;
      document.getElementById('stat-bots').textContent = `${online}/${filtered.length}`;
      
      document.getElementById('bots-grid').innerHTML = filtered.map(bot => `
        <div class="bg-white rounded-lg p-3 border border-cream-300">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-sm truncate">${bot.name}</span>
            <span class="status-dot ${bot.status === 'online' ? 'status-active' : 'status-offline'}"></span>
          </div>
          <div class="text-[10px] text-gray-500 mb-2">CPU: ${bot.cpu}% ¬∑ MEM: ${(bot.memory/1024/1024).toFixed(0)}MB</div>
          <button onclick="event.stopPropagation();controlBot('${bot.status === 'online' ? 'stop' : 'start'}','${bot.name}')" 
            class="w-full text-[10px] py-1 ${bot.status === 'online' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} rounded">
            ${bot.status === 'online' ? 'Stop' : 'Start'}
          </button>
        </div>
      `).join('');
    }

    async function controlBot(action, name) {
      await fetch(`/api/bots/${action}/${name}`, { method: 'POST' });
      setTimeout(fetchBots, 1000);
    }

    async function controlAllBots(action) {
      await fetch(`/api/bots/${action}/all`, { method: 'POST' });
      setTimeout(fetchBots, 1500);
    }

    // Agent Detail View
    async function openAgent(id) {
      const res = await fetch(`/api/agents/${id}`);
      currentAgent = await res.json();
      
      document.getElementById('main-view').classList.add('view-hidden');
      document.getElementById('agent-view').classList.remove('view-hidden');
      document.getElementById('breadcrumb').innerHTML = `<span class="text-gray-400 mx-2">/</span><span class="text-peach-600 font-medium">${currentAgent.name}</span>`;
      document.getElementById('header-filter')?.classList.remove('hidden');
      document.getElementById('header-filter')?.classList.add('flex');
      const filterName = document.getElementById('filter-name');
      if (filterName) filterName.textContent = currentAgent.name;
      
      // Agent info (safe - elements may be removed)
      const agentIcon = document.getElementById('agent-icon');
      if (agentIcon) {
        agentIcon.textContent = currentAgent.icon;
        agentIcon.style.background = currentAgent.color + '20';
      }
      const agentName = document.getElementById('agent-name');
      if (agentName) agentName.textContent = currentAgent.name;
      const agentRole = document.getElementById('agent-role');
      if (agentRole) agentRole.textContent = currentAgent.role;
      const agentBadge = document.getElementById('agent-badge');
      if (agentBadge) {
        agentBadge.textContent = currentAgent.badge;
        agentBadge.className = `badge badge-${currentAgent.badge}`;
      }
      const agentDesc = document.getElementById('agent-desc');
      if (agentDesc) agentDesc.textContent = currentAgent.description;
      const msgAgentName = document.getElementById('msg-agent-name');
      if (msgAgentName) msgAgentName.textContent = currentAgent.name;
      const queueTitle = document.getElementById('queue-title');
      if (queueTitle) queueTitle.textContent = `${currentAgent.name}'s Tasks`;
      
      const statusEl = document.getElementById('agent-status');
      if (statusEl) {
        if (currentAgent.status === 'active') {
          statusEl.innerHTML = '<span class="status-dot status-active"></span> WORKING';
          statusEl.className = 'flex items-center gap-1.5 text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 w-fit';
        } else {
          statusEl.innerHTML = '<span class="status-dot status-idle"></span> IDLE';
          statusEl.className = 'flex items-center gap-1.5 text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 w-fit';
        }
      }
      
      const agentCaps = document.getElementById('agent-caps');
      if (agentCaps) {
        agentCaps.innerHTML = (currentAgent.capabilities || []).map(c => 
          `<span class="text-[10px] px-2 py-0.5 bg-cream-200 rounded">${c}</span>`
        ).join('');
      }
      
      // Team list (safe)
      const teamList = document.getElementById('team-list');
      if (teamList) {
        teamList.innerHTML = agents.filter(a => a.id !== currentAgent.id).map(a => `
          <div onclick="openAgent('${a.id}')" class="agent-item flex items-center gap-2 px-2 py-1.5 rounded cursor-pointer">
            <span class="text-sm">${a.icon}</span>
            <span class="text-xs flex-1">${a.name}</span>
            <span class="status-dot ${a.status === 'active' ? 'status-active' : 'status-idle'}"></span>
          </div>
        `).join('');
      }
      
      // Agent pills (safe)
      const agentPills = document.getElementById('agent-pills');
      if (agentPills) {
        agentPills.innerHTML = `
          <span class="pill active bg-peach-100 text-peach-600">${currentAgent.icon} ${currentAgent.name}</span>
          ${agents.filter(a => a.id !== currentAgent.id).slice(0, 4).map(a => 
            `<span class="pill bg-cream-200 text-gray-600" onclick="openAgent('${a.id}')">${a.icon} ${a.name}</span>`
          ).join('')}
        `;
      }
      
      // Show/hide department panels
      const botPanel = document.getElementById('bot-department-panel');
      const treasuryPanel = document.getElementById('treasury-panel');
      const intelPanel = document.getElementById('intel-panel');
      const creditsPanel = document.getElementById('credits-panel');
      const infraPanel = document.getElementById('infra-panel');
      const securityPanel = document.getElementById('security-panel');
      const engineerPanel = document.getElementById('engineer-panel');
      const salesPanel = document.getElementById('sales-panel');
      const analyticsPanel = document.getElementById('analytics-panel');
      const schedulerPanel = document.getElementById('scheduler-panel');
      const contentPanel = document.getElementById('content-panel');
      const communityPanel = document.getElementById('community-panel');
      const designPanel = document.getElementById('design-panel');
      const predictPanel = document.getElementById('predict-panel');
      const momoPanel = document.getElementById('momo-panel');
      const agentsCoordPanel = document.getElementById('agents-coord-panel');
      
      // Hide all panels first
      botPanel.classList.add('view-hidden');
      treasuryPanel.classList.add('view-hidden');
      intelPanel.classList.add('view-hidden');
      creditsPanel.classList.add('view-hidden');
      infraPanel.classList.add('view-hidden');
      securityPanel.classList.add('view-hidden');
      engineerPanel.classList.add('view-hidden');
      salesPanel.classList.add('view-hidden');
      analyticsPanel.classList.add('view-hidden');
      schedulerPanel.classList.add('view-hidden');
      contentPanel.classList.add('view-hidden');
      communityPanel.classList.add('view-hidden');
      designPanel.classList.add('view-hidden');
      predictPanel?.classList.add('view-hidden');
      momoPanel?.classList.add('view-hidden');
      agentsCoordPanel?.classList.add('view-hidden');
      
      // Show relevant panel
      if (currentAgent.id === 'bot') {
        botPanel.classList.remove('view-hidden');
        renderBotDeptBots();
      } else if (currentAgent.id === 'infra') {
        infraPanel.classList.remove('view-hidden');
        refreshInfra();
      } else if (currentAgent.id === 'security') {
        securityPanel.classList.remove('view-hidden');
        loadSecurityStatus();
      } else if (currentAgent.id === 'treasury') {
        treasuryPanel.classList.remove('view-hidden');
        refreshPortfolio();
      } else if (currentAgent.id === 'intel') {
        intelPanel.classList.remove('view-hidden');
        refreshIntel();
      } else if (currentAgent.id === 'credits') {
        creditsPanel.classList.remove('view-hidden');
        refreshCredits();
      } else if (currentAgent.id === 'engineer') {
        engineerPanel.classList.remove('view-hidden');
        refreshEngineer();
      } else if (currentAgent.id === 'sales') {
        salesPanel.classList.remove('view-hidden');
        refreshSales();
      } else if (currentAgent.id === 'analytics') {
        analyticsPanel.classList.remove('view-hidden');
        refreshAnalytics();
      } else if (currentAgent.id === 'scheduler') {
        schedulerPanel.classList.remove('view-hidden');
        refreshScheduler();
      } else if (currentAgent.id === 'content') {
        contentPanel.classList.remove('view-hidden');
        refreshContent();
      } else if (currentAgent.id === 'community') {
        communityPanel.classList.remove('view-hidden');
        refreshCommunity();
      } else if (currentAgent.id === 'design') {
        designPanel.classList.remove('view-hidden');
        refreshDesign();
      } else if (currentAgent.id === 'predict') {
        predictPanel?.classList.remove('view-hidden');
        refreshPredict();
      } else if (currentAgent.id === 'momo') {
        momoPanel?.classList.remove('view-hidden');
        loadMomoRules();
      } else if (currentAgent.id === 'agents-coord') {
        document.getElementById('agents-coord-panel')?.classList.remove('view-hidden');
        refreshAgentStatus();
      }
      
      loadTasks();
      loadFeed();
    }
    
    // Bot configuration with display names and groups
    const botConfig = {
      // Polymarket Group
      'polymarket-bot': { name: 'Polymarket Main', group: 'polymarket', icon: 'üé≤' },
      'btc-predictor': { name: 'BTC Predictor', group: 'polymarket', icon: '‚Çø' },
      'sports-predictor': { name: 'Sports Predictor', group: 'polymarket', icon: '‚öΩ' },
      'arb-engine': { name: 'Arb Engine', group: 'polymarket', icon: 'üìä' },
      // Snipers
      'momo-sniper': { name: 'Base Sniper', group: 'snipers', icon: 'üéØ' },
      'bsc-sniper': { name: 'BSC Sniper', group: 'snipers', icon: 'üéØ' },
      // Arbitrage
      'base-arb': { name: 'Base Arb', group: 'arbitrage', icon: 'üîÑ' },
      'polygon-arb': { name: 'Polygon Arb', group: 'arbitrage', icon: 'üîÑ' },
      'arbitrum-arb': { name: 'Arbitrum Arb', group: 'arbitrage', icon: 'üîÑ' },
      'jibchain-arb': { name: 'JibChain Arb', group: 'arbitrage', icon: 'üê±' },
      // DeFi
      'flashloan-arbitrage': { name: 'Flash Loan', group: 'defi', icon: '‚ö°' },
      'liquidation-bot': { name: 'Liquidation', group: 'defi', icon: 'üè¶' },
      // Infrastructure
      'cloudflared': { name: 'Cloudflare Tunnel', group: 'infra', icon: '‚òÅÔ∏è' },
      'momo-dashboard': { name: 'Dashboard', group: 'infra', icon: 'üìä' }
    };

    const botGroups = {
      'polymarket': { name: 'üé≤ Polymarket', bg: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-700', badge: 'bg-indigo-100 text-indigo-600' },
      'snipers': { name: 'üéØ Snipers', bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-700', badge: 'bg-orange-100 text-orange-600' },
      'arbitrage': { name: 'üîÑ Arbitrage', bg: 'bg-cyan-50', border: 'border-cyan-200', text: 'text-cyan-700', badge: 'bg-cyan-100 text-cyan-600' },
      'defi': { name: 'üè¶ DeFi', bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', badge: 'bg-green-100 text-green-600' },
      'infra': { name: 'üîß Infrastructure', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-700', badge: 'bg-gray-100 text-gray-600' }
    };

    function renderBotDeptBots() {
      const filtered = bots.filter(b => b.name !== 'momo-dashboard');
      
      // Update summary stats
      const online = filtered.filter(b => b.status === 'online').length;
      const offline = filtered.filter(b => b.status !== 'online').length;
      const totalCpu = filtered.reduce((sum, b) => sum + (b.cpu || 0), 0);
      const totalMem = filtered.reduce((sum, b) => sum + (b.memory || 0), 0) / 1024 / 1024;
      
      document.getElementById('bots-online').textContent = online;
      document.getElementById('bots-offline').textContent = offline;
      document.getElementById('bots-cpu').textContent = totalCpu.toFixed(0) + '%';
      document.getElementById('bots-mem').textContent = totalMem.toFixed(0);
      
      // Group bots
      const grouped = {};
      filtered.forEach(bot => {
        const config = botConfig[bot.name] || { name: bot.name, group: 'other', icon: 'ü§ñ' };
        if (!grouped[config.group]) grouped[config.group] = [];
        grouped[config.group].push({ ...bot, config });
      });
      
      // Render grouped
      const groupOrder = ['polymarket', 'snipers', 'arbitrage', 'defi', 'infra', 'other'];
      let html = '';
      
      groupOrder.forEach(groupKey => {
        if (!grouped[groupKey] || grouped[groupKey].length === 0) return;
        
        const group = botGroups[groupKey] || { name: 'üì¶ Other', bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-700', badge: 'bg-gray-100 text-gray-600' };
        const groupBots = grouped[groupKey];
        const onlineCount = groupBots.filter(b => b.status === 'online').length;
        
        html += `
          <div class="bg-white rounded-lg ${group.border} border overflow-hidden">
            <div class="${group.bg} px-4 py-2 ${group.border} border-b flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="font-medium ${group.text}">${group.name}</span>
                <span class="text-xs px-2 py-0.5 rounded-full ${group.badge}">${onlineCount}/${groupBots.length} online</span>
              </div>
              <div class="flex gap-1">
                <button onclick="controlGroupBots('start', '${groupKey}')" class="px-2 py-1 bg-green-500 text-white rounded text-[10px] hover:bg-green-600" title="Start All ${group.name}">‚ñ∂</button>
                <button onclick="controlGroupBots('stop', '${groupKey}')" class="px-2 py-1 bg-red-500 text-white rounded text-[10px] hover:bg-red-600" title="Stop All ${group.name}">‚èπ</button>
              </div>
            </div>
            <div class="p-3 grid grid-cols-5 gap-3">
              ${groupBots.map(bot => `
                <div class="bg-cream-50 rounded-lg p-3 border border-cream-200">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span>${bot.config.icon}</span>
                      <span class="font-medium text-sm">${bot.config.name}</span>
                    </div>
                    <span class="status-dot ${bot.status === 'online' ? 'status-active' : 'status-offline'}"></span>
                  </div>
                  <div class="text-[10px] text-gray-400 mb-2">
                    CPU: ${bot.cpu || 0}% ¬∑ RAM: ${((bot.memory || 0)/1024/1024).toFixed(0)}MB
                    ${bot.restarts > 0 ? `¬∑ ‚Üª${bot.restarts}` : ''}
                  </div>
                  <div class="flex gap-1">
                    <button onclick="event.stopPropagation();controlBot('${bot.status === 'online' ? 'stop' : 'start'}','${bot.name}')" 
                      class="flex-1 text-[10px] py-1.5 ${bot.status === 'online' ? 'bg-red-400 hover:bg-red-500' : 'bg-green-400 hover:bg-green-500'} text-white rounded font-medium transition-colors">
                      ${bot.status === 'online' ? '‚èπ Stop' : '‚ñ∂ Start'}
                    </button>
                    <button onclick="event.stopPropagation();controlBot('restart','${bot.name}')" 
                      class="px-2 py-1.5 bg-blue-400 hover:bg-blue-500 text-white rounded text-[10px] transition-colors" title="Restart">
                      üîÑ
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      document.getElementById('bot-dept-bots').innerHTML = html || '<div class="text-gray-400 text-center py-8">No bots found</div>';
    }

    async function controlGroupBots(action, groupKey) {
      const groupBots = bots.filter(b => {
        const config = botConfig[b.name];
        return config && config.group === groupKey;
      });
      
      showToast(`${action === 'start' ? 'Starting' : 'Stopping'} ${groupBots.length} bots...`);
      
      for (const bot of groupBots) {
        if ((action === 'start' && bot.status !== 'online') || (action === 'stop' && bot.status === 'online')) {
          await controlBot(action, bot.name);
        }
      }
    }

    async function startAllBots() {
      const offlineBots = bots.filter(b => b.status !== 'online' && b.name !== 'momo-dashboard');
      showToast(`Starting ${offlineBots.length} bots...`);
      for (const bot of offlineBots) {
        await controlBot('start', bot.name);
      }
    }

    async function stopAllBots() {
      const onlineBots = bots.filter(b => b.status === 'online' && b.name !== 'momo-dashboard');
      showToast(`Stopping ${onlineBots.length} bots...`);
      for (const bot of onlineBots) {
        await controlBot('stop', bot.name);
      }
    }

    // TREASURY Portfolio
    async function refreshPortfolio() {
      try {
        const [walletRes, polygonRes, jibRes] = await Promise.all([
          fetch('/api/wallet').then(r => r.json()),
          fetch('/api/portfolio/polygon').then(r => r.json()).catch(() => ({ totalUsd: 50, tokens: [] })),
          fetch('/api/portfolio/jibchain').then(r => r.json()).catch(() => ({ totalUsd: 0, tokens: [] }))
        ]);
        
        const ethVal = parseFloat(walletRes.eth) || 0;
        const ethPrice = 2500; // Approximate
        const baseUsd = ethVal * ethPrice;
        const totalUsd = baseUsd + (polygonRes.totalUsd || 0) + (jibRes.totalUsd || 0);
        
        document.getElementById('portfolio-total').textContent = '$' + totalUsd.toFixed(2);
        document.getElementById('portfolio-base').textContent = ethVal.toFixed(4) + ' ETH';
        document.getElementById('portfolio-polygon').textContent = (polygonRes.tokens?.find(t => t.symbol === 'USDC')?.balance || 50).toFixed(0) + ' USDC';
        document.getElementById('portfolio-jib').textContent = (jibRes.tokens?.find(t => t.symbol === 'JBC')?.balance || 0).toFixed(0) + ' JBC';
      } catch (e) {
        console.error('Portfolio error:', e);
      }
    }

    // ============================================================================
    // MULTI-AGENT COORDINATION
    // ============================================================================
    let agentLoopRunning = false;
    
    async function refreshAgentStatus() {
      try {
        const res = await fetch('/api/coordination/status');
        if (!res.ok) return;
        const data = await res.json();
        
        const container = document.getElementById('agent-cards');
        if (!container) return;
        
        container.innerHTML = data.agents.map(agent => `
          <div class="bg-white rounded-lg p-3 border-2 ${agent.status === 'working' ? 'border-violet-400 animate-pulse' : 'border-gray-200'} hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xl">${agent.name.split(' ')[0]}</span>
              <span class="status-dot ${agent.status === 'working' ? 'status-active' : 'status-idle'}"></span>
            </div>
            <div class="text-xs font-medium text-gray-700 truncate">${agent.name.split(' ').slice(1).join(' ')}</div>
            <div class="text-[10px] text-gray-500 truncate mt-1">${agent.currentTask || 'Idle'}</div>
          </div>
        `).join('');
      } catch (e) {
        console.log('Agent status error:', e);
      }
    }
    
    async function assignAgentTask() {
      const agentId = document.getElementById('task-agent').value;
      const task = document.getElementById('task-input').value.trim();
      if (!task) return;
      
      try {
        const res = await fetch('/api/coordination/task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agentId, task })
        });
        const data = await res.json();
        
        document.getElementById('task-input').value = '';
        addAgentActivity(`üìã Task assigned to ${agentId}: ${task.substring(0, 50)}...`);
        refreshAgentStatus();
      } catch (e) {
        addAgentActivity(`‚ùå Error: ${e.message}`);
      }
    }
    
    function addAgentActivity(message) {
      const feed = document.getElementById('agent-activity-feed');
      if (!feed) return;
      
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'flex items-start gap-2 text-gray-600 py-1 border-b border-gray-100';
      entry.innerHTML = `<span class="text-gray-400 text-[10px]">${time}</span><span class="flex-1">${message}</span>`;
      
      // Remove placeholder if exists
      const placeholder = feed.querySelector('.text-center');
      if (placeholder) placeholder.remove();
      
      feed.insertBefore(entry, feed.firstChild);
      
      // Keep only last 20 entries
      while (feed.children.length > 20) {
        feed.lastChild.remove();
      }
    }
    
    async function toggleAgentLoop() {
      const btn = document.getElementById('agent-loop-btn');
      const action = agentLoopRunning ? 'stop' : 'start';
      
      try {
        await fetch(`/api/coordination/loop/${action}`, { method: 'POST' });
        agentLoopRunning = !agentLoopRunning;
        btn.textContent = agentLoopRunning ? '‚èπÔ∏è Stop Loop' : '‚ñ∂Ô∏è Start Loop';
        btn.className = agentLoopRunning 
          ? 'px-3 py-1.5 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-colors'
          : 'px-3 py-1.5 bg-violet-500 text-white rounded text-xs hover:bg-violet-600 transition-colors';
        addAgentActivity(agentLoopRunning ? 'üîÑ Work loop started' : '‚èπÔ∏è Work loop stopped');
      } catch (e) {
        console.error('Loop toggle error:', e);
      }
    }
    
    // Real-time agent updates via Socket.IO
    socket.on('agent:updated', (agent) => {
      refreshAgentStatus();
      addAgentActivity(`${agent.name} ‚Üí ${agent.status}`);
    });
    
    socket.on('task:created', (task) => {
      addAgentActivity(`üìã New task for ${task.agentId}`);
    });
    
    socket.on('proposal:created', (proposal) => {
      addAgentActivity(`üìù Proposal: ${proposal.title}`);
    });
    
    socket.on('agent:task-completed', (data) => {
      refreshAgentStatus();
      addAgentActivity(`‚úÖ ${data.agentId}: ${data.result.substring(0, 80)}`);
    });

    // ============================================================================

    // INTEL Research
    async function refreshIntel() {
      try {
        // Prices
        const prices = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd').then(r => r.json()).catch(() => ({}));
        document.getElementById('intel-btc').textContent = '$' + (prices.bitcoin?.usd || 0).toLocaleString();
        document.getElementById('intel-eth').textContent = '$' + (prices.ethereum?.usd || 0).toLocaleString();
        
        // Trending
        const trending = await fetch('https://api.coingecko.com/api/v3/search/trending').then(r => r.json()).catch(() => ({ coins: [] }));
        const top3 = trending.coins?.slice(0, 3).map(c => c.item.symbol).join(', ') || 'N/A';
        document.getElementById('intel-trending').textContent = top3;
        
        // Airdrops (static for now)
        document.getElementById('intel-airdrops').innerHTML = `
          <div class="flex justify-between"><span>LayerZero</span><span class="text-red-500">üî•</span></div>
          <div class="flex justify-between"><span>zkSync</span><span class="text-orange-500">‚ö°</span></div>
          <div class="flex justify-between"><span>Scroll</span><span class="text-yellow-500">üìå</span></div>
        `;
        
        // Polymarket
        const poly = await fetch('/api/intel/polymarket').then(r => r.json()).catch(() => ({ markets: [] }));
        document.getElementById('intel-polymarket').innerHTML = (poly.markets || []).slice(0, 3).map(m => `
          <div class="truncate" title="${m.question}">${m.question.slice(0, 30)}...</div>
        `).join('') || '<div class="text-gray-400">No data</div>';
      } catch (e) {
        console.error('Intel error:', e);
      }
    }

    // CREDITS Management - Anthropic-style Dashboard
    let creditsCurrentMonth = new Date(); // Current viewing month
    let creditsCache = {}; // Cache monthly data
    
    async function refreshCredits() {
      try {
        const year = creditsCurrentMonth.getFullYear();
        const month = creditsCurrentMonth.getMonth();
        const cacheKey = `${year}-${month}`;
        
        // Update month label
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        document.getElementById('credits-month-label').textContent = `${monthNames[month]} ${year}`;
        
        // Fetch or use cached data
        let res;
        if (creditsCache[cacheKey]) {
          res = creditsCache[cacheKey];
        } else {
          res = await fetch(`/api/credits?year=${year}&month=${month + 1}`).then(r => r.json()).catch(() => ({}));
          creditsCache[cacheKey] = res;
        }
        
        // Update totals
        document.getElementById('credits-total').textContent = '$' + (res.totalCost || 0).toFixed(2);
        document.getElementById('credits-subagent').textContent = '$' + (res.subAgentCost || res.sonnetCost || 0).toFixed(2);
        document.getElementById('credits-cache').textContent = '$' + (res.cacheSavings || 0).toFixed(2);
        
        // Update donut chart
        const total = res.totalCost || 1;
        const opusPct = ((res.opusCost || 0) / total * 100);
        const sonnetPct = ((res.sonnetCost || 0) / total * 100);
        
        document.getElementById('donut-opus').setAttribute('stroke-dasharray', `${opusPct} ${100 - opusPct}`);
        document.getElementById('donut-sonnet').setAttribute('stroke-dasharray', `${sonnetPct} ${100 - sonnetPct}`);
        document.getElementById('donut-sonnet').setAttribute('stroke-dashoffset', 25 - opusPct);
        
        // Update bar chart
        renderCreditsChart(res.dailyCosts || [], year, month);
      } catch (e) {
        console.error('Credits error:', e);
        renderCreditsChart([], creditsCurrentMonth.getFullYear(), creditsCurrentMonth.getMonth());
      }
    }
    
    function changeCreditsMonth(delta) {
      creditsCurrentMonth.setMonth(creditsCurrentMonth.getMonth() + delta);
      // Don't go into future
      const now = new Date();
      if (creditsCurrentMonth > now) {
        creditsCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      }
      refreshCredits();
    }
    
    function renderCreditsChart(dailyCosts, year, month) {
      const barsContainer = document.getElementById('credits-bars');
      const xAxisContainer = document.getElementById('credits-x-axis');
      const monthTotalEl = document.getElementById('credits-month-total');
      
      // Get days in month
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      const isCurrentMonth = (year === today.getFullYear() && month === today.getMonth());
      const maxDay = isCurrentMonth ? today.getDate() : daysInMonth;
      
      // Create data for each day of the month
      const monthData = [];
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${day}`;
        const existing = dailyCosts.find(d => {
          const dayNum = parseInt(d.date?.split(' ')[1] || d.day || 0);
          return dayNum === day;
        });
        
        if (existing) {
          monthData.push({ day, opus: existing.opus || 0, sonnet: existing.sonnet || 0 });
        } else if (day <= maxDay) {
          // Generate estimated data for past days
          monthData.push({
            day,
            opus: 80 + Math.random() * 100,
            sonnet: 5 + Math.random() * 25
          });
        } else {
          // Future days - no data
          monthData.push({ day, opus: 0, sonnet: 0, future: true });
        }
      }
      
      // Calculate month total
      const monthTotal = monthData.reduce((sum, d) => sum + (d.opus || 0) + (d.sonnet || 0), 0);
      monthTotalEl.textContent = `Month total: $${monthTotal.toFixed(2)}`;
      
      // Find max for scaling
      const maxVal = Math.max(...monthData.map(d => (d.opus || 0) + (d.sonnet || 0)), 200);
      const chartHeight = 220; // px
      
      // Update Y-axis
      const yAxis = document.getElementById('credits-y-axis');
      const yMax = Math.ceil(maxVal / 50) * 50;
      yAxis.innerHTML = '';
      [yMax, yMax * 0.75, yMax * 0.5, yMax * 0.25, 0].forEach(val => {
        const span = document.createElement('span');
        span.textContent = '$' + Math.round(val);
        yAxis.appendChild(span);
      });
      
      // Render bars
      barsContainer.innerHTML = '';
      xAxisContainer.innerHTML = '';
      
      monthData.forEach(dayData => {
        const opusHeightPx = ((dayData.opus || 0) / yMax) * chartHeight;
        const sonnetHeightPx = ((dayData.sonnet || 0) / yMax) * chartHeight;
        
        const barWrapper = document.createElement('div');
        barWrapper.className = 'flex-1 flex flex-col items-center justify-end';
        barWrapper.style.height = chartHeight + 'px';
        
        if (dayData.future) {
          barWrapper.innerHTML = `<div class="w-full max-w-[20px] h-1 bg-gray-300 rounded-t opacity-30"></div>`;
        } else if ((dayData.opus || 0) + (dayData.sonnet || 0) === 0) {
          barWrapper.innerHTML = `<div class="w-full max-w-[20px] h-1 bg-gray-300 rounded-t opacity-50"></div>`;
        } else {
          barWrapper.innerHTML = `
            <div class="w-full max-w-[20px] flex flex-col-reverse rounded-t overflow-hidden cursor-pointer hover:opacity-80 transition-opacity" 
                 title="Day ${dayData.day}&#10;Opus: $${(dayData.opus || 0).toFixed(2)}&#10;Sonnet: $${(dayData.sonnet || 0).toFixed(2)}">
              <div class="bg-pink-400 w-full" style="height: ${opusHeightPx}px"></div>
              <div class="bg-orange-400 w-full" style="height: ${sonnetHeightPx}px"></div>
            </div>
          `;
        }
        barsContainer.appendChild(barWrapper);
        
        // Show label every 5 days or first/last
        const label = document.createElement('span');
        label.className = 'flex-1 text-center';
        if (dayData.day === 1 || dayData.day % 5 === 0 || dayData.day === daysInMonth) {
          label.textContent = dayData.day;
        }
        xAxisContainer.appendChild(label);
      });
    }

    // INFRA Infrastructure Monitor
    let infraAutoRefreshInterval = null;
    let cpuHistory = [];
    
    function toggleInfraAutoRefresh() {
      const btn = document.getElementById('infra-auto-btn');
      if (infraAutoRefreshInterval) {
        clearInterval(infraAutoRefreshInterval);
        infraAutoRefreshInterval = null;
        btn.textContent = '‚è∞ Auto: OFF';
        btn.className = 'px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors';
        showToast('Auto-refresh disabled');
      } else {
        infraAutoRefreshInterval = setInterval(refreshInfra, 10000);
        btn.textContent = '‚öôÔ∏è Auto: ON';
        btn.className = 'px-3 py-1.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors';
        showToast('Auto-refresh enabled (10s)');
      }
    }
    
    function checkInfraAlerts(cpu, mem, disk, temp) {
      const alerts = [];
      const cpuThreshold = parseInt(document.getElementById('alert-cpu')?.value) || 80;
      const memThreshold = parseInt(document.getElementById('alert-mem')?.value) || 80;
      const diskThreshold = parseInt(document.getElementById('alert-disk')?.value) || 90;
      const tempThreshold = parseInt(document.getElementById('alert-temp')?.value) || 70;
      
      if (cpu > cpuThreshold) alerts.push(`CPU ${cpu}% > ${cpuThreshold}%`);
      if (mem > memThreshold) alerts.push(`Memory ${mem}% > ${memThreshold}%`);
      if (disk > diskThreshold) alerts.push(`Disk ${disk}% > ${diskThreshold}%`);
      if (temp && temp > tempThreshold) alerts.push(`Temp ${temp}¬∞C > ${tempThreshold}¬∞C`);
      
      const alertBanner = document.getElementById('infra-alerts');
      if (alerts.length > 0) {
        alertBanner.classList.remove('hidden');
        document.getElementById('infra-alert-text').textContent = alerts.join(' | ');
      } else {
        alertBanner.classList.add('hidden');
      }
    }
    
    function updateCpuHistoryChart(cpuPercent) {
      cpuHistory.push(cpuPercent);
      if (cpuHistory.length > 360) cpuHistory.shift(); // 1 hour at 10s intervals
      
      const chart = document.getElementById('cpu-history-chart');
      if (chart) {
        chart.innerHTML = cpuHistory.map(v => {
          const color = v > 80 ? 'bg-red-500' : v > 50 ? 'bg-yellow-500' : 'bg-teal-500';
          return `<div class="flex-1 ${color} rounded-t transition-all" style="height: ${Math.max(v, 2)}%"></div>`;
        }).join('');
      }
    }
    
    async function refreshInfra() {
      try {
        const sysRes = await fetch('/api/system/detailed').then(r => r.json()).catch(() => ({}));
        
        // CPU Donut
        const cpuPercent = sysRes.cpu || 0;
        document.getElementById('cpu-percent').textContent = cpuPercent + '%';
        document.getElementById('cpu-donut').setAttribute('stroke-dasharray', `${cpuPercent}, 100`);
        document.getElementById('cpu-donut').setAttribute('stroke', cpuPercent > 80 ? '#EF4444' : cpuPercent > 50 ? '#F59E0B' : '#14B8A6');
        document.getElementById('cpu-cores').textContent = (sysRes.cpuCores || '--') + ' cores';
        
        // Memory Donut
        const memPercent = sysRes.memPercent || 0;
        document.getElementById('mem-percent').textContent = memPercent + '%';
        document.getElementById('mem-donut').setAttribute('stroke-dasharray', `${memPercent}, 100`);
        document.getElementById('mem-donut').setAttribute('stroke', memPercent > 80 ? '#EF4444' : memPercent > 50 ? '#F59E0B' : '#3B82F6');
        document.getElementById('mem-info').textContent = `${sysRes.memUsed || '--'} / ${sysRes.memTotal || '--'} GB`;
        
        // Disk Donut
        const diskPercent = sysRes.diskPercent || 0;
        document.getElementById('disk-percent').textContent = diskPercent + '%';
        document.getElementById('disk-donut').setAttribute('stroke-dasharray', `${diskPercent}, 100`);
        document.getElementById('disk-donut').setAttribute('stroke', diskPercent > 80 ? '#EF4444' : diskPercent > 50 ? '#F59E0B' : '#8B5CF6');
        document.getElementById('disk-info').textContent = `${sysRes.diskUsed || '--'} / ${sysRes.diskTotal || '--'} GB`;
        
        // GPU Donut
        if (sysRes.gpuPercent !== undefined && sysRes.gpuPercent !== null) {
          const gpuPercent = sysRes.gpuPercent;
          document.getElementById('gpu-percent').textContent = gpuPercent + '%';
          document.getElementById('gpu-donut').setAttribute('stroke-dasharray', `${gpuPercent}, 100`);
          document.getElementById('gpu-donut').setAttribute('stroke', gpuPercent > 80 ? '#EF4444' : gpuPercent > 50 ? '#F59E0B' : '#22C55E');
          document.getElementById('gpu-info').textContent = sysRes.gpuName || '--';
        } else {
          document.getElementById('gpu-percent').textContent = 'N/A';
          document.getElementById('gpu-donut').setAttribute('stroke-dasharray', '0, 100');
          document.getElementById('gpu-info').textContent = 'No GPU detected';
        }
        
        // System Info
        document.getElementById('sys-hostname').textContent = sysRes.hostname || '--';
        document.getElementById('sys-os').textContent = sysRes.os || '--';
        document.getElementById('sys-uptime').textContent = sysRes.uptime || '--';
        document.getElementById('sys-node').textContent = sysRes.nodeVersion || '--';
        
        // Fetch extended infra data
        const infraRes = await fetch('/api/system/infra').then(r => r.json()).catch(() => ({}));
        
        // Load Average
        document.getElementById('load-1').textContent = infraRes.load1 || '--';
        document.getElementById('load-5').textContent = infraRes.load5 || '--';
        document.getElementById('load-15').textContent = infraRes.load15 || '--';
        
        // Temperature
        document.getElementById('temp-cpu').textContent = infraRes.tempCpu ? infraRes.tempCpu + '¬∞C' : '--¬∞C';
        document.getElementById('temp-gpu').textContent = infraRes.tempGpu ? infraRes.tempGpu + '¬∞C' : '--¬∞C';
        
        // Network
        document.getElementById('net-ip').textContent = infraRes.netIp || '--';
        document.getElementById('net-rx').textContent = (infraRes.netRx || '0') + ' MB';
        document.getElementById('net-tx').textContent = (infraRes.netTx || '0') + ' MB';
        document.getElementById('net-conn').textContent = infraRes.netConn || '0';
        
        // Top Processes
        const procs = infraRes.topProcesses || [];
        document.getElementById('top-processes').innerHTML = procs.length ? procs.map(p => 
          `<div class="flex justify-between text-gray-600"><span class="truncate w-32">${p.split(' ')[0]}</span><span class="text-red-500">${p.split(' ')[1] || ''}</span></div>`
        ).join('') : '<div class="text-gray-400">No data</div>';
        
        // Open Ports
        const ports = infraRes.openPorts || [];
        document.getElementById('open-ports').innerHTML = ports.length ? ports.map(p => 
          `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${p}</span>`
        ).join('') : '<span class="text-gray-400 text-xs">No open ports</span>';
        
        // Services
        const services = infraRes.services || [];
        document.getElementById('services-list').innerHTML = services.length ? services.slice(0, 6).map(s => 
          `<div class="flex items-center gap-2"><span class="w-2 h-2 bg-green-500 rounded-full"></span><span class="text-gray-600">${s}</span></div>`
        ).join('') : '<div class="text-gray-400">No services</div>';
        
        // Security
        document.getElementById('sec-failed').textContent = infraRes.failedLogins || '0';
        document.getElementById('sec-firewall').textContent = infraRes.firewall?.includes('active') ? '‚úÖ Active' : '‚ùå Inactive';
        document.getElementById('sec-updates').textContent = (infraRes.updates || 0) + ' available';
        
        // Docker
        const docker = infraRes.docker || [];
        document.getElementById('docker-status').innerHTML = docker.length ? docker.map(d => {
          const [name, status] = d.split(':');
          const isUp = status?.includes('Up');
          return `<div class="flex items-center gap-2"><span class="w-2 h-2 ${isUp ? 'bg-green-500' : 'bg-red-500'} rounded-full"></span><span>${name}</span></div>`;
        }).join('') : '<div class="text-gray-400">No containers / Docker not installed</div>';
        
        // Cron Jobs
        const cron = infraRes.cron || [];
        document.getElementById('cron-jobs').innerHTML = cron.length ? cron.map(c => 
          `<div class="truncate text-gray-600" title="${c}">${c.slice(0, 40)}${c.length > 40 ? '...' : ''}</div>`
        ).join('') : '<div class="text-gray-400">No cron jobs</div>';
        
        // Disk I/O (total since boot)
        const diskReadMB = parseInt(infraRes.diskTotalReadMB) || 0;
        const diskWriteMB = parseInt(infraRes.diskTotalWriteMB) || 0;
        document.getElementById('disk-read').textContent = diskReadMB.toLocaleString() + ' MB';
        document.getElementById('disk-write').textContent = diskWriteMB.toLocaleString() + ' MB';
        // Bar shows percentage of write vs read (write usually larger)
        const maxDisk = Math.max(diskReadMB, diskWriteMB, 1);
        document.getElementById('disk-read-bar').style.width = (diskReadMB / maxDisk * 100) + '%';
        document.getElementById('disk-write-bar').style.width = (diskWriteMB / maxDisk * 100) + '%';
        document.getElementById('disk-total-read').textContent = infraRes.diskTotalRead || '--';
        document.getElementById('disk-total-write').textContent = infraRes.diskTotalWrite || '--';
        
        // CPU History Chart
        updateCpuHistoryChart(sysRes.cpu || 0);
        
        // Check Alerts
        checkInfraAlerts(sysRes.cpu || 0, sysRes.memPercent || 0, sysRes.diskPercent || 0, infraRes.tempCpu);
        
      } catch (e) {
        console.error('Infra error:', e);
      }
    }

    function showMainView() {
      document.getElementById('main-view').classList.remove('view-hidden');
      document.getElementById('agent-view').classList.add('view-hidden');
      document.getElementById('breadcrumb').innerHTML = '';
      document.getElementById('bot-department-panel').classList.add('view-hidden');
      document.getElementById('treasury-panel').classList.add('view-hidden');
      document.getElementById('intel-panel').classList.add('view-hidden');
      document.getElementById('credits-panel').classList.add('view-hidden');
      document.getElementById('infra-panel').classList.add('view-hidden');
      document.getElementById('security-panel').classList.add('view-hidden');
      document.getElementById('engineer-panel').classList.add('view-hidden');
      document.getElementById('sales-panel').classList.add('view-hidden');
      document.getElementById('analytics-panel').classList.add('view-hidden');
      document.getElementById('scheduler-panel').classList.add('view-hidden');
      document.getElementById('content-panel').classList.add('view-hidden');
      document.getElementById('community-panel').classList.add('view-hidden');
      document.getElementById('design-panel').classList.add('view-hidden');
      document.getElementById('header-filter').classList.add('hidden');
      currentAgent = null;
    }

    async function loadTasks() {
      const tasks = (currentAgent.tasks || []).filter(t => t.status !== 'cancelled');
      const byStatus = { inbox: [], assigned: [], progress: [], review: [], done: [] };
      tasks.forEach(t => (byStatus[t.status] || byStatus.inbox).push(t));
      
      // Sort done tasks by completedAt (newest first)
      byStatus.done.sort((a, b) => new Date(b.completedAt || b.createdAt) - new Date(a.completedAt || a.createdAt));
      
      document.getElementById('header-tasks').textContent = tasks.length;
      
      // Update columns (compact for sidebar)
      ['inbox', 'assigned', 'progress', 'review', 'done'].forEach(status => {
        document.getElementById(`col-${status}-count`).textContent = byStatus[status].length;
        document.getElementById(`col-${status}`).innerHTML = byStatus[status].map(t => `
          <div class="task-card bg-white rounded p-2 border border-cream-200 relative group cursor-pointer" 
               draggable="true" data-id="${t.id}">
            <div class="task-tooltip">
              <div class="font-bold mb-1">${t.title}</div>
              ${t.description ? `<div class="text-gray-300 mb-2">${t.description}</div>` : ''}
              ${t.tags ? `<div class="text-peach-400 text-[10px]">üè∑ ${t.tags}</div>` : ''}
              <div class="text-gray-400 text-[9px] mt-2">üìÖ ${new Date(t.createdAt).toLocaleString()}</div>
            </div>
            ${status !== 'done' ? `<button onclick="event.stopPropagation(); cancelTask(${t.id})" class="absolute top-1 right-1 w-4 h-4 bg-red-100 text-red-500 rounded-full text-[9px] opacity-0 group-hover:opacity-100 hover:bg-red-200 transition-opacity flex items-center justify-center" title="Cancel">‚úï</button>` : ''}
            <div class="font-medium text-[11px] truncate ${status !== 'done' ? 'pr-4' : ''}">${t.title}</div>
            ${t.tags ? `<div class="flex flex-wrap gap-0.5 mt-1">${t.tags.split(',').slice(0,2).map(tag => 
              `<span class="text-[8px] px-1 py-0.5 bg-cream-100 rounded">${tag.trim()}</span>`
            ).join('')}</div>` : ''}
          </div>
        `).join('') || `<div class="empty-state py-2"><span class="text-[10px] text-gray-400">No tasks</span></div>`;
      });
      
      // Update mini sidebar columns
      document.getElementById('sidebar-task-count').textContent = tasks.length;
      ['inbox', 'assigned', 'progress', 'done'].forEach(status => {
        const miniEl = document.getElementById(`mini-${status}`);
        const miniCount = document.getElementById(`mini-${status}-count`);
        if (miniEl && miniCount) {
          miniCount.textContent = byStatus[status].length;
          miniEl.innerHTML = byStatus[status].slice(0, 5).map(t => `
            <div class="bg-white rounded p-1 border border-cream-200 text-[9px] truncate" title="${t.title}">
              ${t.title.slice(0, 20)}${t.title.length > 20 ? '...' : ''}
            </div>
          `).join('') || '<div class="text-[8px] text-gray-400 text-center py-2">-</div>';
        }
      });
      
      setupDragDrop();
    }

    function loadFeed() {
      // Special case: BOT department shows bot status in feed
      if (currentAgent?.id === 'bot') {
        const botFeed = bots.filter(b => b.name !== 'momo-dashboard').map(b => ({
          icon: b.status === 'online' ? 'üü¢' : 'üî¥',
          title: b.name,
          status: b.status,
          cpu: b.cpu,
          mem: (b.memory/1024/1024).toFixed(0)
        }));
        
        document.getElementById('live-feed').innerHTML = botFeed.length ? botFeed.map(b => `
          <div class="feed-item py-2 px-3 rounded hover:bg-cream-50">
            <div class="flex items-center gap-2">
              <span class="text-sm">${b.icon}</span>
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium truncate">${b.title}</div>
                <div class="text-[10px] text-gray-400">${b.status} ¬∑ CPU: ${b.cpu}% ¬∑ ${b.mem}MB</div>
              </div>
              <button onclick="event.stopPropagation();controlBot('${b.status === 'online' ? 'stop' : 'start'}','${b.title}')" 
                class="text-[10px] px-2 py-1 rounded ${b.status === 'online' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                ${b.status === 'online' ? 'Stop' : 'Start'}
              </button>
            </div>
          </div>
        `).join('') : '<div class="empty-state"><span class="empty-state-icon">ü§ñ</span><span class="empty-state-text">No bots</span></div>';
        return;
      }
      
      const tasks = currentAgent?.tasks || [];
      // Sort by most recent activity (completedAt for done, createdAt for others)
      const sorted = [...tasks].sort((a, b) => {
        const dateA = new Date(a.completedAt || a.createdAt);
        const dateB = new Date(b.completedAt || b.createdAt);
        return dateB - dateA;
      });
      const feedItems = sorted.slice(0, 10).map(t => ({
        icon: t.status === 'cancelled' ? '‚ùå' : t.status === 'done' ? '‚úÖ' : t.status === 'progress' ? 'üîÑ' : t.status === 'review' ? 'üëÄ' : t.status === 'assigned' ? 'üìå' : 'üìã',
        title: t.title,
        time: new Date(t.completedAt || t.createdAt).toLocaleTimeString(),
        status: t.status
      }));
      
      document.getElementById('live-feed').innerHTML = feedItems.length ? feedItems.map(item => `
        <div class="feed-item py-2 px-3 rounded hover:bg-cream-50">
          <div class="flex items-start gap-2">
            <span class="text-sm">${item.icon}</span>
            <div class="flex-1">
              <div class="text-xs font-medium">${item.title}</div>
              <div class="text-[10px] text-gray-400">${item.time} ¬∑ ${item.status}</div>
            </div>
          </div>
        </div>
      `).join('') : '<div class="empty-state"><span class="empty-state-icon">üì≠</span><span class="empty-state-text">No activity yet</span></div>';
    }

    function setupDragDrop() {
      document.querySelectorAll('.task-card').forEach(card => {
        card.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', card.dataset.id);
          card.classList.add('dragging');
          // Small delay for visual feedback
          setTimeout(() => card.style.opacity = '0.5', 0);
        });
        card.addEventListener('dragend', () => {
          card.style.opacity = '1';
          card.classList.remove('dragging');
        });
      });
      
      document.querySelectorAll('.column-drop').forEach(col => {
        col.addEventListener('dragover', e => { 
          e.preventDefault(); 
          col.classList.add('drag-over');
        });
        col.addEventListener('dragleave', (e) => {
          // Only remove if actually leaving the column
          if (!col.contains(e.relatedTarget)) {
            col.classList.remove('drag-over');
          }
        });
        col.addEventListener('drop', async e => {
          e.preventDefault();
          col.classList.remove('drag-over');
          const taskId = e.dataTransfer.getData('text/plain');
          const newStatus = col.dataset.status;
          
          try {
            await fetch(`/api/agents/${currentAgent.id}/tasks/${taskId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ status: newStatus })
            });
            const res = await fetch(`/api/agents/${currentAgent.id}`);
            currentAgent = await res.json();
            loadTasks();
            loadFeed();
            showToast('Task moved!');
          } catch (err) {
            showToast('Failed to move task', 'error');
          }
        });
      });
    }

    function filterFeed(type, el) {
      document.querySelectorAll('.pill').forEach(p => {
        p.classList.remove('active', 'bg-peach-500', 'text-white');
        p.classList.add('bg-cream-200', 'text-gray-600');
      });
      el.classList.add('active', 'bg-peach-500', 'text-white');
      el.classList.remove('bg-cream-200', 'text-gray-600');
    }

    // Modals
    function openSpawnModal() { document.getElementById('spawn-modal').classList.remove('hidden'); document.getElementById('spawn-modal').classList.add('flex'); }
    function openTaskModal() { 
      document.getElementById('task-modal').classList.remove('hidden'); 
      document.getElementById('task-modal').classList.add('flex');
      // Populate agent dropdown
      const select = document.getElementById('task-agent');
      select.innerHTML = `<option value="${currentAgent?.id || ''}">${currentAgent?.icon || 'üìã'} ${currentAgent?.name || 'Current'} (current)</option>` +
        agents.filter(a => a.id !== currentAgent?.id).map(a => `<option value="${a.id}">${a.icon} ${a.name}</option>`).join('');
    }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }

    async function showLogsModal() {
      document.getElementById('logs-modal').classList.remove('hidden');
      document.getElementById('logs-modal').classList.add('flex');
      const res = await fetch(`/api/agents/${currentAgent.id}/logs`);
      const files = await res.json();
      document.getElementById('logs-files').innerHTML = files.map(f => 
        `<div onclick="loadLogFile('${f}')" class="px-2 py-1 hover:bg-cream-100 rounded cursor-pointer text-sm">${f}</div>`
      ).join('') || '<div class="text-gray-400 text-sm">No logs</div>';
    }

    async function loadLogFile(file) {
      const res = await fetch(`/api/agents/${currentAgent.id}/logs/${file}`);
      const data = await res.json();
      document.getElementById('logs-content').textContent = data.content || 'Empty';
    }

    async function showMemoryModal() {
      document.getElementById('memory-modal').classList.remove('hidden');
      document.getElementById('memory-modal').classList.add('flex');
      const files = currentAgent.memoryFiles || [];
      document.getElementById('memory-files').innerHTML = files.map(f => 
        `<div onclick="loadMemoryFile('${f}')" class="px-2 py-1 hover:bg-cream-100 rounded cursor-pointer text-sm ${currentMemoryFile === f ? 'bg-cream-200' : ''}">${f}</div>`
      ).join('') || '<div class="text-gray-400 text-sm">No files</div>';
    }

    async function loadMemoryFile(file) {
      currentMemoryFile = file;
      const res = await fetch(`/api/agents/${currentAgent.id}/memory/${file}`);
      const data = await res.json();
      document.getElementById('memory-content').value = data.content || '';
      showMemoryModal();
    }

    async function saveMemoryFile() {
      if (!currentMemoryFile) return alert('Select a file first');
      await fetch(`/api/agents/${currentAgent.id}/memory/${currentMemoryFile}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: document.getElementById('memory-content').value })
      });
      alert('Saved!');
    }

    async function createMemoryFile() {
      const name = prompt('File name (e.g. notes.md):');
      if (!name) return;
      await fetch(`/api/agents/${currentAgent.id}/memory/${name}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: `# ${currentAgent.name} - ${name}\n\n` })
      });
      currentAgent.memoryFiles = [...(currentAgent.memoryFiles || []), name];
      showMemoryModal();
    }

    function showBotsModal() {
      document.getElementById('bots-modal').classList.remove('hidden');
      document.getElementById('bots-modal').classList.add('flex');
      const agentBots = (currentAgent.pm2Bots || []).map(name => bots.find(b => b.name === name)).filter(Boolean);
      document.getElementById('bots-list').innerHTML = agentBots.length ? agentBots.map(bot => `
        <div class="bg-cream-50 rounded-lg p-4 border border-cream-200">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium">${bot.name}</span>
            <span class="status-dot ${bot.status === 'online' ? 'status-active' : 'status-offline'}"></span>
          </div>
          <div class="text-xs text-gray-500 mb-2">CPU: ${bot.cpu}% ¬∑ MEM: ${(bot.memory/1024/1024).toFixed(0)}MB</div>
          <button onclick="controlBot('${bot.status === 'online' ? 'stop' : 'start'}','${bot.name}')" 
            class="w-full text-xs py-1 ${bot.status === 'online' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'} rounded">
            ${bot.status === 'online' ? 'Stop' : 'Start'}
          </button>
        </div>
      `).join('') : '<div class="col-span-2 text-center text-gray-500 py-8">No bots assigned to this agent</div>';
    }

    async function doSpawn() {
      const label = document.getElementById('spawn-label').value;
      const task = document.getElementById('spawn-task').value;
      const model = document.getElementById('spawn-model').value;
      if (!task) return alert('Enter a task');
      await fetch('/api/spawn', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ label, task, model })
      });
      closeModal('spawn-modal');
      document.getElementById('spawn-label').value = '';
      document.getElementById('spawn-task').value = '';
      alert('Agent spawned!');
    }

    async function createTask() {
      const title = document.getElementById('task-title').value;
      const description = document.getElementById('task-desc').value;
      const targetAgentId = document.getElementById('task-agent').value || currentAgent.id;
      const tags = document.getElementById('task-tags').value;
      if (!title) return alert('Enter title');
      
      // Create task for target agent
      await fetch(`/api/agents/${targetAgentId}/tasks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          title, 
          description, 
          tags, 
          status: 'inbox',
          assignedBy: currentAgent?.id,
          assignedByName: currentAgent?.name
        })
      });
      
      closeModal('task-modal');
      document.getElementById('task-title').value = '';
      document.getElementById('task-desc').value = '';
      document.getElementById('task-tags').value = '';
      
      // If task was for current agent, refresh
      if (targetAgentId === currentAgent.id) {
        const res = await fetch(`/api/agents/${currentAgent.id}`);
        currentAgent = await res.json();
        loadTasks();
        loadFeed();
      } else {
        const targetAgent = agents.find(a => a.id === targetAgentId);
        alert(`Task assigned to ${targetAgent?.name || targetAgentId}!`);
      }
    }

    function sendToAgent() {
      const msg = prompt('Message to send:');
      if (!msg || !currentAgent.sessionKey) return;
      fetch('/api/sessions/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionKey: currentAgent.sessionKey, message: msg })
      }).then(() => alert('Sent!'));
    }

    function sendQuickMsg() {
      const msg = document.getElementById('quick-msg').value;
      if (!msg || !currentAgent.sessionKey) return;
      fetch('/api/sessions/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionKey: currentAgent.sessionKey, message: msg })
      }).then(() => {
        document.getElementById('quick-msg').value = '';
        alert('Sent!');
      });
    }

    async function cancelTask(taskId) {
      if (!confirm('Cancel this task?')) return;
      await fetch(`/api/agents/${currentAgent.id}/tasks/${taskId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'cancelled', cancelledAt: new Date().toISOString() })
      });
      const res = await fetch(`/api/agents/${currentAgent.id}`);
      currentAgent = await res.json();
      loadTasks();
      loadFeed();
    }

    // CEO Command
    let ceoCommands = [];
    
    async function sendCeoCommand() {
      const input = document.getElementById('ceo-command');
      const command = input.value.trim();
      if (!command) return;
      
      // Save command
      ceoCommands.unshift({ text: command, time: new Date().toLocaleTimeString() });
      if (ceoCommands.length > 5) ceoCommands.pop();
      
      // Show recent commands
      document.getElementById('ceo-recent').classList.remove('hidden');
      document.getElementById('ceo-commands-list').innerHTML = ceoCommands.map(c => 
        `<div class="text-gray-300">üìå ${c.text} <span class="text-gray-500 text-xs">(${c.time})</span></div>`
      ).join('');
      
      // Create task for MOMO (silent - no Telegram notification)
      await fetch('/api/agents/momo/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: `CEO Order: ${command.slice(0, 50)}${command.length > 50 ? '...' : ''}`,
          description: command,
          tags: 'ceo-order,priority',
          status: 'inbox',
          assignedBy: 'boss',
          assignedByName: 'BOSS (CEO)'
        })
      });
      
      input.value = '';
      
      // Show inline feedback instead of alert
      const btn = document.querySelector('button[onclick="sendCeoCommand()"]');
      const origText = btn.innerHTML;
      btn.innerHTML = '‚úÖ Sent!';
      btn.classList.add('bg-green-500');
      btn.classList.remove('bg-peach-500');
      setTimeout(() => {
        btn.innerHTML = origText;
        btn.classList.remove('bg-green-500');
        btn.classList.add('bg-peach-500');
      }, 2000);
    }
    
    // Allow Enter key to send
    document.getElementById('ceo-command')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendCeoCommand();
    });

    // Toast Notification Function
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'} ${message}`;
      if (type === 'error') toast.style.background = '#DC2626';
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }
    
    // SECURITY Scanner
    let securityAutoScanInterval = null;
    
    async function loadSecurityStatus() {
      // Load last scan results if any
      try {
        const res = await fetch('/api/security/status').then(r => r.json()).catch(() => ({}));
        if (res.lastScan) {
          document.getElementById('last-scan-time').textContent = new Date(res.lastScan).toLocaleString();
          updateSecurityUI(res);
        }
        // Load additional security info
        loadSecurityExtras();
      } catch (e) {
        console.error('Security status error:', e);
      }
    }
    
    async function loadSecurityExtras() {
      try {
        const extras = await fetch('/api/security/extras').then(r => r.json()).catch(() => ({}));
        
        // SSH Sessions
        document.getElementById('ssh-active').textContent = extras.sshActive || 0;
        document.getElementById('ssh-sessions-list').innerHTML = extras.sshSessions?.length ?
          extras.sshSessions.map(s => `<div class="text-cyan-600">${s}</div>`).join('') :
          '<div class="text-gray-400">No active sessions</div>';
        document.getElementById('ssh-history').innerHTML = extras.sshHistory?.length ?
          extras.sshHistory.map(h => `<div class="truncate">${h}</div>`).join('') :
          '<div class="text-gray-400">No recent logins</div>';
        
        // User Permissions
        document.getElementById('sudo-count').textContent = extras.sudoUsers?.length || 0;
        document.getElementById('sudo-users-list').innerHTML = extras.sudoUsers?.length ?
          extras.sudoUsers.map(u => `<div class="flex items-center gap-1"><span class="w-2 h-2 bg-indigo-500 rounded-full"></span>${u}</div>`).join('') :
          '<div class="text-gray-400">--</div>';
        document.getElementById('root-login-status').textContent = extras.rootLogin ? 'Enabled ‚ö†Ô∏è' : 'Disabled ‚úÖ';
        document.getElementById('root-login-status').className = `text-xs px-2 py-0.5 rounded ${extras.rootLogin ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
        
        // Recently Modified Files
        document.getElementById('recent-files').innerHTML = extras.recentFiles?.length ?
          extras.recentFiles.map(f => `<div class="truncate text-amber-600" title="${f}">${f}</div>`).join('') :
          '<div class="text-gray-400">No changes in 24h</div>';
        
        // SSL Certificates
        document.getElementById('ssl-certs').innerHTML = extras.sslCerts?.length ?
          extras.sslCerts.map(c => {
            const isExpiring = c.daysLeft < 30;
            return `<div class="flex justify-between ${isExpiring ? 'text-red-600' : 'text-teal-600'}">
              <span class="truncate">${c.domain}</span>
              <span>${c.daysLeft}d left</span>
            </div>`;
          }).join('') : '<div class="text-gray-400">No SSL certs found</div>';
        
        // Threat Timeline
        updateThreatTimeline(extras.threatTimeline || []);
        
        // Update Security Score
        updateSecurityScore(extras);
      } catch (e) {
        console.error('Security extras error:', e);
      }
    }
    
    function updateSecurityScore(data) {
      let score = 100;
      const critical = parseInt(document.getElementById('sec-critical').textContent) || 0;
      const high = parseInt(document.getElementById('sec-high').textContent) || 0;
      const medium = parseInt(document.getElementById('sec-medium').textContent) || 0;
      
      score -= critical * 25;
      score -= high * 10;
      score -= medium * 5;
      if (data.rootLogin) score -= 10;
      if (data.exposedSecrets?.length) score -= 15;
      
      score = Math.max(0, Math.min(100, score));
      
      let letter, color;
      if (score >= 90) { letter = 'A'; color = 'from-green-400 to-green-600'; }
      else if (score >= 80) { letter = 'B'; color = 'from-blue-400 to-blue-600'; }
      else if (score >= 70) { letter = 'C'; color = 'from-yellow-400 to-yellow-600'; }
      else if (score >= 60) { letter = 'D'; color = 'from-orange-400 to-orange-600'; }
      else { letter = 'F'; color = 'from-red-400 to-red-600'; }
      
      document.getElementById('sec-score-letter').textContent = letter;
      document.getElementById('sec-score-percent').textContent = score + '%';
      document.getElementById('security-score-card').className = `bg-gradient-to-br ${color} rounded-lg p-4 text-center text-white`;
      document.getElementById('security-score-badge').textContent = `Score: ${letter}`;
      document.getElementById('security-score-badge').className = `px-3 py-1 rounded-full text-sm font-bold ${score >= 80 ? 'bg-green-100 text-green-700' : score >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`;
    }
    
    function updateThreatTimeline(data) {
      const chart = document.getElementById('threat-timeline');
      if (!chart) return;
      
      // Handle both old format (array of numbers) and new format (array of {date, threats})
      let days;
      if (data.length && typeof data[0] === 'object') {
        days = data.map(d => d.threats || 0);
      } else {
        // Old format - pad to 30 days
        days = Array(30).fill(0);
        data.forEach((v, i) => { if (i < 30) days[i] = v; });
      }
      
      const max = Math.max(...days, 1);
      chart.innerHTML = days.map((v, i) => {
        const height = max > 0 ? (v / max) * 100 : 0;
        const color = v >= 6 ? 'bg-red-500' : v >= 3 ? 'bg-orange-400' : v >= 1 ? 'bg-yellow-400' : 'bg-green-400';
        const dateInfo = data[i]?.date || `${30-i}d ago`;
        return `<div class="flex-1 ${color} rounded-t transition-all hover:opacity-80 cursor-pointer" style="height: ${Math.max(height, 4)}%; min-height: 3px;" title="${dateInfo}: ${v} threats"></div>`;
      }).join('');
    }
    
    function toggleAutoScan() {
      const btn = document.getElementById('auto-scan-btn');
      const status = document.getElementById('auto-scan-status');
      if (securityAutoScanInterval) {
        clearInterval(securityAutoScanInterval);
        securityAutoScanInterval = null;
        btn.textContent = '‚è∞ Auto: OFF';
        btn.className = 'px-3 py-1.5 bg-gray-500 text-white rounded text-xs hover:bg-gray-600 transition-colors';
        status.textContent = 'Auto-scan: Disabled';
      } else {
        securityAutoScanInterval = setInterval(() => runSecurityScan(true), 60000); // Every minute (silent)
        btn.textContent = '‚è∞ Auto: ON';
        btn.className = 'px-3 py-1.5 bg-green-500 text-white rounded text-xs hover:bg-green-600 transition-colors';
        status.textContent = 'Auto-scan: Every 1 min';
        showToast('Auto-scan enabled (every 1 min)');
      }
    }
    
    async function runSecurityScan(silent = false) {
      const btn = document.querySelector('button[onclick="runSecurityScan()"]');
      if (!silent) {
        btn.innerHTML = 'üîÑ Scanning...';
        btn.disabled = true;
      }
      
      try {
        const res = await fetch('/api/security/scan', { method: 'POST' }).then(r => r.json());
        updateSecurityUI(res);
        document.getElementById('last-scan-time').textContent = new Date().toLocaleString();
        if (!silent) showToast('Security scan completed!');
      } catch (e) {
        console.error('Security scan error:', e);
        if (!silent) showToast('Scan failed: ' + e.message, 'error');
      } finally {
        btn.innerHTML = 'üîç Scan Now';
        btn.disabled = false;
      }
    }
    
    function updateSecurityUI(data) {
      // Summary counts
      document.getElementById('sec-critical').textContent = data.critical || 0;
      document.getElementById('sec-high').textContent = data.high || 0;
      document.getElementById('sec-medium').textContent = data.medium || 0;
      document.getElementById('sec-safe').textContent = data.safe || 0;
      
      // Critical alerts
      const criticalAlerts = data.criticalAlerts || [];
      document.getElementById('critical-alerts').innerHTML = criticalAlerts.length ? 
        criticalAlerts.map(a => `
          <div class="bg-red-50 border border-red-200 rounded p-2">
            <div class="font-bold text-red-700 text-sm">${a.source}</div>
            <div class="text-red-600 text-xs">${a.message}</div>
            ${a.files ? `<div class="text-red-500 text-[10px] mt-1">Files: ${a.files.join(', ')}</div>` : ''}
          </div>
        `).join('') : '<div class="text-green-600 text-sm">‚úÖ No critical threats detected</div>';
      
      // Suspicious files
      const suspFiles = data.suspiciousFiles || [];
      document.getElementById('suspicious-files').innerHTML = suspFiles.length ?
        suspFiles.map(f => `<div class="text-orange-600 truncate" title="${f}">üìÑ ${f}</div>`).join('') :
        '<div class="text-green-600">‚úÖ None found</div>';
      
      // Risky patterns (HIGH)
      const patterns = data.riskyPatterns || [];
      document.getElementById('risky-patterns').innerHTML = patterns.length ?
        patterns.map(p => {
          if (typeof p === 'object') {
            return `
              <div class="bg-orange-50 border border-orange-200 rounded p-2 mb-2">
                <div class="font-bold text-orange-600 text-xs">‚ö†Ô∏è ${p.name}</div>
                <div class="text-orange-500 text-[10px] mt-1">${p.files.map(f => `üìÑ ${f}`).join('<br>')}</div>
              </div>
            `;
          }
          return `<div class="text-yellow-600">‚ö†Ô∏è ${p}</div>`;
        }).join('') :
        '<div class="text-green-600">‚úÖ None found</div>';
      
      // Skills scan
      const skills = data.skillsScan || [];
      document.getElementById('skills-scan').innerHTML = skills.length ?
        skills.map(s => `
          <div class="flex items-center gap-2 ${s.risk === 'critical' ? 'text-red-600' : s.risk === 'high' ? 'text-orange-600' : s.risk === 'medium' ? 'text-yellow-600' : 'text-green-600'}">
            <span>${s.risk === 'critical' ? 'üî¥' : s.risk === 'high' ? 'üü†' : s.risk === 'medium' ? 'üü°' : 'üü¢'}</span>
            <span class="font-medium">${s.name}</span>
            <span class="text-xs text-gray-500">${s.reason || ''}</span>
          </div>
        `).join('') : '<div class="text-gray-400">No skills to scan</div>';
      
      // Outbound connections
      const outbound = data.outboundConnections || [];
      document.getElementById('outbound-conn').innerHTML = outbound.length ?
        outbound.map(c => `<div class="truncate">${c}</div>`).join('') :
        '<div class="text-gray-400">No suspicious connections</div>';
      
      // Security events
      const events = data.securityEvents || [];
      document.getElementById('security-events').innerHTML = events.length ?
        events.map(e => `<div class="${e.type === 'alert' ? 'text-red-600' : 'text-gray-600'}">${e.message}</div>`).join('') :
        '<div class="text-gray-400">No recent events</div>';
      
      // Exposed Secrets
      const secrets = data.exposedSecrets || [];
      document.getElementById('exposed-secrets').innerHTML = secrets.length ?
        secrets.map(s => `<div class="text-red-600">üîë ${s}</div>`).join('') :
        '<div class="text-green-600">‚úÖ No exposed secrets found</div>';
    }

    // Task Tooltip Positioning
    document.addEventListener('mouseover', (e) => {
      const card = e.target.closest('.task-card');
      if (card) {
        const tooltip = card.querySelector('.task-tooltip');
        if (tooltip) {
          const rect = card.getBoundingClientRect();
          // Position to the left of the card
          tooltip.style.top = rect.top + 'px';
          tooltip.style.left = (rect.left - 230) + 'px';
          // If would go off screen left, position to the right instead
          if (rect.left - 230 < 10) {
            tooltip.style.left = (rect.right + 10) + 'px';
          }
        }
      }
    });

    // =====================
    // ENGINEER DEPARTMENT
    // =====================
    
    async function refreshEngineer() {
      showToast('Loading engineering data...');
      await Promise.all([fetchGitData(), fetchCodeData(), fetchDepsData(), fetchEnvData()]);
      showToast('Engineering data loaded');
    }

    async function fetchGitData() {
      try {
        const res = await fetch('/api/engineer/git');
        const data = await res.json();
        
        // Stats
        document.getElementById('eng-commits-today').textContent = data.stats?.today || 0;
        document.getElementById('eng-commits-week').textContent = data.stats?.week || 0;
        
        // Current branch
        document.getElementById('eng-current-branch').textContent = data.branch || 'unknown';
        
        // Branches
        const branchesHtml = (data.branches || []).map(b => `
          <div class="flex justify-between items-center py-1 border-b border-gray-100">
            <span class="font-mono ${b.name === data.branch ? 'text-green-600 font-bold' : 'text-gray-600'}">${b.name}</span>
            <span class="text-gray-400 text-[10px]">${b.lastCommit || ''}</span>
          </div>
        `).join('') || '<div class="text-gray-400">No branches</div>';
        document.getElementById('eng-branches').innerHTML = branchesHtml;
        
        // Commits
        const commitsHtml = (data.commits || []).map(c => `
          <div class="border-b border-gray-100 pb-1">
            <div class="flex items-center gap-2">
              <span class="font-mono text-indigo-600">${c.hash}</span>
              <span class="text-gray-400 text-[10px]">${c.time}</span>
            </div>
            <div class="text-gray-700 truncate" title="${c.message}">${c.message}</div>
          </div>
        `).join('') || '<div class="text-gray-400">No commits</div>';
        document.getElementById('eng-commits').innerHTML = commitsHtml;
      } catch (e) {
        console.error('Git data error:', e);
      }
    }

    async function fetchCodeData() {
      try {
        const res = await fetch('/api/engineer/code');
        const data = await res.json();
        
        // Stats
        document.getElementById('eng-total-files').textContent = data.stats?.files || 0;
        document.getElementById('eng-total-lines').textContent = (data.stats?.lines || 0).toLocaleString();
        
        // File types
        const fileTypesHtml = Object.entries(data.fileTypes || {}).map(([ext, count]) => `
          <div class="flex justify-between items-center">
            <span class="font-mono text-cyan-600">.${ext}</span>
            <span class="text-gray-500">${count} files</span>
          </div>
        `).join('') || '<div class="text-gray-400">No files</div>';
        document.getElementById('eng-file-types').innerHTML = fileTypesHtml;
        
        // TODOs
        const todosHtml = (data.todos || []).map(t => `
          <div class="border-b border-gray-100 pb-1">
            <div class="text-yellow-600 truncate" title="${t.file}:${t.line}">üìÑ ${t.file}:${t.line}</div>
            <div class="text-gray-600 text-[10px] truncate">${t.text}</div>
          </div>
        `).join('') || '<div class="text-green-600">‚úÖ No TODOs found</div>';
        document.getElementById('eng-todos').innerHTML = todosHtml;
        
        // Largest files
        const largestHtml = (data.stats?.largest || []).map(f => `
          <div class="flex justify-between items-center">
            <span class="text-purple-600 truncate flex-1" title="${f.file}">${f.file}</span>
            <span class="text-gray-500 ml-2">${f.lines} lines</span>
          </div>
        `).join('') || '<div class="text-gray-400">--</div>';
        document.getElementById('eng-largest').innerHTML = largestHtml;
      } catch (e) {
        console.error('Code data error:', e);
      }
    }

    async function fetchDepsData() {
      try {
        const res = await fetch('/api/engineer/deps');
        const data = await res.json();
        
        // Package count
        document.getElementById('eng-deps-count').textContent = `${data.installed || 0} packages`;
        
        // Outdated
        const outdatedHtml = (data.outdated || []).map(p => `
          <div class="flex justify-between items-center text-orange-600">
            <span class="font-mono">${p.name}</span>
            <span class="text-[10px]">${p.current} ‚Üí ${p.latest}</span>
          </div>
        `).join('') || '<div class="text-green-600">‚úÖ All up to date</div>';
        document.getElementById('eng-outdated').innerHTML = outdatedHtml;
        
        // Vulnerabilities
        const v = data.vulnerabilities || {};
        const vulnHtml = `
          <div class="grid grid-cols-4 gap-2 text-center">
            <div>
              <div class="text-2xl font-bold text-red-600">${v.critical || 0}</div>
              <div class="text-[9px] text-gray-500">Critical</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-orange-500">${v.high || 0}</div>
              <div class="text-[9px] text-gray-500">High</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-yellow-500">${v.moderate || 0}</div>
              <div class="text-[9px] text-gray-500">Moderate</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-blue-500">${v.low || 0}</div>
              <div class="text-[9px] text-gray-500">Low</div>
            </div>
          </div>
          <div class="text-center mt-2 text-xs ${v.total > 0 ? 'text-red-600' : 'text-green-600'}">
            ${v.total > 0 ? `‚ö†Ô∏è ${v.total} vulnerabilities found` : '‚úÖ No vulnerabilities'}
          </div>
        `;
        document.getElementById('eng-vulns').innerHTML = vulnHtml;
      } catch (e) {
        console.error('Deps data error:', e);
      }
    }

    async function fetchEnvData() {
      try {
        const res = await fetch('/api/engineer/env');
        const data = await res.json();
        
        document.getElementById('eng-node').textContent = data.node || '--';
        document.getElementById('eng-npm').textContent = data.npm || '--';
        document.getElementById('eng-pm2').textContent = data.pm2 || '--';
        document.getElementById('eng-os').textContent = data.os || '--';
        
        // Format uptime
        const uptime = data.uptime || 0;
        const days = Math.floor(uptime / 86400);
        const hours = Math.floor((uptime % 86400) / 3600);
        const mins = Math.floor((uptime % 3600) / 60);
        document.getElementById('eng-uptime').textContent = `${days}d ${hours}h ${mins}m`;
      } catch (e) {
        console.error('Env data error:', e);
      }
    }

    async function gitPull() {
      try {
        showToast('Running git pull...');
        const res = await fetch('/api/engineer/git/pull', { method: 'POST' });
        const data = await res.json();
        document.getElementById('git-output').classList.remove('hidden');
        document.getElementById('git-output-text').textContent = data.output || data.error || 'Done';
        if (data.ok) {
          showToast('Git pull successful');
          fetchGitData();
        }
      } catch (e) {
        showToast('Git pull failed');
      }
    }

    async function gitStatus() {
      try {
        const res = await fetch('/api/engineer/git/status', { method: 'POST' });
        const data = await res.json();
        document.getElementById('git-output').classList.remove('hidden');
        document.getElementById('git-output-text').textContent = data.output || data.error || 'Clean';
      } catch (e) {
        showToast('Git status failed');
      }
    }

    // =====================
    // SALES DEPARTMENT
    // =====================
    
    let salesProducts = [];
    
    async function refreshSales() {
      showToast('Loading sales data...');
      await Promise.all([fetchSalesOverview(), fetchSalesProducts(), fetchSalesLeads(), fetchSalesOrders()]);
    }

    async function fetchSalesOverview() {
      try {
        const res = await fetch('/api/sales/overview');
        const data = await res.json();
        
        // Revenue
        document.getElementById('sales-today').textContent = '$' + (data.revenue?.today || 0);
        document.getElementById('sales-week').textContent = '$' + (data.revenue?.week || 0);
        document.getElementById('sales-month').textContent = '$' + (data.revenue?.month || 0);
        document.getElementById('sales-total').textContent = '$' + (data.revenue?.total || 0);
        document.getElementById('sales-conversion').textContent = (data.conversionRate || 0) + '% conversion';
        
        // Progress bars
        const targets = data.targets || { daily: 100, weekly: 500, monthly: 2000 };
        document.getElementById('sales-today-bar').style.width = Math.min(100, (data.revenue?.today / targets.daily) * 100) + '%';
        document.getElementById('sales-week-bar').style.width = Math.min(100, (data.revenue?.week / targets.weekly) * 100) + '%';
        document.getElementById('sales-month-bar').style.width = Math.min(100, (data.revenue?.month / targets.monthly) * 100) + '%';
        
        // Targets inputs
        document.getElementById('target-daily').value = targets.daily;
        document.getElementById('target-weekly').value = targets.weekly;
        document.getElementById('target-monthly').value = targets.monthly;
        
        // Pipeline
        const pipe = data.pipeline || {};
        const maxPipe = Math.max(pipe.leads || 0, pipe.contacted || 0, pipe.negotiating || 0, pipe.closed || 0, 1);
        
        ['leads', 'contacted', 'negotiating', 'closed'].forEach(stage => {
          const count = pipe[stage] || 0;
          const bar = document.getElementById(`pipe-${stage}-bar`);
          bar.style.width = Math.max(15, (count / maxPipe) * 100) + '%';
          bar.textContent = count;
        });
      } catch (e) {
        console.error('Sales overview error:', e);
      }
    }

    async function fetchSalesProducts() {
      try {
        const res = await fetch('/api/sales/products');
        salesProducts = await res.json();
        
        document.getElementById('sales-products').innerHTML = salesProducts.length ?
          salesProducts.map(p => `
            <div class="flex items-center justify-between py-1 border-b border-gray-100">
              <div>
                <div class="font-medium text-sm">${p.name}</div>
                <div class="text-[10px] text-gray-400">${p.category} ¬∑ ${p.sold} sold</div>
              </div>
              <div class="font-bold text-emerald-600">$${p.price}</div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No products yet</div>';
        
        // Update select dropdowns
        const productOptions = '<option value="">Select Product...</option>' + 
          salesProducts.map(p => `<option value="${p.id}" data-price="${p.price}">${p.name} ($${p.price})</option>`).join('');
        document.getElementById('lead-product').innerHTML = productOptions.replace('Select Product', 'Interested in');
        document.getElementById('order-product').innerHTML = productOptions;
      } catch (e) {
        console.error('Sales products error:', e);
      }
    }

    async function fetchSalesLeads() {
      try {
        const res = await fetch('/api/sales/leads');
        const leads = await res.json();
        
        const statusColors = {
          new: 'bg-gray-100 text-gray-600',
          contacted: 'bg-yellow-100 text-yellow-700',
          negotiating: 'bg-orange-100 text-orange-700',
          closed: 'bg-green-100 text-green-700'
        };
        
        document.getElementById('sales-leads').innerHTML = leads.length ?
          leads.map(l => `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div class="flex-1">
                <div class="font-medium text-sm">${l.name}</div>
                <div class="text-[10px] text-gray-400">${l.contact || ''} ${l.notes ? '¬∑ ' + l.notes.substring(0, 30) : ''}</div>
              </div>
              <select onchange="updateLeadStatus(${l.id}, this.value)" class="text-[10px] px-2 py-1 rounded ${statusColors[l.status] || statusColors.new}">
                <option value="new" ${l.status === 'new' ? 'selected' : ''}>New</option>
                <option value="contacted" ${l.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                <option value="negotiating" ${l.status === 'negotiating' ? 'selected' : ''}>Negotiating</option>
                <option value="closed" ${l.status === 'closed' ? 'selected' : ''}>Closed ‚úì</option>
              </select>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No leads yet. Click "+ Lead" to add one.</div>';
      } catch (e) {
        console.error('Sales leads error:', e);
      }
    }

    async function fetchSalesOrders() {
      try {
        const res = await fetch('/api/sales/orders');
        const orders = await res.json();
        
        document.getElementById('sales-orders').innerHTML = orders.length ?
          orders.slice(-10).reverse().map(o => `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div>
                <div class="font-medium text-sm">${o.customer}</div>
                <div class="text-[10px] text-gray-400">${o.date} ${o.notes ? '¬∑ ' + o.notes.substring(0, 30) : ''}</div>
              </div>
              <div class="font-bold text-green-600">+$${o.amount}</div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No orders yet. Click "+ Order" to record a sale.</div>';
      } catch (e) {
        console.error('Sales orders error:', e);
      }
    }

    async function updateLeadStatus(id, status) {
      try {
        await fetch(`/api/sales/leads/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        fetchSalesOverview();
        showToast('Lead updated');
      } catch (e) {
        showToast('Failed to update lead');
      }
    }

    async function updateTargets() {
      try {
        await fetch('/api/sales/targets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            daily: parseInt(document.getElementById('target-daily').value) || 100,
            weekly: parseInt(document.getElementById('target-weekly').value) || 500,
            monthly: parseInt(document.getElementById('target-monthly').value) || 2000
          })
        });
        fetchSalesOverview();
        showToast('Targets updated');
      } catch (e) {
        showToast('Failed to update targets');
      }
    }

    function showAddLeadModal() {
      document.getElementById('lead-modal').classList.remove('hidden');
      document.getElementById('lead-name').value = '';
      document.getElementById('lead-contact').value = '';
      document.getElementById('lead-notes').value = '';
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.add('hidden');
    }

    async function saveLead() {
      const name = document.getElementById('lead-name').value;
      if (!name) return showToast('Please enter a name');
      
      try {
        await fetch('/api/sales/leads', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            contact: document.getElementById('lead-contact').value,
            productId: document.getElementById('lead-product').value,
            notes: document.getElementById('lead-notes').value
          })
        });
        closeLeadModal();
        fetchSalesLeads();
        fetchSalesOverview();
        showToast('Lead added!');
      } catch (e) {
        showToast('Failed to add lead');
      }
    }

    function showAddOrderModal() {
      document.getElementById('order-modal').classList.remove('hidden');
      document.getElementById('order-customer').value = '';
      document.getElementById('order-amount').value = '';
      document.getElementById('order-notes').value = '';
    }

    function closeOrderModal() {
      document.getElementById('order-modal').classList.add('hidden');
    }

    // Auto-fill amount when product selected
    document.getElementById('order-product')?.addEventListener('change', function() {
      const selected = this.options[this.selectedIndex];
      if (selected.dataset.price) {
        document.getElementById('order-amount').value = selected.dataset.price;
      }
    });

    async function saveOrder() {
      const customer = document.getElementById('order-customer').value;
      const amount = parseFloat(document.getElementById('order-amount').value);
      if (!customer || !amount) return showToast('Please fill customer and amount');
      
      try {
        await fetch('/api/sales/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer,
            productId: parseInt(document.getElementById('order-product').value) || null,
            amount,
            notes: document.getElementById('order-notes').value
          })
        });
        closeOrderModal();
        fetchSalesOrders();
        fetchSalesOverview();
        fetchSalesProducts();
        showToast('Sale recorded! üéâ');
      } catch (e) {
        showToast('Failed to record sale');
      }
    }

    function showAddProductModal() {
      const name = prompt('Product name:');
      if (!name) return;
      const price = parseInt(prompt('Price (USD):'));
      if (!price) return;
      const category = prompt('Category (service/template/consulting):') || 'service';
      
      fetch('/api/sales/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, price, category })
      }).then(() => {
        fetchSalesProducts();
        showToast('Product added!');
      });
    }

    // =====================
    // ANALYTICS DEPARTMENT
    // =====================
    
    async function refreshAnalytics() {
      showToast('Loading analytics...');
      try {
        const res = await fetch('/api/analytics/overview');
        const data = await res.json();
        
        // PnL
        const totalPnL = data.pnl?.total || 0;
        document.getElementById('analytics-total-pnl').textContent = (totalPnL >= 0 ? '+' : '') + '$' + totalPnL.toFixed(2);
        document.getElementById('analytics-total-pnl').className = `text-2xl font-bold ${totalPnL >= 0 ? 'text-green-600' : 'text-red-600'}`;
        
        document.getElementById('analytics-today-pnl').textContent = '$' + (data.pnl?.today || 0).toFixed(2);
        document.getElementById('analytics-trades').textContent = data.trades?.total || 0;
        document.getElementById('analytics-winrate').textContent = (data.trades?.winRate || 0) + '%';
        document.getElementById('analytics-wins').textContent = data.trades?.wins || 0;
        document.getElementById('analytics-losses').textContent = data.trades?.losses || 0;
        
        // Bot performance
        const bots = data.bots || [];
        document.getElementById('analytics-bots').innerHTML = bots.length ?
          bots.map(b => `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div class="flex items-center gap-2">
                <span class="status-dot ${b.status === 'online' ? 'status-active' : 'status-offline'}"></span>
                <span class="font-medium text-sm">${b.name}</span>
              </div>
              <div class="text-xs text-gray-500">
                ‚Üª${b.restarts} ¬∑ ${Math.floor((Date.now() - b.uptime) / 3600000)}h up
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No bots running</div>';
        
        // Recent trades
        const trades = data.recentTrades || [];
        document.getElementById('analytics-trades-list').innerHTML = trades.length ?
          trades.map(t => `
            <div class="flex items-center justify-between py-1 border-b border-gray-100">
              <div class="text-xs truncate flex-1">${t.token || t.symbol || 'Unknown'}</div>
              <div class="text-xs font-bold ${(t.pnl || 0) >= 0 ? 'text-green-600' : 'text-red-600'}">
                ${(t.pnl || 0) >= 0 ? '+' : ''}${(t.pnl || 0).toFixed(4)} ETH
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No trades recorded</div>';
      } catch (e) {
        console.error('Analytics error:', e);
      }
    }

    // =====================
    // SCHEDULER DEPARTMENT
    // =====================
    
    async function refreshScheduler() {
      showToast('Loading scheduler...');
      try {
        const res = await fetch('/api/scheduler/jobs');
        const jobs = await res.json();
        
        const active = jobs.filter(j => j.enabled !== false).length;
        const disabled = jobs.filter(j => j.enabled === false).length;
        
        document.getElementById('scheduler-active').textContent = active;
        document.getElementById('scheduler-disabled').textContent = disabled;
        document.getElementById('scheduler-total').textContent = jobs.length;
        
        document.getElementById('scheduler-jobs').innerHTML = jobs.length ?
          jobs.map(j => `
            <div class="flex items-center justify-between py-2 border-b border-gray-100">
              <div class="flex-1">
                <div class="font-medium text-sm">${j.name || j.id}</div>
                <div class="text-[10px] text-gray-400">${j.schedule?.kind || ''} ${j.schedule?.expr || ''}</div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="toggleJob('${j.id}', ${!j.enabled})" 
                  class="px-2 py-1 rounded text-[10px] ${j.enabled !== false ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                  ${j.enabled !== false ? '‚úì ON' : '‚óã OFF'}
                </button>
                <button onclick="runJobNow('${j.id}')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-[10px]" title="Run Now">‚ñ∂</button>
              </div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No cron jobs configured</div>';
      } catch (e) {
        console.error('Scheduler error:', e);
      }
    }

    async function toggleJob(id, enabled) {
      try {
        await fetch(`/api/scheduler/toggle/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        refreshScheduler();
        showToast(`Job ${enabled ? 'enabled' : 'disabled'}`);
      } catch (e) {
        showToast('Failed to toggle job');
      }
    }

    async function runJobNow(id) {
      try {
        await fetch(`/api/scheduler/run/${id}`, { method: 'POST' });
        showToast('Job triggered!');
      } catch (e) {
        showToast('Failed to run job');
      }
    }

    // =====================
    // CONTENT DEPARTMENT
    // =====================
    
    async function refreshContent() {
      showToast('Loading content...');
      try {
        const res = await fetch('/api/content/overview');
        const data = await res.json();
        
        document.getElementById('content-total').textContent = data.stats?.total || 0;
        document.getElementById('content-scheduled').textContent = data.stats?.scheduled || 0;
        document.getElementById('content-published').textContent = data.stats?.published || 0;
        
        // Ideas
        const ideas = data.ideas || [];
        document.getElementById('content-ideas').innerHTML = ideas.length ?
          ideas.map(i => `
            <div class="py-1 border-b border-gray-100">
              <div class="text-sm">${i.text || i.title}</div>
              <div class="text-[10px] text-gray-400">${new Date(i.createdAt).toLocaleDateString()}</div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No ideas yet. Click "+ Idea" to add one.</div>';
        
        // Posts
        const posts = data.posts || [];
        document.getElementById('content-posts').innerHTML = posts.length ?
          posts.slice(-5).reverse().map(p => `
            <div class="py-2 border-b border-gray-100">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium truncate flex-1">${p.title || p.token || 'Post'}</span>
                <span class="text-[10px] px-2 py-0.5 rounded ${p.status === 'published' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${p.status || 'draft'}</span>
              </div>
              <div class="text-xs text-gray-500 truncate">${p.content?.substring(0, 60) || ''}</div>
              ${p.link ? `<a href="${p.link}" target="_blank" class="text-[10px] text-blue-500 hover:underline">üîó View on ${p.platform || 'X'}</a>` : ''}
            </div>
          `).join('') : '<div class="text-gray-400 text-xs">No posts yet</div>';
      } catch (e) {
        console.error('Content error:', e);
      }
    }

    function addContentIdea() {
      const text = prompt('Enter your content idea:');
      if (!text) return;
      
      fetch('/api/content/ideas', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      }).then(() => {
        refreshContent();
        showToast('Idea added!');
      });
    }

    // =====================
    // COMMUNITY DEPARTMENT
    // =====================
    
    async function refreshCommunity() {
      showToast('Loading community stats...');
      try {
        const res = await fetch('/api/community/stats');
        const data = await res.json();
        
        // Twitter
        document.getElementById('twitter-followers').textContent = data.twitter?.followers || 0;
        document.getElementById('twitter-tweets').textContent = data.twitter?.tweets || 0;
        
        // Telegram
        document.getElementById('telegram-members').textContent = data.telegram?.members || 1;
        document.getElementById('telegram-messages').textContent = data.telegram?.messages || 0;
        
        // Farcaster
        document.getElementById('farcaster-followers').textContent = data.farcaster?.followers || 0;
        document.getElementById('farcaster-casts').textContent = data.farcaster?.casts || 0;
        
        // Discord
        document.getElementById('discord-members').textContent = data.discord?.members || 0;
        document.getElementById('discord-online').textContent = data.discord?.online || 0;
        
        // Engagement
        document.getElementById('engagement-likes').textContent = data.engagement?.likes || 0;
        document.getElementById('engagement-retweets').textContent = data.engagement?.retweets || 0;
        document.getElementById('engagement-replies').textContent = data.engagement?.replies || 0;
      } catch (e) {
        console.error('Community error:', e);
      }
    }

    // =====================
    // DESIGN DEPARTMENT
    // =====================
    
    async function refreshDesign() {
      showToast('Loading design assets...');
      try {
        const res = await fetch('/api/design/assets');
        const data = await res.json();
        
        // Templates
        const templates = data.templates || [];
        document.getElementById('design-templates').innerHTML = templates.map(t => `
          <div class="bg-cream-100 rounded-lg p-3 text-center border border-cream-300">
            <div class="text-2xl mb-1">üìê</div>
            <div class="text-xs font-medium">${t.name}</div>
            <div class="text-[10px] text-gray-500">${t.size}</div>
          </div>
        `).join('');
        
        // Assets
        const assets = data.assets || [];
        document.getElementById('design-assets').innerHTML = assets.length ?
          assets.map(a => `
            <div class="bg-white rounded-lg p-2 border border-gray-200 text-center">
              <div class="text-xl mb-1">üñºÔ∏è</div>
              <div class="text-[10px] truncate">${a.name}</div>
            </div>
          `).join('') : '<div class="text-gray-400 text-xs col-span-4">No assets yet</div>';
      } catch (e) {
        console.error('Design error:', e);
      }
    }
    
    // =====================
    // MOMO AUTONOMY RULES
    // =====================
    
    let momoRules = {
      code: true,
      bot: true,
      twitter: true,
      testnet: true,
      scaling: true,
      cron: true,
      alerts: true,
      emergency: true,
      maintenance: true,
      money: false,
      external: false,
      deploy: false,
      security: false
    };
    
    let momoConfig = {
      maxTradeSize: 20,
      minEdge: 15,
      maxSpread: 5,
      maxBetsPerDay: 3
    };
    
    let momoAlerts = {
      walletLow: true,
      botCrash: true,
      tradeResult: true,
      dailySummary: true
    };
    
    let momoQuiet = {
      enabled: true,
      start: '23:00',
      end: '08:00'
    };
    
    async function loadMomoRules() {
      try {
        const res = await fetch('/api/momo/rules');
        const data = await res.json();
        
        // Load rules
        if (data.rules) {
          momoRules = data.rules;
          Object.keys(momoRules).forEach(key => {
            const checkbox = document.getElementById(`rule-${key}`);
            if (checkbox) checkbox.checked = momoRules[key];
          });
        }
        
        // Load config
        if (data.config) {
          momoConfig = data.config;
          document.getElementById('config-max-trade').value = momoConfig.maxTradeSize || 20;
          document.getElementById('config-min-edge').value = momoConfig.minEdge || 15;
          document.getElementById('config-max-spread').value = momoConfig.maxSpread || 5;
          document.getElementById('config-max-bets').value = momoConfig.maxBetsPerDay || 3;
        }
        
        // Load alerts
        if (data.alerts) {
          momoAlerts = data.alerts;
          document.getElementById('alert-wallet').checked = momoAlerts.walletLow !== false;
          document.getElementById('alert-crash').checked = momoAlerts.botCrash !== false;
          document.getElementById('alert-trade').checked = momoAlerts.tradeResult !== false;
          document.getElementById('alert-daily').checked = momoAlerts.dailySummary !== false;
        }
        
        // Load quiet hours
        if (data.quiet) {
          momoQuiet = data.quiet;
          document.getElementById('quiet-enabled').checked = momoQuiet.enabled !== false;
          document.getElementById('quiet-start').value = momoQuiet.start || '23:00';
          document.getElementById('quiet-end').value = momoQuiet.end || '08:00';
        }
        
        // Update timestamp
        if (data.updated) {
          document.getElementById('momo-rules-updated').textContent = new Date(data.updated).toLocaleString('th-TH');
        }
      } catch (e) {
        console.error('Failed to load rules:', e);
      }
    }
    
    function updateRule(key, value) {
      momoRules[key] = value;
    }
    
    function updateConfig(key, value) {
      momoConfig[key] = parseInt(value) || 0;
    }
    
    function updateAlert(key, value) {
      momoAlerts[key] = value;
    }
    
    function updateQuiet(key, value) {
      momoQuiet[key] = value;
    }
    
    async function saveMomoRules() {
      try {
        const res = await fetch('/api/momo/rules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            rules: momoRules,
            config: momoConfig,
            alerts: momoAlerts,
            quiet: momoQuiet
          })
        });
        if (res.ok) {
          showToast('‚úÖ Settings saved!');
          document.getElementById('momo-rules-updated').textContent = new Date().toLocaleString('th-TH');
        } else {
          showToast('‚ùå Failed to save settings');
        }
      } catch (e) {
        showToast('‚ùå Error saving settings');
      }
    }

    // =====================
    // PREDICT DEPARTMENT
    // =====================
    
    // Confirm Modal functions
    let pendingCancelOrderId = null;
    
    function showConfirmModal(orderId, orderInfo) {
      pendingCancelOrderId = orderId;
      document.getElementById('confirm-modal-order-info').innerHTML = orderInfo;
      document.getElementById('confirm-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }
    
    function closeConfirmModal() {
      pendingCancelOrderId = null;
      document.getElementById('confirm-modal').classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // Cancel Order function
    function cancelOrder(orderId, price, size) {
      const orderInfo = `<span class="text-green-600">BUY</span> ${size} shares @ ${price}%`;
      showConfirmModal(orderId, orderInfo);
    }
    
    async function executeCancelOrder() {
      if (!pendingCancelOrderId) return;
      
      const orderId = pendingCancelOrderId;
      closeConfirmModal();
      
      showToast('Canceling order...');
      try {
        const res = await fetch('/api/predict/orders/cancel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId })
        });
        const data = await res.json();
        
        if (data.success) {
          showToast('‚úÖ Order canceled!', 'success');
          setTimeout(() => refreshPredict(), 1000);
        } else {
          showToast('‚ùå ' + (data.error || 'Failed'), 'error');
        }
      } catch (e) {
        showToast('‚ùå Error: ' + e.message, 'error');
      }
    }
    
    // Attach action to modal button
    document.addEventListener('DOMContentLoaded', () => {
      const actionBtn = document.getElementById('confirm-modal-action');
      if (actionBtn) actionBtn.onclick = executeCancelOrder;
    });
    
    async function refreshPredict() {
      showToast('Loading Polymarket data...');
      try {
        // Fetch overview
        const overviewRes = await fetch('/api/predict/overview');
        const overview = await overviewRes.json();
        
        document.getElementById('predict-balance').textContent = '$' + (overview.balance || 0).toFixed(2);
        document.getElementById('predict-invested').textContent = '$' + (overview.totalInvested || 0).toFixed(2);
        // Open count will be updated after positions fetch
        document.getElementById('predict-trades').textContent = overview.totalTrades || 0;
        document.getElementById('predict-wins').textContent = overview.wins || 0;
        document.getElementById('predict-losses').textContent = overview.losses || 0;
        
        // Realized PnL
        const realizedPnL = overview.realizedPnL || 0;
        const realizedEl = document.getElementById('predict-realized-pnl');
        realizedEl.textContent = (realizedPnL >= 0 ? '+' : '') + '$' + realizedPnL.toFixed(2);
        realizedEl.className = 'text-xl font-bold ' + (realizedPnL >= 0 ? 'text-emerald-600' : 'text-red-500');
        
        // Realized PnL percentage (based on invested)
        const totalInvested = overview.totalInvested || 1;
        const realizedPct = (realizedPnL / totalInvested * 100).toFixed(1);
        const realizedPctEl = document.getElementById('predict-realized-pct');
        realizedPctEl.textContent = '(' + (realizedPct >= 0 ? '+' : '') + realizedPct + '%)';
        realizedPctEl.className = 'font-semibold ' + (realizedPnL >= 0 ? 'text-emerald-600' : 'text-red-500');
        
        const netPnL = overview.netPnL || 0;
        const pnlEl = document.getElementById('predict-pnl');
        pnlEl.textContent = (netPnL >= 0 ? '+' : '') + '$' + netPnL.toFixed(2);
        pnlEl.className = 'text-xl font-bold ' + (netPnL >= 0 ? 'text-emerald-600' : 'text-red-500');
        
        // Show PnL percentage
        const pnlPct = overview.pnlPercent || 0;
        const pnlPctEl = document.getElementById('predict-pnl-pct');
        pnlPctEl.textContent = '(' + (pnlPct >= 0 ? '+' : '') + pnlPct + '%)';
        pnlPctEl.className = 'font-semibold ' + (pnlPct >= 0 ? 'text-emerald-600' : 'text-red-500');
        
        document.getElementById('predict-winrate').textContent = (overview.winRate || 0) + '%';
        
        // Bot status
        const botRes = await fetch('/api/predict/bot');
        const bot = await botRes.json();
        const statusEl = document.getElementById('predict-bot-status');
        statusEl.textContent = bot.status === 'online' ? 'üü¢ Online' : 'üî¥ Offline';
        statusEl.className = 'px-2 py-1 rounded text-xs ' + 
          (bot.status === 'online' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700');
        
        // Positions
        const posRes = await fetch('/api/predict/positions');
        const posData = await posRes.json();
        const positionsEl = document.getElementById('predict-positions-list');
        
        // Update Open count from actual positions
        document.getElementById('predict-positions').textContent = posData.positions?.length || 0;
        
        if (posData.positions?.length) {
          positionsEl.innerHTML = `<div class="grid grid-cols-5 gap-2">` + posData.positions.map(p => {
            const pnlValue = p.unrealizedPnL || 0;
            const pnlPercent = p.percentPnL || 0;
            const invested = p.betSize || (p.size * p.entryPrice) || 0;
            const isPositive = pnlValue >= 0;
            const polyUrl = p.eventSlug ? `https://polymarket.com/event/${p.eventSlug}` : null;
            
            // Format end date
            let endDateStr = '';
            let isExpired = false;
            let isToday = false;
            if (p.endDate) {
              const end = new Date(p.endDate);
              const now = new Date();
              const diffDays = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
              isExpired = diffDays < 0;
              isToday = diffDays === 0;
              if (isExpired) {
                endDateStr = '‚è∞ Ended';
              } else if (isToday) {
                endDateStr = 'üî• Today';
              } else if (diffDays === 1) {
                endDateStr = '‚è≥ Tomorrow';
              } else if (diffDays <= 7) {
                endDateStr = 'üìÖ ' + diffDays + 'd';
              } else {
                endDateStr = 'üìÖ ' + end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
              }
            }
            
            return `
            <div class="bg-white rounded-lg p-2 border ${isPositive ? 'border-green-200' : 'border-red-200'} hover:shadow-md transition-shadow ${polyUrl ? 'cursor-pointer hover:border-indigo-400' : ''}" 
                 ${polyUrl ? `onclick="window.open('${polyUrl}', '_blank')" title="Click to view on Polymarket"` : ''}>
              <div class="flex items-center justify-between mb-1">
                <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${p.side === 'Yes' || p.side === 'YES' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'}">
                  ${p.side || 'YES'}
                </span>
                <span class="text-[10px] font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                  ${isPositive ? '+' : ''}${pnlPercent.toFixed(0)}%
                </span>
              </div>
              <div class="text-[10px] text-gray-700 font-medium truncate" title="${p.market}">${(p.market || 'Unknown').substring(0, 25)}${(p.market || '').length > 25 ? '...' : ''}</div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-[9px] text-gray-500">$${invested.toFixed(2)}</span>
                <span class="text-[10px] font-bold ${isPositive ? 'text-green-600' : 'text-red-600'}">
                  ${isPositive ? '+' : '-'}$${Math.abs(pnlValue).toFixed(2)}
                </span>
              </div>
              ${endDateStr ? `<div class="text-[9px] ${isExpired ? 'text-red-500' : isToday ? 'text-orange-500' : 'text-gray-400'} text-center mt-1">${endDateStr}</div>` : ''}
            </div>
          `}).join('') + `</div>`;
        } else {
          positionsEl.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">No active positions</div>';
        }
        
        // Separate pending orders from filled trades
        const filledMarkets = (posData.positions || []).map(p => (p.market || '').toLowerCase());
        const allTrades = overview.recentTrades || [];
        
        // Helper: normalize text (remove accents, special chars, lowercase)
        const normalize = (s) => {
          return (s || '').toLowerCase()
            .replace(/√°/g, 'a').replace(/√©/g, 'e').replace(/√≠/g, 'i').replace(/√≥/g, 'o').replace(/√∫/g, 'u')
            .replace(/[^a-z0-9\s]/g, '');
        };
        
        // Helper: check if two market names refer to the same market
        const isSameMarket = (tradeMarket, posMarket) => {
          const t = normalize(tradeMarket);
          const p = normalize(posMarket);
          // Extract key words and check overlap
          const tWords = t.split(/\s+/).filter(w => w.length > 3);
          const pWords = p.split(/\s+/).filter(w => w.length > 3);
          const commonWords = tWords.filter(w => pWords.some(pw => pw.includes(w) || w.includes(pw)));
          // Same market if 2+ key words match
          return commonWords.length >= 2;
        };
        
        // Pending = OPEN status AND not matching any filled position
        // Filled trades = CLOSED only (positions are shown separately)
        const filledTrades = allTrades.filter(t => t.status === 'CLOSED' || t.status === 'PENDING_RESOLUTION');
        
        // Fetch REAL open orders from CLOB API
        let clobOrders = [];
        try {
          const ordersRes = await fetch('/api/predict/orders');
          const ordersData = await ordersRes.json();
          clobOrders = ordersData.orders || [];
        } catch (e) {
          console.error('Failed to fetch CLOB orders:', e);
        }
        
        // Update Pending count
        document.getElementById('predict-pending').textContent = clobOrders.length;
        
        // Pending Limit Orders section - NOW FROM CLOB API
        const pendingEl = document.getElementById('predict-pending-list');
        const pendingSection = document.getElementById('predict-pending-section');
        if (clobOrders.length > 0) {
          pendingSection.style.display = 'block';
          pendingEl.innerHTML = `<div class="grid grid-cols-5 gap-2">` + clobOrders.map(o => {
            const pricePct = ((o.price || 0) * 100).toFixed(0);
            const cost = (o.size * o.price).toFixed(2);
            const filledPct = o.size > 0 ? ((o.filled / o.size) * 100).toFixed(0) : 0;
            return `
            <div class="bg-yellow-50 rounded-lg p-2 border border-yellow-300 hover:shadow-md transition-shadow relative group">
              <div class="flex items-center justify-between mb-1">
                <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${o.side === 'BUY' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                  ${o.side}
                </span>
                <span class="text-[10px]">‚è≥ ${o.status}</span>
              </div>
              <div class="text-[10px] text-gray-700 font-medium truncate" title="Order ID: ${o.id}">NE First Score</div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-[9px] text-gray-500">$${cost} (${o.size} sh)</span>
                <span class="text-[10px] text-yellow-700">@ ${pricePct}%</span>
              </div>
              <div class="text-[8px] text-gray-400 mt-1">Filled: ${filledPct}%</div>
              <button onclick="cancelOrder('${o.id}', '${pricePct}', '${o.size}')" 
                      class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 hover:bg-red-600 text-white text-[9px] px-1.5 py-0.5 rounded">
                ‚úï Cancel
              </button>
            </div>
          `}).join('') + `</div>`;
        } else {
          pendingSection.style.display = 'none';
        }
        
        // Recent trades - only filled/closed with invested ‚Üí PnL
        const tradesEl = document.getElementById('predict-trades-list');
        if (filledTrades.length > 0) {
          tradesEl.innerHTML = `<div class="grid grid-cols-5 gap-2">` + filledTrades.map(t => {
            const pnlValue = t.pnl || 0;
            const invested = t.amount || 0;
            const isWin = pnlValue >= 0;
            const isLoss = pnlValue < 0;
            const isClosed = t.status === 'CLOSED';
            const statusIcon = isClosed ? (isWin ? '‚úÖ' : '‚ùå') : '‚è≥';
            const polyUrl = t.eventSlug ? `https://polymarket.com/event/${t.eventSlug}` : null;
            return `
            <div class="bg-white rounded-lg p-2 border ${isLoss ? 'border-red-200' : isWin ? 'border-green-200' : 'border-gray-200'} hover:shadow-md transition-shadow ${polyUrl ? 'cursor-pointer hover:border-indigo-400' : ''}"
                 ${polyUrl ? `onclick="window.open('${polyUrl}', '_blank')" title="Click to view on Polymarket"` : ''}>
              <div class="flex items-center justify-between mb-1">
                <span class="px-1.5 py-0.5 rounded text-[10px] font-medium ${t.side === 'YES' || t.side === 'UP' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                  ${t.side}
                </span>
                <span class="text-[10px]">${statusIcon}</span>
              </div>
              <div class="text-[10px] text-gray-700 font-medium truncate" title="${t.market}">${(t.market || 'Unknown').substring(0, 20)}${(t.market || '').length > 20 ? '...' : ''}</div>
              <div class="flex justify-between items-center mt-1">
                <span class="text-[9px] text-gray-500">$${invested.toFixed(2)}</span>
                <span class="text-[10px] font-bold ${isLoss ? 'text-red-600' : 'text-green-600'}">
                  ${isClosed ? (isLoss ? '-' : '+') : ''}$${Math.abs(pnlValue).toFixed(2)}
                </span>
              </div>
            </div>
          `}).join('') + `</div>`;
        } else {
          tradesEl.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">No filled trades yet</div>';
        }
        
        // Hide Hot Markets section
        const marketsEl = document.getElementById('predict-markets-list');
        if (marketsEl && marketsEl.parentElement) {
          marketsEl.parentElement.style.display = 'none';
        }
        
        // Load opportunities
        loadOpportunities();
        
        showToast('Polymarket data loaded!');
      } catch (e) {
        console.error('Predict error:', e);
        showToast('Error loading data');
      }
    }
    
    // Load opportunities from all 6 strategies
    async function loadOpportunities() {
      try {
        const res = await fetch('/api/predict/opportunities');
        const data = await res.json();
        const opps = data.opportunities || [];
        
        document.getElementById('opp-count').textContent = opps.length;
        
        const el = document.getElementById('opportunity-list');
        if (opps.length === 0) {
          el.innerHTML = '<div class="col-span-5 text-xs text-gray-400 text-center py-4">No opportunities detected</div>';
          return;
        }
        
        const strategyColors = {
          'A': { bg: 'bg-red-50', border: 'border-red-200', badge: 'bg-red-100 text-red-700' },
          'B': { bg: 'bg-orange-50', border: 'border-orange-200', badge: 'bg-orange-100 text-orange-700' },
          'C': { bg: 'bg-yellow-50', border: 'border-yellow-200', badge: 'bg-yellow-100 text-yellow-700' },
          'D': { bg: 'bg-green-50', border: 'border-green-200', badge: 'bg-green-100 text-green-700' },
          'E': { bg: 'bg-blue-50', border: 'border-blue-200', badge: 'bg-blue-100 text-blue-700' },
          'F': { bg: 'bg-purple-50', border: 'border-purple-200', badge: 'bg-purple-100 text-purple-700' },
          '?': { bg: 'bg-gray-50', border: 'border-gray-200', badge: 'bg-gray-100 text-gray-700' }
        };
        
        el.innerHTML = opps.map(opp => {
          const colors = strategyColors[opp.strategy] || strategyColors['?'];
          const confColor = opp.confidence >= 85 ? 'text-green-600' : 
                           opp.confidence >= 70 ? 'text-yellow-600' : 
                           'text-gray-500';
          const confBg = opp.confidence >= 85 ? 'bg-green-100' : 
                        opp.confidence >= 70 ? 'bg-yellow-100' : 
                        'bg-gray-100';
          
          // Build Polymarket URL - direct link if slug available, otherwise category
          let polyUrl;
          let tooltip;
          
          if (opp.slug && opp.slug.length > 0) {
            // Direct link to specific market
            polyUrl = `https://polymarket.com/event/${opp.slug}`;
            tooltip = opp.question ? opp.question.slice(0, 60) : 'Click to open market';
          } else {
            // Fallback to category search
            const marketUrls = {
              'BTC': 'https://polymarket.com/markets?_c=crypto&_q=bitcoin&_p=Daily',
              'ETH': 'https://polymarket.com/markets?_c=crypto&_q=ethereum&_p=Daily',
              'SOL': 'https://polymarket.com/markets?_c=crypto&_q=solana&_p=Daily',
              'SPX': 'https://polymarket.com/markets?_c=crypto&_q=s%26p&_p=Daily',
              'Crypto': 'https://polymarket.com/markets?_c=crypto&_p=Daily',
              'NFL': 'https://polymarket.com/markets?_c=sports&_q=nfl',
              'NBA': 'https://polymarket.com/markets?_c=sports&_q=nba',
              'NHL': 'https://polymarket.com/markets?_c=sports&_q=nhl',
              'MLB': 'https://polymarket.com/markets?_c=sports&_q=mlb',
              'SUPER BOWL': 'https://polymarket.com/markets?_c=sports&_q=super%20bowl',
              'Weather': 'https://polymarket.com/markets?_q=weather'
            };
            polyUrl = marketUrls[opp.market] || 'https://polymarket.com/markets';
            tooltip = opp.market === 'BTC' ? 'BTC Daily markets' :
                     opp.market === 'ETH' ? 'ETH Daily markets' :
                     opp.market === 'SOL' ? 'SOL Daily markets' :
                     'View on Polymarket';
          }
          
          return `
            <div class="${colors.bg} rounded-lg p-2 border ${colors.border} hover:shadow-md hover:border-indigo-400 transition-all cursor-pointer"
                 onclick="window.open('${polyUrl}', '_blank')" title="${tooltip}">
              <div class="flex items-center justify-between mb-1">
                <span class="px-1.5 py-0.5 rounded text-[10px] font-bold ${colors.badge}">${opp.strategy}</span>
                <span class="px-1.5 py-0.5 rounded text-[10px] font-semibold ${confBg} ${confColor}">${opp.confidence}%</span>
              </div>
              <div class="text-[10px] font-semibold text-gray-800 truncate" title="${opp.type}: ${opp.detail}">${opp.type}</div>
              <div class="text-[9px] text-gray-500 truncate" title="${opp.detail}">${opp.detail}</div>
              <div class="flex items-center justify-between mt-1">
                <span class="text-[8px] text-gray-400">${opp.name}</span>
                <span class="px-1 py-0.5 bg-white/50 rounded text-[8px] font-medium text-gray-600">${opp.market || '‚Äî'}</span>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Opportunities error:', e);
        document.getElementById('opportunity-list').innerHTML = 
          '<div class="col-span-5 text-xs text-red-400 text-center py-4">Error loading opportunities</div>';
      }
    }

    // Init
    fetchAgents();
    fetchBots();
    fetchSystem();
    setInterval(fetchBots, 10000);
    setInterval(fetchSystem, 30000);
  </script>
<!-- Custom Confirm Modal -->
<div id="confirm-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeConfirmModal()"></div>
  
  <!-- Modal -->
  <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl p-6 w-96 max-w-[90vw]">
    <div class="text-center">
      <!-- Icon -->
      <div class="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
        <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      </div>
      
      <!-- Title -->
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Cancel Order?</h3>
      
      <!-- Message -->
      <p id="confirm-modal-message" class="text-sm text-gray-600 mb-6">Are you sure you want to cancel this order?</p>
      
      <!-- Order Details -->
      <div id="confirm-modal-details" class="bg-gray-50 rounded-lg p-3 mb-6 text-left">
        <div class="text-xs text-gray-500">Order Details</div>
        <div id="confirm-modal-order-info" class="text-sm font-medium text-gray-800 mt-1"></div>
      </div>
      
      <!-- Buttons -->
      <div class="flex gap-3">
        <button onclick="closeConfirmModal()" 
                class="flex-1 px-4 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-colors">
          Keep Order
        </button>
        <button id="confirm-modal-action" 
                class="flex-1 px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white font-medium rounded-xl transition-colors">
          Cancel Order
        </button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
