#!/bin/bash
# Rename Telegram forum topic (with optional icon)
# é‡å‘½å Telegram è®ºå›è¯é¢˜ï¼ˆå¯é€‰æ›´æ¢å›¾æ ‡ï¼‰
#
# Usage / ç”¨æ³•:
#   ./rename-topic.sh <chat_id> <thread_id> <new_name> [icon]
#   ./rename-topic.sh --icons  # Show available icons / æ˜¾ç¤ºå¯ç”¨å›¾æ ‡
#
# Icon can be / å›¾æ ‡å¯ä»¥æ˜¯:
#   - Emoji (from the map below / ä¸‹é¢çš„æ˜ å°„è¡¨)
#   - Full custom_emoji_id (19-digit number / 19ä½æ•°å­—)
#   - Omitted to keep current icon / çœç•¥åˆ™ä¿æŒå½“å‰å›¾æ ‡
#
# Requires / éœ€è¦: TELEGRAM_BOT_TOKEN environment variable
#
# Data source: Telegram Bot API getForumTopicIconStickers (2026-02-07)

# Get token from environment
BOT_TOKEN="${TELEGRAM_BOT_TOKEN:-}"

if [ -z "$BOT_TOKEN" ] && [ "$1" != "--icons" ]; then
  echo "Error: TELEGRAM_BOT_TOKEN not set"
  echo "é”™è¯¯ï¼šæœªè®¾ç½® TELEGRAM_BOT_TOKEN"
  echo ""
  echo "Set it in your environment or OpenClaw config:"
  echo "åœ¨ç¯å¢ƒå˜é‡æˆ– OpenClaw é…ç½®ä¸­è®¾ç½®ï¼š"
  echo "  export TELEGRAM_BOT_TOKEN=\"your-bot-token\""
  exit 1
fi

# Hardcoded emoji â†’ ID mapping (112 icons, verified from API)
declare -A ICON_MAP=(
  ["ğŸ“°"]="5434144690511290129"
  ["ğŸ’¡"]="5312536423851630001"
  ["âš¡ï¸"]="5312016608254762256"
  ["ğŸ™"]="5377544228505134960"
  ["ğŸ”"]="5418085807791545980"
  ["ğŸ—£"]="5370870893004203704"
  ["ğŸ†’"]="5420216386448270341"
  ["â—ï¸"]="5379748062124056162"
  ["ğŸ“"]="5373251851074415873"
  ["ğŸ“†"]="5433614043006903194"
  ["ğŸ“"]="5357315181649076022"
  ["ğŸ”"]="5309965701241379366"
  ["ğŸ“£"]="5309984423003823246"
  ["ğŸ”¥"]="5312241539987020022"
  ["â¤ï¸"]="5312138559556164615"
  ["â“"]="5377316857231450742"
  ["ğŸ“ˆ"]="5350305691942788490"
  ["ğŸ“‰"]="5350713563512052787"
  ["ğŸ’"]="5309958691854754293"
  ["ğŸ’°"]="5350452584119279096"
  ["ğŸ’¸"]="5309929258443874898"
  ["ğŸª™"]="5377690785674175481"
  ["ğŸ’±"]="5310107765874632305"
  ["â‰ï¸"]="5377438129928020693"
  ["ğŸ®"]="5309950797704865693"
  ["ğŸ’»"]="5350554349074391003"
  ["ğŸ“±"]="5409357944619802453"
  ["ğŸš—"]="5312322066328853156"
  ["ğŸ "]="5312486108309757006"
  ["ğŸ’˜"]="5310029292527164639"
  ["ğŸ‰"]="5310228579009699834"
  ["â€¼ï¸"]="5377498341074542641"
  ["ğŸ†"]="5312315739842026755"
  ["ğŸ"]="5408906741125490282"
  ["ğŸ¬"]="5368653135101310687"
  ["ğŸµ"]="5310045076531978942"
  ["ğŸ”"]="5420331611830886484"
  ["ğŸ“š"]="5350481781306958339"
  ["ğŸ‘‘"]="5357107601584693888"
  ["âš½ï¸"]="5375159220280762629"
  ["ğŸ€"]="5384327463629233871"
  ["ğŸ“º"]="5350513667144163474"
  ["ğŸ‘€"]="5357121491508928442"
  ["ğŸ«¦"]="5357185426392096577"
  ["ğŸ“"]="5310157398516703416"
  ["ğŸ’„"]="5310262535021142850"
  ["ğŸ‘ "]="5368741306484925109"
  ["âœˆï¸"]="5348436127038579546"
  ["ğŸ§³"]="5357120306097956843"
  ["ğŸ–"]="5310303848311562896"
  ["â›…ï¸"]="5350424168615649565"
  ["ğŸ¦„"]="5413625003218313783"
  ["ğŸ›"]="5350699789551935589"
  ["ğŸ‘œ"]="5377478880577724584"
  ["ğŸ›’"]="5431492767249342908"
  ["ğŸš‚"]="5350497316203668441"
  ["ğŸ›¥"]="5350422527938141909"
  ["ğŸ”"]="5418196338774907917"
  ["ğŸ•"]="5350648297189023928"
  ["ğŸ¤–"]="5309832892262654231"
  ["ğŸª©"]="5350751634102166060"
  ["ğŸŸ"]="5377624166436445368"
  ["ğŸ´â€â˜ ï¸"]="5386395194029515402"
  ["ğŸ—³"]="5350387571199319521"
  ["ğŸ“"]="5357419403325481346"
  ["ğŸ”­"]="5368585403467048206"
  ["ğŸ”¬"]="5377580546748588396"
  ["ğŸ¶"]="5377317729109811382"
  ["ğŸ¤"]="5382003830487523366"
  ["ğŸ•º"]="5357298525765902091"
  ["ğŸ’ƒ"]="5357370526597653193"
  ["ğŸª–"]="5357188789351490453"
  ["ğŸ’¼"]="5348227245599105972"
  ["ğŸ§ª"]="5411138633765757782"
  ["ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"]="5386435923204382258"
  ["ğŸ‘¶"]="5377675010259297233"
  ["ğŸ¤°"]="5386609083400856174"
  ["ğŸ’…"]="5368808634392257474"
  ["ğŸ›"]="5350548830041415279"
  ["ğŸ§®"]="5355127101970194557"
  ["ğŸ–¨"]="5386379624773066504"
  ["ğŸ‘®â€â™‚ï¸"]="5377494501373780436"
  ["ğŸ©º"]="5350307998340226571"
  ["ğŸ’Š"]="5310094636159607472"
  ["ğŸ’‰"]="5310139157790596888"
  ["ğŸ§¼"]="5377468357907849200"
  ["ğŸªª"]="5418115271267197333"
  ["ğŸ›ƒ"]="5372819184658949787"
  ["ğŸ½"]="5350344462612570293"
  ["ğŸŸ"]="5384574037701696503"
  ["ğŸ¨"]="5310039132297242441"
  ["ğŸ­"]="5350658016700013471"
  ["ğŸ©"]="5357504778685392027"
  ["ğŸ”®"]="5350367161514732241"
  ["ğŸ¹"]="5350520238444126134"
  ["ğŸ‚"]="5310132165583840589"
  ["â˜•ï¸"]="5350392020785437399"
  ["ğŸ£"]="5350406176997646350"
  ["ğŸ”"]="5350403544182694064"
  ["ğŸ•"]="5350444672789519765"
  ["ğŸ¦ "]="5312424913615723286"
  ["ğŸ’¬"]="5417915203100613993"
  ["ğŸ„"]="5312054580060625569"
  ["ğŸƒ"]="5309744892677727325"
  ["âœï¸"]="5238156910363950406"
  ["â­ï¸"]="5235579393115438657"
  ["âœ…"]="5237699328843200968"
  ["ğŸ–"]="5238027455754680851"
  ["ğŸ¤¡"]="5238234236955148254"
  ["ğŸ§ "]="5237889595894414384"
  ["ğŸ¦®"]="5237999392438371490"
  ["ğŸˆ"]="5235912661102773458"
)

show_icons() {
  echo "Available icons (112) / å¯ç”¨å›¾æ ‡ (112ä¸ª):"
  echo ""
  echo "ã€News/Status æ–°é—»/çŠ¶æ€ã€‘ğŸ“° ğŸ“£ â—ï¸ â€¼ï¸ â‰ï¸ â“ ğŸ” ğŸ†’ ğŸ” â­ï¸ âœ…"
  echo "ã€Energy/Weather èƒ½é‡/å¤©æ°”ã€‘ğŸ”¥ âš¡ï¸ â›…ï¸ ğŸ”"
  echo "ã€Ideas åˆ›æ„/æƒ³æ³•ã€‘ğŸ’¡ ğŸ”® ğŸ¨"
  echo "ã€Work/Office å·¥ä½œ/åŠå…¬ã€‘ğŸ“ ğŸ“† ğŸ“ ğŸ” ğŸ“ˆ ğŸ“‰ ğŸ’¼ ğŸ–¨ âœï¸"
  echo "ã€Tech/Code ç§‘æŠ€/ç¼–ç¨‹ã€‘ğŸ’» ğŸ“± ğŸ¤– ğŸ§  ğŸ§®"
  echo "ã€Science ç§‘å­¦/ç ”ç©¶ã€‘ğŸ”¬ ğŸ”­ ğŸ§ª ğŸ¦ "
  echo "ã€Education å­¦ä¹ /æ•™è‚²ã€‘ğŸ“š ğŸ“"
  echo "ã€Communication æ²Ÿé€š/ç¤¾äº¤ã€‘ğŸ’¬ ğŸ—£ ğŸ™ ğŸ¤"
  echo "ã€Finance/Shopping é‡‘è/è´­ç‰©ã€‘ğŸ’° ğŸ’¸ ğŸª™ ğŸ’± ğŸ’ ğŸ›’ ğŸ› ğŸ‘œ ğŸ‘ "
  echo "ã€Entertainment å¨±ä¹/æ¸¸æˆã€‘ğŸ® ğŸ¬ ğŸµ ğŸ¶ ğŸ“º ğŸ­ ğŸª© ğŸŸ"
  echo "ã€Sports è¿åŠ¨ã€‘âš½ï¸ ğŸ€ ğŸ ğŸ’ƒ ğŸ•º"
  echo "ã€Travel æ—…è¡Œ/äº¤é€šã€‘âœˆï¸ ğŸš— ğŸš‚ ğŸ›¥ ğŸ§³ ğŸ›ƒ ğŸ– ğŸ•"
  echo "ã€Family/Life å®¶åº­/ç”Ÿæ´»ã€‘ğŸ  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ğŸ‘¶ ğŸ¤°"
  echo "ã€Emotions æƒ…æ„Ÿã€‘â¤ï¸ ğŸ’˜"
  echo "ã€Food/Drinks é£Ÿç‰©/é¥®æ–™ã€‘â˜•ï¸ ğŸ” ğŸ• ğŸ£ ğŸ¹ ğŸ½ ğŸ“ ğŸ‚"
  echo "ã€Health å¥åº·/åŒ»ç–—ã€‘ğŸ©º ğŸ’Š ğŸ’‰ ğŸ§¼"
  echo "ã€Celebration èŠ‚æ—¥/åº†ç¥ã€‘ğŸ‰ ğŸ† ğŸ– ğŸ„ ğŸƒ"
  echo "ã€Characters äººç‰©/è§’è‰²ã€‘ğŸ‘‘ ğŸ‘€ ğŸ© ğŸ¤¡ ğŸ‘®â€â™‚ï¸ ğŸ´â€â˜ ï¸ ğŸª–"
  echo "ã€Animals åŠ¨ç‰©ã€‘ğŸˆ ğŸŸ ğŸ¦„ ğŸ¦®"
  echo "ã€Beauty ç¾å®¹ã€‘ğŸ’„ ğŸ’… ğŸ«¦"
  echo "ã€Other å…¶ä»–ã€‘ğŸ› ğŸ—³ ğŸªª"
}

# Check for --icons flag
if [ "$1" == "--icons" ]; then
  show_icons
  exit 0
fi

CHAT_ID="$1"
THREAD_ID="$2"
NAME="$3"
ICON="$4"

if [ -z "$CHAT_ID" ] || [ -z "$THREAD_ID" ] || [ -z "$NAME" ]; then
  echo "Usage / ç”¨æ³•: $0 <chat_id> <thread_id> <new_name> [icon]"
  echo "              $0 --icons  # Show available icons / æ˜¾ç¤ºå¯ç”¨å›¾æ ‡"
  echo ""
  echo "Examples / ç¤ºä¾‹:"
  echo "  $0 288536750 145417 'Test Topic' ğŸ’»"
  echo "  $0 288536750 145417 'æµ‹è¯•è¯é¢˜' 5350554349074391003"
  exit 1
fi

# Check name length
CHAR_COUNT=$(echo -n "$NAME" | wc -m)
if [ "$CHAR_COUNT" -gt 10 ]; then
  echo "Warning: Name is $CHAR_COUNT chars, exceeds 10 char limit"
  echo "è­¦å‘Šï¼šåç§° $CHAR_COUNT å­—ç¬¦ï¼Œè¶…è¿‡ 10 å­—ç¬¦é™åˆ¶"
fi

# Build curl arguments
CURL_ARGS=(-s "https://api.telegram.org/bot${BOT_TOKEN}/editForumTopic")
CURL_ARGS+=(-d "chat_id=${CHAT_ID}")
CURL_ARGS+=(-d "message_thread_id=${THREAD_ID}")
CURL_ARGS+=(--data-urlencode "name=${NAME}")

# Add icon if provided
if [ -n "$ICON" ]; then
  # Check if it's a 19-digit ID
  if [[ "$ICON" =~ ^[0-9]{19}$ ]]; then
    ICON_ID="$ICON"
  elif [ -n "${ICON_MAP[$ICON]}" ]; then
    ICON_ID="${ICON_MAP[$ICON]}"
  else
    echo "Warning: Icon '$ICON' not found, skipping icon change"
    echo "è­¦å‘Šï¼šå›¾æ ‡ '$ICON' æœªæ‰¾åˆ°ï¼Œè·³è¿‡å›¾æ ‡æ›´æ¢"
    ICON_ID=""
  fi
  
  if [ -n "$ICON_ID" ]; then
    CURL_ARGS+=(-d "icon_custom_emoji_id=${ICON_ID}")
    echo "Using icon ID / ä½¿ç”¨å›¾æ ‡ ID: $ICON_ID"
  fi
fi

# Execute
curl "${CURL_ARGS[@]}" | jq .
